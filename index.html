<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripts Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
    background: #f5f5f5;
    display: flex;
    height: 100vh;
    width: 100vw;
    margin: 0;
    padding: 0;
    overflow: hidden;
}

/* ============================================
   SISTEMA DE SIDEBAR RESPONSIVA CON HAMBURGUESA
   ============================================ */

/* Botón Hamburguesa */
.hamburger-btn {
    display: none;
    position: fixed;
    top: 16px;
    left: 16px;
    z-index: 1001;
    width: 48px;
    height: 48px;
    background: white;
    border: 1.5px solid #e5e5e5;
    border-radius: 12px;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.hamburger-btn:hover {
    background: #f5f5f5;
    transform: scale(1.05);
}

.hamburger-btn:active {
    transform: scale(0.95);
}

/* Overlay para cerrar sidebar */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.sidebar-overlay.active {
    display: block;
    opacity: 1;
}

/* Sidebar */
.sidebar {
    width: 260px;
    background: white;
    border-right: 1px solid #e5e5e5;
    display: flex;
    flex-direction: column;
    padding: 20px 14px;
    overflow-y: auto;
    transition: transform 0.3s ease;
    position: relative;
}

/* Botón cerrar sidebar (solo móviles) */
.sidebar-close-btn {
    display: none;
    position: absolute;
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
    background: #f5f5f5;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    color: #525252;
    transition: all 0.2s;
    z-index: 10;
}

.sidebar-close-btn:hover {
    background: #e5e5e5;
    transform: rotate(90deg);
}

.sidebar-header {
    margin-bottom: 32px;
}

.sidebar-header h1 {
    font-size: 20px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.sidebar-subtitle {
    font-size: 13px;
    color: #737373;
}

.stats-section {
    margin-bottom: 32px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    margin-bottom: 4px;
    border-radius: 8px;
    font-size: 14px;
    color: #525252;
}

.stat-number {
    font-weight: 700;
    color: #1a1a1a;
    font-size: 16px;
}

.categories-section h3 {
    font-size: 11px;
    font-weight: 700;
    color: #737373;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.add-category-btn {
    background: none;
    border: none;
    color: #737373;
    cursor: pointer;
    font-size: 16px;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}

.add-category-btn:hover {
    background: #f5f5f5;
}

.category-input {
    display: none;
    margin-bottom: 12px;
}

.category-input.active {
    display: flex;
    gap: 8px;
}

.category-input input {
    flex: 1;
    padding: 8px 10px;
    border: 1.5px solid #e5e5e5;
    border-radius: 6px;
    font-size: 13px;
}

.category-input input:focus {
    outline: none;
    border-color: #2563eb;
}

.category-input button {
    padding: 8px 12px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
}

.category-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.category-item {
    padding: 10px 12px;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #525252;
}

.category-item:hover {
    background: #f5f5f5;
}

.category-item.active {
    background: #2563eb;
    color: white;
}

.category-badge {
    font-size: 12px;
    font-weight: 600;
    color: #737373;
}

.category-item.active .category-badge {
    color: rgba(255, 255, 255, 0.8);
}

.category-icon {
    margin-right: 8px;
}

/* Buscador de categorías */
.category-search-container {
    position: relative;
    margin-bottom: 12px;
}

.category-search-input {
    width: 100%;
    padding: 8px 10px 8px 32px;
    border: 1.5px solid #e5e5e5;
    border-radius: 6px;
    font-size: 12px;
    background: #fafafa;
    transition: all 0.15s;
}

.category-search-input:focus {
    outline: none;
    border-color: #2563eb;
    background: white;
}

.category-search-input::placeholder {
    color: #a3a3a3;
}

.category-search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #a3a3a3;
    pointer-events: none;
}

.category-search-clear {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #737373;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.15s;
}

.category-search-clear:hover {
    background: #e5e5e5;
    color: #1a1a1a;
}

.category-item.hidden {
    display: none;
}

.category-no-results {
    padding: 16px 12px;
    text-align: center;
    color: #a3a3a3;
    font-size: 12px;
}

/* Scrollbar personalizado para sidebar */
.sidebar::-webkit-scrollbar {
    width: 6px;
}

.sidebar::-webkit-scrollbar-track {
    background: #f5f5f5;
}

.sidebar::-webkit-scrollbar-thumb {
    background: #d4d4d4;
    border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
    background: #a3a3a3;
}

        /* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    width: 100%;
    height: 100vh;
    margin: 0;
    padding: 0;
}
.main-header {
    background: white;
    padding: 12px 20px;
    border-bottom: 1px solid #e5e5e5;
    width: 100%;
    margin: 0;
    box-sizing: border-box;
}

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-top h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .header-subtitle {
            font-size: 14px;
            color: #737373;
        }

        .btn-new-script {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .btn-new-script:hover {
            background: #1d4ed8;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 14px 10px 38px;
            border: 1.5px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            background: #fafafa;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a3a3a3;
        }

        /* Sistema de Filtros */
        .filters-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding: 8px 0;
        }

        .toggle-filters-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f5f5f5;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #525252;
            transition: all 0.2s;
        }

        .toggle-filters-btn:hover {
            background: #e5e5e5;
        }

        .toggle-filters-btn.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .toggle-filters-btn svg {
            transition: transform 0.2s;
        }

        .toggle-filters-btn.active svg {
            transform: rotate(180deg);
        }

        .filters-panel {
            display: none;
            gap: 12px;
            padding: 16px;
            background: #fafafa;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            margin-top: 12px;
            animation: slideDown 0.3s ease-out;
        }

        .filters-panel.active {
            display: flex;
            flex-wrap: wrap;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            font-size: 11px;
            font-weight: 700;
            color: #737373;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-option {
            padding: 8px 14px;
            background: white;
            border: 1.5px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #525252;
            transition: all 0.15s;
            font-weight: 500;
        }

        .filter-option:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .filter-option.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
            font-weight: 600;
        }

        .filter-divider {
            width: 1px;
            background: #e5e5e5;
            margin: 0 8px;
        }

        .active-filters-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: #2563eb;
            color: white;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 4px;
        }

        /* Botones de acción rápida */
.quick-action-buttons {
    display: flex;
    gap: 8px;
    margin-left: auto;
}

.btn-quick-action {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1.5px solid #e5e5e5;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #525252;
    transition: all 0.2s;
}

.btn-quick-action:hover {
    background: #f5f5f5;
    border-color: #2563eb;
}

.btn-quick-action:active {
    transform: scale(0.98);
}

.btn-quick-action.copied {
    background: #22c55e;
    border-color: #22c55e;
    color: white;
}

.btn-quick-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #fafafa;
}

.btn-quick-action:disabled:hover {
    border-color: #e5e5e5;
}

.btn-quick-action svg {
    flex-shrink: 0;
}

/* Tooltips para atajos de teclado */
.btn-quick-action {
    position: relative;
}

.btn-quick-action::after {
    content: attr(data-shortcut);
    position: absolute;
    bottom: -32px;
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: #1a1a1a;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s ease;
    z-index: 1000;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.5px;
}

/* Ocultar tooltips en pantallas táctiles */
@media (hover: none) and (pointer: coarse) {
    .btn-quick-action::after,
    .btn-copy-path::after,
    .btn-copy-export-path::after,
    .path-text::after,
    .btn-copy-prompt-clean::after {
        display: none !important;
    }
}

.btn-quick-action:hover::after {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    bottom: -36px;
}

/* Tooltips para botones de copia de ruta - Mostrar atajo de teclado */
.btn-copy-path,
.btn-copy-export-path {
    position: relative;
}

/* Tooltip del BOTÓN: Muestra el atajo de teclado */
.btn-copy-path::after,
.btn-copy-export-path::after {
    content: attr(data-shortcut);
    position: absolute;
    bottom: -32px;
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: #1a1a1a;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s ease;
    z-index: 1000;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.5px;
}

.btn-copy-path:hover::after,
.btn-copy-export-path:hover::after {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    bottom: -36px;
}

/* Tooltip del TEXTO DE LA RUTA: Muestra la ruta completa */
.path-text {
    position: relative;
    cursor: help;
}

.path-text::after {
    content: attr(data-full-path);
    position: absolute;
    bottom: -42px;
    left: 0;
    transform: translateY(0) scale(0.9);
    background: #1a1a1a;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
    max-width: 500px;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s ease;
    z-index: 999;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.3px;
}

.path-text:hover::after {
    opacity: 1;
    transform: translateY(0) scale(1);
    bottom: -46px;
}

.scripts-container {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    width: 100%;
    height: 100%;
    margin: 0;
}

.scripts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 12px;
    width: 100%;
    margin: 0;
    padding: 0;
}

@media (max-width: 900px) {
    .scripts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1200px) and (min-width: 901px) {
    .scripts-grid {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
}

.script-card {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 10px;
    padding: 16px;
    transition: all 0.2s;
    position: relative;
    margin: 0;
    height: fit-content;
    box-sizing: border-box;
}

        .script-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .script-card.used {
            border-color: #86efac;
            background: #f0fdf4;
        }

        .script-card.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .script-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .script-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d4d4d4;
            flex-shrink: 0;
            margin-top: 4px;
        }

        .script-card.used .script-status-indicator {
            background: #22c55e;
        }

        .script-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #737373;
        }

        .script-category-badge {
            padding: 4px 10px;
            background: #e5e5e5;
            border-radius: 6px;
            font-weight: 600;
        }

        .script-content {
            color: #525252;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 16px;
            max-height: 80px;
            overflow: hidden;
            position: relative;
        }

        .script-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, white);
        }

        .script-card.used .script-content::after {
            background: linear-gradient(transparent, #f0fdf4);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #a3a3a3;
        }

        .empty-state h3 {
            font-size: 18px;
            color: #525252;
            margin-bottom: 8px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: all 0.3s ease;
}

@media (max-width: 900px) {
    .modal-content {
        width: 95%;
        max-width: 95%;
        max-height: 85vh;
    }
}

@media (max-width: 768px) {
    .modal-content {
        width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
}
.modal-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    flex-shrink: 0;
    position: sticky;
    top: 0;
    z-index: 10;
}

        .modal-title-section {
            flex: 1;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

.category-path-container {
            margin-top: 12px;
            padding: 12px 16px;
            background: #fafafa;
            border: 1.5px solid #e5e5e5;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .path-icon {
            color: #737373;
            flex-shrink: 0;
        }

        .path-content {
            flex: 1;
            min-width: 0;
        }

        .path-label {
            font-size: 10px;
            font-weight: 700;
            color: #737373;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .path-text {
            font-size: 13px;
            color: #1a1a1a;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            line-height: 1.4;
        }

        .btn-copy-path {
            padding: 8px 14px;
            background: white;
            border: 1.5px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #525252;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .btn-copy-path:hover {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .btn-copy-path.copied {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        /* Botón de Copiar Ruta de Exportación - Color Verde Diferenciado */
        .btn-copy-export-path {
            padding: 8px 14px;
            background: white;
            border: 1.5px solid #22c55e;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #16a34a;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            flex-shrink: 0;
            position: relative;
        }

        .btn-copy-export-path:hover {
            background: #16a34a;
            border-color: #16a34a;
            color: white;
        }

        .btn-copy-export-path.copied {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        .btn-copy-export-path::after {
            content: attr(data-shortcut);
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            background: #1a1a1a;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 1000;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }

        .btn-copy-export-path:hover::after {
            opacity: 1;
            transform: translateX(-50%) scale(1);
            bottom: -36px;
        }

        /* Botón de Copiar Prompt Limpio (sin contenedor de ruta) */
        .btn-copy-prompt-clean {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 1.5px solid #f59e0b;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
        }

        .btn-copy-prompt-clean:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-copy-prompt-clean.copied {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border-color: #16a34a;
        }

        .btn-copy-prompt-clean svg {
            flex-shrink: 0;
        }

        
/* Tooltip mejorado para botones de prompt - Formato limpio para textos largos */
.btn-copy-prompt-clean {
    position: relative;
}

.btn-copy-prompt-clean::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: -60px;
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: #1a1a1a;
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 400;
    white-space: pre-wrap;
    max-width: 500px;
    max-height: 200px;
    overflow-y: auto;
    opacity: 0;
    pointer-events: none; /* Se mantiene none por defecto */
    transition: all 0.3s ease;
    z-index: 1000;
    line-height: 1.6;
    text-align: left;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    font-family: 'Courier New', monospace;
    word-wrap: break-word;
}

.btn-copy-prompt-clean:hover::after {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    bottom: -65px;
    pointer-events: auto; /* CORRECCIÓN: Habilitar interacción al hacer hover */
}

/* Mantener tooltip visible mientras se interactúa con él */
.btn-copy-prompt-clean::after:hover {
    opacity: 1;
    pointer-events: auto;
}

/* Scrollbar personalizado para tooltips largos */
.btn-copy-prompt-clean::after::-webkit-scrollbar {
    width: 4px;
}

.btn-copy-prompt-clean::after::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
}

.btn-copy-prompt-clean::after::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
}

.btn-copy-prompt-clean::after::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

        .btn-copy-prompt-clean:hover::after {
            opacity: 1;
            transform: translateX(-50%) scale(1);
            bottom: -55px;
        }

        .category-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .category-input-row {
            display: flex;
            gap: 8px;
        }

        .category-input input.path-input {
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        /* Botones de acción en categorías */
        .category-item-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .category-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .category-item:hover .category-actions {
            opacity: 1;
        }

        .category-item.active .category-actions {
            opacity: 1;
        }

        .category-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #525252;
            transition: all 0.15s;
            padding: 0;
        }

        .category-action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.1);
        }

        .category-item.active .category-action-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .category-item.active .category-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .category-action-btn.delete:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        .category-item.active .category-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* Modal de edición de categoría */
        .edit-category-highlight {
            background: #eff6ff;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 3px solid #2563eb;
        }

        .edit-category-highlight .current-name {
            font-size: 13px;
            color: #737373;
            margin-bottom: 4px;
        }

        .edit-category-highlight .name-display {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .warning-box {
            background: #fef3c7;
            border: 1.5px solid #fbbf24;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .warning-icon {
            color: #f59e0b;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .warning-content {
            flex: 1;
        }

        .warning-title {
            font-size: 13px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 4px;
        }

        .warning-text {
            font-size: 12px;
            color: #78350f;
            line-height: 1.5;
        }

        .scripts-affected {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: #f59e0b;
            color: white;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 4px;
        }

        .category-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .modal-actions-top {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #525252;
            transition: all 0.15s;
        }

        .icon-btn:hover {
            background: #e5e5e5;
        }

        .icon-btn.delete:hover {
            background: #fef2f2;
            color: #ef4444;
        }

        .icon-btn:hover:not(.delete) {
            background: #eff6ff;
            color: #2563eb;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #737373;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .btn-close:hover {
            background: #f5f5f5;
        }

.modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
}

        .script-full-content {
            background: #fafafa;
            padding: 20px;
            border-radius: 10px;
            line-height: 1.8;
            font-size: 14px;
            color: #1a1a1a;
            margin-bottom: 20px;
            white-space: pre-wrap;
            border: 1px solid #e5e5e5;
        }

        .script-date {
            font-size: 12px;
            color: #737373;
            margin-bottom: 20px;
        }

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e5e5e5;
    display: flex;
    gap: 8px;
    background: white;
    flex-shrink: 0;
    position: sticky;
    bottom: 0;
    z-index: 10;
}

        .nav-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #e5e5e5;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #525252;
        }

        .nav-btn:hover {
            background: #f5f5f5;
        }

        .btn-mark-used {
            flex: 1;
            padding: 10px 20px;
            border: 1px solid #e5e5e5;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #525252;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-mark-used:hover {
            background: #f5f5f5;
        }

        .btn-mark-used.marked {
            background: #f0fdf4;
            border-color: #86efac;
            color: #16a34a;
        }

        .btn-copy-script {
            flex: 1;
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-copy-script:hover {
            background: #1d4ed8;
        }

        /* Form Modal */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: #fafafa;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
        }

        .form-group select option[value=""] {
            color: #a3a3a3;
            font-style: italic;
        }

        .form-group select option:not([value=""]) {
            color: #1a1a1a;
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
            line-height: 1.6;
        }

        /* Formularios responsivos */
        @media (max-width: 768px) {
            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 16px; /* Previene zoom en iOS */
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn-cancel,
            .btn-save {
                width: 100%;
            }
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-cancel {
            flex: 1;
            padding: 10px 20px;
            border: 1px solid #e5e5e5;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-save {
            flex: 1;
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

/* Sistema de PestaÃ±as (Tabs) */
.modal-tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid #e5e5e5;
    margin: -24px -24px 24px -24px;
    padding: 0 24px;
    background: #fafafa;
}

@media (max-width: 768px) {
    .modal-tabs {
        padding: 0 16px;
    }
    
    .tab-button,
    .config-tab-button {
        padding: 12px 16px;
        font-size: 12px;
    }
    
    .tab-button svg,
    .config-tab-button svg {
        width: 14px;
        height: 14px;
    }
}

.tab-button {
    flex: 1;
    padding: 16px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    color: #737373;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
}

.tab-button:hover {
    color: #2563eb;
    background: rgba(37, 99, 235, 0.05);
}

.tab-button.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
    background: white;
}

.tab-button svg {
    transition: transform 0.3s ease;
}

.tab-button.active svg {
    transform: scale(1.1);
}

/* Contenido de las pestaÃ±as */
.tab-content {
    display: none;
    animation: fadeInTab 0.4s ease-out;
}

.tab-content.active {
    display: block;
}

@keyframes fadeInTab {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Estilos para carga masiva de guiones */
.bulk-info {
    background: #eff6ff;
    border: 1.5px solid #bfdbfe;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    font-size: 12px;
    color: #1e40af;
    line-height: 1.6;
}

.bulk-info strong {
    font-weight: 700;
    color: #1e3a8a;
}

.bulk-info code {
    background: #dbeafe;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #1e3a8a;
}

.file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
    width: 100%;
    margin-bottom: 12px;
}

.file-input-wrapper input[type=file] {
    position: absolute;
    left: -9999px;
}

.file-input-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 16px;
    background: white;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    color: #525252;
    font-weight: 600;
}

.file-input-label:hover {
    border-color: #2563eb;
    background: #f9fafb;
    color: #2563eb;
}

.file-input-label.has-file {
    border-color: #22c55e;
    background: #f0fdf4;
    color: #16a34a;
    border-style: solid;
}

.btn-bulk-add {
    width: 100%;
    padding: 12px 20px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-bulk-add:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
}

.btn-bulk-add:active {
    transform: translateY(0);
}

.btn-bulk-add:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    transform: none;
}

.bulk-result {
    margin-top: 16px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 10px;
}

.bulk-result.success {
    display: flex;
    background: #f0fdf4;
    border: 1.5px solid #86efac;
    color: #16a34a;
}

.bulk-result.error {
    display: flex;
    background: #fef2f2;
    border: 1.5px solid #fca5a5;
    color: #dc2626;
}

.bulk-result.warning {
    display: flex;
    background: #fef3c7;
    border: 1.5px solid #fbbf24;
    color: #92400e;
}

/* ============================================
   SISTEMA DE SELECCIÃN MÃLTIPLE
   ============================================ */

.selection-mode-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1a1a1a;
    color: white;
    padding: 16px 32px;
    display: none;
    align-items: center;
    gap: 16px;
    z-index: 999;
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
    animation: slideUpBar 0.3s ease-out;
}

.selection-mode-bar.active {
    display: flex;
}

@keyframes slideUpBar {
    from {
        transform: translateY(100%);
    }
    to {
        transform: translateY(0);
    }
}

.selection-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.selection-count {
    background: #2563eb;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 14px;
}

.selection-text {
    font-size: 14px;
    color: #e5e5e5;
}

.selection-actions {
    display: flex;
    gap: 12px;
}

.btn-selection-action {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-cancel-selection {
    background: #3f3f46;
    color: white;
}

.btn-cancel-selection:hover {
    background: #52525b;
}

.btn-delete-selected {
    background: #ef4444;
    color: white;
}

.btn-delete-selected:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.script-card {
    position: relative;
    cursor: pointer;
}

.script-card.selection-mode {
    cursor: pointer;
    user-select: none;
}

.script-card.selected {
    border-color: #2563eb;
    background: #eff6ff;
    transform: scale(0.98);
}

.script-checkbox {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 24px;
    height: 24px;
    border: 2px solid #d4d4d4;
    border-radius: 6px;
    background: white;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    z-index: 10;
}

.script-card.selection-mode .script-checkbox {
    display: flex;
}

.script-card.selected .script-checkbox {
    background: #2563eb;
    border-color: #2563eb;
}

.script-checkbox svg {
    display: none;
    color: white;
}

.script-card.selected .script-checkbox svg {
    display: block;
}

.btn-select-mode {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1.5px solid #e5e5e5;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #525252;
    transition: all 0.2s;
}

.btn-select-mode:hover {
    background: #f5f5f5;
    border-color: #2563eb;
}

.btn-select-mode.active {
    background: #2563eb;
    border-color: #2563eb;
    color: white;
}

/* ============================================
   MODAL DE CONFIRMACIÃN IN-APP
   ============================================ */

.confirm-dialog {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

.confirm-dialog.active {
    display: flex;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.confirm-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: scaleIn 0.3s ease-out;
}

@keyframes scaleIn {
    from {
        transform: scale(0.9);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.confirm-icon {
    width: 56px;
    height: 56px;
    background: #fee2e2;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.confirm-icon svg {
    color: #ef4444;
}

.confirm-title {
    font-size: 20px;
    font-weight: 700;
    color: #1a1a1a;
    text-align: center;
    margin-bottom: 12px;
}

.confirm-message {
    font-size: 14px;
    color: #737373;
    text-align: center;
    line-height: 1.6;
    margin-bottom: 24px;
}

.confirm-actions {
    display: flex;
    gap: 12px;
}

.btn-confirm {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-confirm-cancel {
    background: #f5f5f5;
    color: #525252;
}

.btn-confirm-cancel:hover {
    background: #e5e5e5;
}

.btn-confirm-delete {
    background: #ef4444;
    color: white;
}

.btn-confirm-delete:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

/* ============================================
   ESTILOS PARA MODAL DE CONFIGURACIÓN REDISEÑADO
   ============================================ */

.config-tabs-container {
    background: #fafafa;
    border-bottom: 2px solid #e5e5e5;
}

.config-tabs {
    display: flex;
    padding: 0 32px;
    gap: 4px;
}

.config-tab-button {
    flex: 1;
    max-width: 250px;
    padding: 16px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    color: #737373;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
}

.config-tab-button:hover {
    color: #2563eb;
    background: rgba(37, 99, 235, 0.05);
}

.config-tab-button.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
    background: white;
}

.config-tab-button svg {
    transition: transform 0.3s ease;
}

.config-tab-button.active svg {
    transform: scale(1.1);
}

.config-tab-content-wrapper {
    overflow-y: auto;
    max-height: calc(95vh - 240px);
}

.config-tab-content {
    display: none;
    animation: fadeInTab 0.4s ease-out;
}

.config-tab-content.active {
    display: block;
}

.config-control-card {
    background: white;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.config-control-card:hover {
    border-color: #2563eb;
    box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1);
}

.config-control-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.config-control-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.config-control-label {
    font-size: 11px;
    font-weight: 700;
    color: #737373;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
}

.config-control-value {
    font-size: 32px;
    font-weight: 700;
    color: #1a1a1a;
    line-height: 1;
}

.config-control-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.config-slider {
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: linear-gradient(90deg, #e5e5e5 0%, #2563eb 50%, #e5e5e5 100%);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
}

.config-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: white;
    border: 3px solid #2563eb;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    transition: all 0.2s;
}

.config-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 3px 12px rgba(37, 99, 235, 0.6);
}

.config-slider::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: white;
    border: 3px solid #2563eb;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    transition: all 0.2s;
}

.config-slider::-moz-range-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 3px 12px rgba(37, 99, 235, 0.6);
}

.config-slider-labels {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #a3a3a3;
    padding: 0 4px;
}

.config-help-text {
    font-size: 12px;
    color: #737373;
    background: #f5f5f5;
    padding: 8px 12px;
    border-radius: 6px;
    margin-top: 4px;
}

/* Estilos para tarjetas de prompts colapsables */
.prompt-category-card {
    background: white;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.prompt-category-card:hover {
    border-color: #22c55e;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.1);
}

.prompt-category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    cursor: pointer;
    background: #fafafa;
    transition: all 0.2s;
}

.prompt-category-header:hover {
    background: #f0fdf4;
}

.prompt-category-header.active {
    background: #f0fdf4;
    border-bottom: 1px solid #e5e5e5;
}

.prompt-category-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.prompt-category-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(34, 197, 94, 0.2);
}

.prompt-category-title {
    font-size: 14px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 2px;
}

.prompt-category-count {
    font-size: 11px;
    color: #737373;
}

.prompt-chevron {
    transition: transform 0.3s ease;
    color: #737373;
}

.prompt-chevron.active {
    transform: rotate(180deg);
}

.prompt-category-body {
    display: none;
    padding: 20px;
    animation: slideDown 0.3s ease-out;
}

.prompt-category-body.active {
    display: block;
}

.prompt-textarea {
    width: 100%;
    min-height: 100px;
    padding: 12px 16px;
    border: 2px solid #e5e5e5;
    border-radius: 10px;
    font-size: 13px;
    font-family: inherit;
    background: #fafafa;
    resize: vertical;
    line-height: 1.6;
    transition: all 0.2s;
}

.prompt-textarea:focus {
    outline: none;
    border-color: #22c55e;
    background: white;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
}

.prompt-hint {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding: 10px 14px;
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 8px;
    font-size: 12px;
    color: #78350f;
}

.prompt-hint code {
    background: white;
    padding: 2px 8px;
    border-radius: 4px;
    color: #f59e0b;
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

/* ============================================
   REDISEÑO MODAL DE VISTA DE GUION
   ============================================ */

.modal-content-wide {
    background: white;
    border-radius: 20px;
    width: 95%;
    max-width: 1400px;
    height: 90vh;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.view-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 28px;
    border-bottom: 1px solid #e5e5e5;
    background: white;
    flex-shrink: 0;
}

.view-header-left {
    display: flex;
    align-items: center;
    gap: 16px;
    flex: 1;
}

.view-header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.nav-circle-btn,
.icon-circle-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1.5px solid #e5e5e5;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #525252;
    transition: all 0.2s;
}

.nav-circle-btn:hover,
.icon-circle-btn:hover {
    background: #f5f5f5;
    border-color: #2563eb;
    color: #2563eb;
    transform: scale(1.05);
}

.icon-circle-btn.delete-btn:hover {
    background: #fef2f2;
    border-color: #ef4444;
    color: #ef4444;
}

.btn-close-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1.5px solid #e5e5e5;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #737373;
    font-size: 24px;
    font-weight: 300;
    transition: all 0.2s;
}

.btn-close-circle:hover {
    background: #f5f5f5;
    color: #1a1a1a;
    transform: rotate(90deg);
}

.view-title-group {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.view-title {
    font-size: 20px;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0;
}

.view-category-pill {
    padding: 6px 14px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: #2563eb;
}

/* Layout de Dos Paneles */
.view-two-panel-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.view-main-panel {
    flex: 1;
    overflow-y: auto;
    padding: 32px 40px;
    background: #fafafa;
}

.view-script-wrapper {
    max-width: 800px;
    margin: 0 auto;
}

.view-date-stamp {
    font-size: 12px;
    color: #a3a3a3;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e5e5;
}

.view-script-content {
    background: white;
    padding: 24px;
    border-radius: 12px;
    line-height: 1.8;
    font-size: 15px;
    color: #1a1a1a;
    white-space: pre-wrap;
    border: 1px solid #e5e5e5;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Panel Lateral */
.view-sidebar-panel {
    width: 380px;
    background: white;
    border-left: 1px solid #e5e5e5;
    overflow-y: auto;
    flex-shrink: 0;
}

.sidebar-panel-content {
    padding: 24px;
}

.sidebar-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    font-weight: 700;
    color: #737373;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 16px;
}

/* Métricas */
.metrics-section {
    margin-bottom: 32px;
}

.metrics-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}

.metric-card {
    padding: 16px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s;
}

.metric-card.metric-blue {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 1.5px solid #bfdbfe;
}

.metric-card.metric-green {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 1.5px solid #86efac;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.metric-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.metric-blue .metric-icon {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.metric-green .metric-icon {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.metric-content {
    flex: 1;
}

.metric-label {
    font-size: 11px;
    font-weight: 600;
    color: #737373;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
}

.metric-blue .metric-value {
    color: #1e40af;
}

.metric-green .metric-value {
    color: #166534;
}

.metric-subtitle {
    font-size: 11px;
    color: #a3a3a3;
}

/* Acciones */
.actions-section {
    margin-bottom: 24px;
}

.sidebar-action-btn {
    width: 100%;
    padding: 14px 16px;
    background: white;
    border: 1.5px solid #e5e5e5;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    margin-bottom: 10px;
    text-align: left;
}

.sidebar-action-btn:hover {
    background: #fafafa;
    border-color: #d4d4d4;
    transform: translateX(2px);
}

.sidebar-action-btn.prompt-btn {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-color: #fbbf24;
}

.sidebar-action-btn.prompt-btn:hover {
    background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
    border-color: #f59e0b;
}

.sidebar-action-btn.path-btn:hover {
    border-color: #2563eb;
    background: #eff6ff;
}

.sidebar-action-btn.export-btn {
    border-color: #86efac;
}

.sidebar-action-btn.export-btn:hover {
    background: #f0fdf4;
    border-color: #22c55e;
}

.action-btn-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.prompt-btn .action-btn-icon {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
}

.path-btn .action-btn-icon {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.export-btn .action-btn-icon {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.action-btn-content {
    flex: 1;
    min-width: 0;
}

.action-btn-title {
    font-size: 13px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 2px;
}

.action-btn-subtitle {
    font-size: 11px;
    color: #737373;
}

.action-btn-path {
    font-size: 11px;
    color: #737373;
    font-family: 'Courier New', monospace;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.action-btn-shortcut {
    font-size: 11px;
    color: #a3a3a3;
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

/* Estado */
.status-section {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
}

.sidebar-status-btn {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #e5e5e5;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    color: #525252;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s;
}

.sidebar-status-btn:hover {
    background: #f5f5f5;
}

.sidebar-status-btn.marked {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-color: #86efac;
    color: #16a34a;
}

.status-btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}

.sidebar-copy-btn {
    width: 100%;
    padding: 14px 16px;
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
}

.sidebar-copy-btn:hover {
    background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
}

/* Responsive */
@media (max-width: 1200px) {
    .view-sidebar-panel {
        width: 320px;
    }
}

/* Vista de dos paneles responsive mejorada */
@media (max-width: 968px) {
    .modal-content-wide {
        width: 98%;
        height: 95vh;
    }
    
    .view-two-panel-layout {
        flex-direction: column;
    }
    
    .view-sidebar-panel {
        width: 100%;
        border-left: none;
        border-top: 1px solid #e5e5e5;
    }
}

/* Ajuste adicional para 824x768 y similares */
@media (max-width: 900px) {
    .view-two-panel-layout {
        flex-direction: column;
        overflow: hidden;
    }
    
    .view-sidebar-panel {
        width: 100%;
        max-height: 50vh;
        border-left: none;
        border-top: 1px solid #e5e5e5;
        overflow-y: auto;
        flex-shrink: 0;
    }
    
    .view-main-panel {
        overflow-y: auto;
        max-height: 50vh;
        flex: 1;
    }
    
    /* Ajustar padding en paneles para móviles */
    .view-main-panel {
        padding: 20px 24px;
    }
    
    .sidebar-panel-content {
        padding: 20px;
    }
    
    /* Mejorar visualización de métricas en móvil */
    .metric-card {
        padding: 14px;
    }
    
    .metric-icon {
        width: 40px;
        height: 40px;
    }
    
    .metric-value {
        font-size: 24px;
    }
    
    /* Ajustar botones de acción */
    .sidebar-action-btn {
        padding: 12px 14px;
    }
    
    .action-btn-icon {
        width: 32px;
        height: 32px;
    }
    
    .action-btn-title {
        font-size: 12px;
    }
    
    .action-btn-subtitle {
        font-size: 10px;
    }
}

/* Estilos para Sliders de Configuración */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.6);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
            transition: all 0.2s;
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.6);
        }

/* ============================================
   MÓDULO DE REFERENCIAS VISUALES
   ============================================ */

.visual-references-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 2px solid #e5e5e5;
}

.visual-references-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.visual-references-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
}

.visual-references-title-group h3 {
    font-size: 16px;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0 0 4px 0;
}

.visual-references-subtitle {
    font-size: 12px;
    color: #737373;
}

.visual-references-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 8px;
    width: 100%;
    padding: 0;
}

@media (max-width: 768px) {
    .visual-references-grid {
        grid-template-columns: 1fr;
    }
}

.visual-reference-card {
    background: #fafafa;
    border: 2px solid #e5e5e5;
    border-radius: 10px;
    padding: 12px;
    transition: all 0.3s ease;
}

.visual-reference-card:hover {
    border-color: #8b5cf6;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
}

.visual-reference-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 700;
    color: #737373;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
}

.visual-reference-label svg {
    color: #8b5cf6;
}

.visual-reference-preview {
    position: relative;
    width: 100%;
    height: 140px;
    background: white;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.visual-reference-preview.has-image {
    border-style: solid;
    border-color: #8b5cf6;
}

.visual-reference-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Recorta la imagen para llenar el cuadro */
    border-radius: 6px;
    transition: filter 0.3s ease;
}

/* Efecto opcional de carga/estética */
.visual-reference-preview img.loading {
    filter: blur(2px);
}

.visual-reference-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: #a3a3a3;
}

.visual-reference-placeholder svg {
    opacity: 0.5;
}

.visual-reference-placeholder-text {
    font-size: 11px;
    text-align: center;
}

.visual-reference-actions {
    display: flex;
    gap: 8px;
}

.visual-reference-input {
    display: none;
}

.btn-upload-reference,
.btn-remove-reference {
    flex: 1;
    padding: 8px 12px;
    border: 1.5px solid #e5e5e5;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-upload-reference {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    border-color: #8b5cf6;
    color: white;
}

.btn-upload-reference:hover {
    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.btn-remove-reference {
    background: white;
    color: #ef4444;
}

.btn-remove-reference:hover {
    background: #fef2f2;
    border-color: #ef4444;
}

.btn-remove-reference:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #fafafa;
}

.btn-remove-reference:disabled:hover {
    transform: none;
    background: #fafafa;
    border-color: #e5e5e5;
}

/* Visualización en el Módulo de Prompts */
.prompts-references-panel {
    padding: 10px 16px;
    background: #fafafa;
    border-bottom: 1px solid #e5e5e5;
}

.prompts-references-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.prompts-references-header-icon {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.prompts-references-title {
    font-size: 12px;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0;
}

.prompts-references-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
}

.prompts-references-header-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.prompts-references-title {
    font-size: 13px;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0;
}

/* ✨ DISEÑO VERTICAL OPTIMIZADO - Todas las resoluciones */
.prompts-references-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.prompts-reference-item {
    display: flex;
    flex-direction: column;
    gap: 0;
    background: white;
    border: 1.5px solid #e5e5e5;
    border-radius: 8px;
    padding: 10px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.prompts-reference-item:hover {
    border-color: #8b5cf6;
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.1);
}

.prompts-reference-image-container {
    width: 100%;
    height: 100px;
    background: #f5f5f5;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 0;
}

.prompts-reference-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ✨ NUEVO: Botón de descarga minimalista con estilo profesional */
.btn-download-reference-minimal {
    width: 100%;
    padding: 12px 16px;
    border: 1.5px solid;
    border-radius: 10px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    margin-top: 10px;
}

.btn-download-reference-minimal:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    filter: brightness(1.05);
}

.btn-download-reference-minimal:active {
    transform: translateY(0);
}

.btn-download-reference-minimal svg:first-child {
    flex-shrink: 0;
}

.btn-download-reference-minimal span {
    flex: 1;
    text-align: left;
}

.prompts-references-empty {
    text-align: center;
    padding: 24px;
    color: #a3a3a3;
    font-size: 12px;
}

/* ============================================
   SISTEMA RESPONSIVO COMPLETO OPTIMIZADO
   ============================================ */

/* Tablets y resoluciones intermedias (1024px - 768px) */
@media (max-width: 1024px) {
    .sidebar {
        width: 220px;
        padding: 16px 12px;
    }
    
    .sidebar-header h1 {
        font-size: 18px;
    }
    
    .stat-item {
        padding: 8px 10px;
        font-size: 13px;
    }
    
    .main-header {
        padding: 20px 24px;
    }
    
    .scripts-grid {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 12px;
    }
}

/* Resoluciones pequeñas tipo 824x768 y tablets verticales */
@media (max-width: 900px) {
    /* Mostrar botón hamburguesa */
    .hamburger-btn {
        display: flex;
    }
    
    /* Sidebar como menú lateral deslizable */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 280px;
        z-index: 1000;
        transform: translateX(-100%);
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    /* Mostrar botón cerrar en sidebar */
    .sidebar-close-btn {
        display: flex;
    }
    
    /* Contenido principal ocupa todo el ancho */
    body {
        flex-direction: column;
    }
    
    .main-content {
        width: 100%;
        margin-left: 0;
    }
    
    .main-header {
        padding: 72px 20px 16px; /* Espacio para hamburguesa */
    }
    
    .header-top {
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .header-top h2 {
        font-size: 20px;
    }
    
    .btn-new-script {
        width: 100%;
        justify-content: center;
    }
    
    /* Filtros en columna */
    .filters-toggle {
        flex-direction: column;
        gap: 8px;
    }
    
    .toggle-filters-btn {
        width: 100%;
    }
    
    .quick-action-buttons {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .filters-panel {
        flex-direction: column;
    }
    
    .filter-group {
        width: 100%;
        min-width: auto;
    }
    
    /* Scripts en una columna */
    .scripts-grid {
        grid-template-columns: 1fr;
    }
    
    .scripts-container {
        padding: 16px 20px;
    }
    
    /* Modales ocupan más espacio */
    .modal-content,
    .modal-content-wide {
        width: 95%;
        max-width: 95%;
        height: 90vh;
        max-height: 90vh;
    }
    
    .view-two-panel-layout {
        flex-direction: column;
    }
    
    .view-sidebar-panel {
        width: 100%;
        max-height: 45vh;
        border-left: none;
        border-top: 1px solid #e5e5e5;
    }
    
.view-main-panel {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
    background: #fafafa;
}
    
    /* Barra de selección */
    .selection-mode-bar {
        padding: 12px 16px;
        flex-wrap: wrap;
    }
    
    .selection-actions {
        width: 100%;
        margin-top: 8px;
    }
}

/* Móviles (768px hacia abajo) */
@media (max-width: 768px) {
    .hamburger-btn {
        width: 44px;
        height: 44px;
        top: 12px;
        left: 12px;
    }
    
    .sidebar {
        width: 85%;
        max-width: 320px;
    }
    
    .main-header {
        padding: 64px 16px 12px;
    }
    
    .header-top h2 {
        font-size: 18px;
    }
    
    .search-input {
        font-size: 16px; /* Previene zoom en iOS */
        padding: 10px 12px 10px 38px;
    }
    
    .quick-action-buttons {
        grid-template-columns: 1fr;
    }
    
    .btn-quick-action {
        font-size: 13px;
        padding: 10px 14px;
    }
    
    .scripts-container {
        padding: 12px 16px;
    }
    
    .script-card {
        padding: 16px;
    }
    
    .script-title {
        font-size: 15px;
    }
    
    /* Modales pantalla completa en móviles */
    .modal-content,
    .modal-content-wide {
        width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
    
    .modal-header {
        padding: 16px;
    }
    
    .modal-body {
        padding: 16px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        font-size: 16px; /* Previene zoom en iOS */
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn-cancel,
    .btn-save {
        width: 100%;
    }
    
    /* Vista de script */
    .view-modal-header {
        padding: 12px 16px;
        flex-wrap: wrap;
    }
    
    .view-header-left {
        width: 100%;
        margin-bottom: 8px;
    }
    
    .view-title {
        font-size: 16px;
    }
    
    .view-script-content {
        padding: 20px;
        font-size: 14px;
    }
    
    .sidebar-panel-content {
        padding: 16px;
    }
    
    .metric-card {
        padding: 12px;
    }
    
    .metric-value {
        font-size: 24px;
    }
    
    /* Generador de prompts */
    .prompts-generator-content {
        width: 100%;
        height: 100vh;
        border-radius: 0;
    }
    
    .prompts-generator-body {
        flex-direction: column;
    }
    
    .prompts-input-panel {
        width: 100%;
        max-height: 35vh;
        border-right: none;
        border-bottom: 1px solid #e5e5e5;
    }
    
    .prompts-display-footer {
        padding: 12px 16px;
    }
    
    .prompts-actions-row {
        flex-direction: column;
        gap: 8px;
    }
    
    .prompts-btn-prev,
    .prompts-btn-copy-current,
    .prompts-btn-next {
        width: 100%;
    }
    
    /* Barra de selección */
    .selection-mode-bar {
        padding: 12px 16px;
        flex-wrap: wrap;
    }
    
    .selection-actions {
        width: 100%;
        margin-top: 8px;
    }
    
    .btn-selection-action {
        flex: 1;
        font-size: 12px;
        padding: 8px 12px;
    }
    
    /* Configuración */
    .config-tabs {
        padding: 0 16px;
    }
    
    .config-tab-button {
        font-size: 12px;
        padding: 12px 16px;
    }
    
    .config-control-card {
        padding: 16px;
    }
    
    .config-control-value {
        font-size: 24px;
    }
    
    /* Tabs */
    .modal-tabs {
        padding: 0 16px;
    }
    
    .tab-button {
        padding: 12px 16px;
        font-size: 12px;
    }
}

/* Móviles pequeños (480px hacia abajo) */
@media (max-width: 480px) {
    .hamburger-btn {
        width: 40px;
        height: 40px;
    }
    
    .sidebar {
        width: 90%;
    }
    
    .main-header {
        padding: 60px 12px 12px;
    }
    
    .header-top h2 {
        font-size: 16px;
    }
    
    .stat-item {
        font-size: 12px;
        padding: 6px 8px;
    }
    
    .stat-number {
        font-size: 14px;
    }
    
    .category-item {
        font-size: 12px;
        padding: 8px 10px;
    }
    
    .script-card {
        padding: 12px;
    }
    
    .script-title {
        font-size: 14px;
    }
    
    .script-content {
        font-size: 12px;
        max-height: 60px;
    }
    
    .nav-circle-btn,
    .icon-circle-btn,
    .btn-close-circle {
        width: 32px;
        height: 32px;
    }
    
    .view-title {
        font-size: 14px;
    }
    
    .view-category-pill {
        font-size: 11px;
        padding: 4px 10px;
    }
    
    .metric-value {
        font-size: 20px;
    }
    
    .config-control-value {
        font-size: 20px;
    }
    
    .btn-selection-action {
        font-size: 12px;
        padding: 8px 12px;
    }
}

/* Landscape en móviles */
@media (max-width: 900px) and (orientation: landscape) {
    .sidebar {
        max-height: 100vh;
    }
    
    .modal-content,
    .modal-content-wide {
        height: 95vh;
    }
    
    .view-two-panel-layout {
        flex-direction: row;
    }
    
    .view-sidebar-panel {
        width: 40%;
        max-height: 100%;
        border-left: 1px solid #e5e5e5;
        border-top: none;
    }
    
    .view-main-panel {
        width: 60%;
        max-height: 100%;
    }
}

/* ============================================
   MÓDULO DE GENERACIÓN DE IMÁGENES/VIDEO
   ============================================ */

.prompts-generator-modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.6); z-index: 3000; align-items: center; justify-content: center;
}
.prompts-generator-modal.active { display: flex; }

.prompts-generator-content {
    background: white; border-radius: 16px; width: 98%; max-width: 1400px; height: 95vh;
    display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.prompts-generator-header {
    display: flex; align-items: center; justify-content: space-between; padding: 16px 24px;
    border-bottom: 1px solid #e5e5e5; background: white; flex-shrink: 0;
}
.prompts-header-left { display: flex; align-items: center; gap: 16px; flex: 1; }
.prompts-header-icon {
    width: 48px; height: 48px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}
.prompts-header-title-group h2 { font-size: 20px; font-weight: 700; color: #1a1a1a; margin: 0 0 4px 0; }
.prompts-header-subtitle { font-size: 13px; color: #737373; }

.prompts-generator-body { display: flex; flex: 1; overflow: hidden; }

/* Panel Izquierdo - Input y Referencias */
.prompts-input-panel {
    width: 380px; background: #fafafa; border-right: 1px solid #e5e5e5;
    display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0;
}
.prompts-input-content { padding: 24px; }
.prompts-input-section-title {
    display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #737373;
    text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px;
}
.prompts-paste-area {
    width: 100%; min-height: 200px; max-height: 40vh; padding: 16px; border: 2px dashed #d1d5db;
    border-radius: 12px; font-size: 13px; font-family: inherit; background: white; resize: vertical;
    line-height: 1.6; transition: all 0.2s;
}
.prompts-paste-area:focus {
    outline: none; border-color: #fbbf24; border-style: solid; background: #fffbeb;
    box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
}
.prompts-paste-area::placeholder { color: #a3a3a3; }
.prompts-input-hint {
    display: flex; align-items: start; gap: 10px; margin-top: 12px; padding: 12px 14px; background: #eff6ff;
    border: 1.5px solid #bfdbfe; border-radius: 8px; font-size: 12px; color: #1e40af; line-height: 1.6;
}
.prompts-btn-process {
    width: 100%; padding: 14px 16px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;
    display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}
.prompts-btn-process:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}
.prompts-btn-process:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Panel Derecho - Visualización de Prompts */
.prompts-display-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f5f5f5; }
.prompts-waiting-state, .prompts-completed-state {
    display: none; flex-direction: column; align-items: center; justify-content: center;
    flex: 1; padding: 48px; text-align: center; color: #737373;
}
.prompts-waiting-state.active, .prompts-completed-state.active { display: flex; }
.prompts-waiting-icon, .prompts-completed-icon {
    width: 64px; height: 64px; background: #e5e5e5; border-radius: 16px; display: flex;
    align-items: center; justify-content: center; margin-bottom: 24px; color: #a3a3a3;
}
.prompts-completed-icon { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #16a34a; }
.prompts-waiting-title, .prompts-completed-title { font-size: 20px; font-weight: 700; color: #1a1a1a; margin-bottom: 8px; }
.prompts-waiting-text, .prompts-completed-text { font-size: 14px; max-width: 400px; line-height: 1.6; }

.prompts-active-state { display: none; flex-direction: column; flex: 1; overflow: hidden; }
.prompts-active-state.active { display: flex; }

.prompts-display-content { flex: 1; overflow-y: auto; padding: 24px; }
.prompts-current-wrapper { max-width: 800px; margin: 0 auto; width: 100%; }
.prompts-current-badge {
    display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; background: white;
    border: 1.5px solid #e5e5e5; border-radius: 20px; font-size: 12px; font-weight: 700; color: #525252;
    margin-bottom: 16px;
}
.prompts-current-content {
    background: white; padding: 24px; border-radius: 12px; border: 1px solid #e5e5e5;
    font-size: 15px; line-height: 1.8; color: #1a1a1a; white-space: pre-wrap; word-wrap: break-word;
    position: relative; overflow: hidden; transition: max-height 0.3s ease;
    max-height: calc(100vh - 400px);
}
.prompts-current-content.expanded { max-height: 80vh; overflow-y: auto; }
.prompts-current-content::-webkit-scrollbar { width: 6px; }
.prompts-current-content::-webkit-scrollbar-track { background: #f5f5f5; }
.prompts-current-content::-webkit-scrollbar-thumb { background: #d4d4d4; border-radius: 3px; }

.prompts-current-content:not(.expanded)::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 80px;
    background: linear-gradient(transparent, white); pointer-events: none;
}
.prompts-read-more-btn {
    display: none; width: 100%; margin-top: 16px; padding: 10px 20px; background: #fafafa;
    border: 1.5px solid #e5e5e5; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600;
    color: #525252; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.prompts-read-more-btn.visible { display: flex; }
.prompts-read-more-btn:hover { background: white; border-color: #2563eb; color: #2563eb; }
.prompts-read-more-btn svg { transition: transform 0.3s ease; }
.prompts-read-more-btn.expanded svg { transform: rotate(180deg); }

.prompts-display-footer { padding: 16px 24px; border-top: 1px solid #e5e5e5; background: #fafafa; flex-shrink: 0; }
.prompts-actions-row { display: flex; gap: 12px; max-width: 800px; margin: 0 auto; }
.prompts-btn-prev, .prompts-btn-copy-current, .prompts-btn-next {
    padding: 14px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;
    display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;
}
.prompts-btn-prev { flex: 1; background: white; border: 1.5px solid #e5e5e5; color: #525252; }
.prompts-btn-prev:hover:not(:disabled) { background: #f5f5f5; border-color: #2563eb; }
.prompts-btn-prev:disabled { opacity: 0.5; cursor: not-allowed; }
.prompts-btn-copy-current { flex: 2; background: white; border: 1.5px solid #e5e5e5; color: #525252; }
.prompts-btn-copy-current:hover { background: #f5f5f5; border-color: #2563eb; }
.prompts-btn-copy-current.copied { background: #f0fdf4; border-color: #22c55e; color: #16a34a; }
.prompts-btn-next {
    flex: 2; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border: none;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}
.prompts-btn-next:hover { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); transform: translateY(-2px); }
.prompts-btn-next.finish { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
.prompts-btn-reset { margin-top: 24px; background: white; border: 1.5px solid #e5e5e5; color: #525252; }
.prompts-btn-reset:hover { background: #f5f5f5; border-color: #fbbf24; }

/* Responsive para el generador */
@media (max-width: 968px) {
    .prompts-generator-body { flex-direction: column; }
    .prompts-input-panel {
        width: 100%; border-right: none; border-bottom: 1px solid #e5e5e5;
        max-height: 45vh; /* Más espacio para el input en móvil */
    }
    .prompts-paste-area { min-height: 120px; }
    .prompts-display-content { padding: 16px; }
    .prompts-current-content { padding: 16px; font-size: 14px; max-height: calc(100vh - 450px); }
    .prompts-actions-row { flex-direction: column; }
}

@media (max-width: 480px) {
    .prompts-header-title-group h2 { font-size: 18px; }
    .prompts-btn-prev, .prompts-btn-copy-current, .prompts-btn-next { padding: 12px 16px; font-size: 13px; }
    .prompts-current-content { font-size: 13px; }
}

/* Optimización máxima para escritorio grande */
@media (min-width: 1400px) {
    .scripts-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        padding: 8px 4px;
    }
    
    .main-header {
        padding: 14px 28px;
    }
    
    .scripts-container {
        padding: 8px 20px;
    }
}

/* Mejora en tablets */
@media (max-width: 1024px) and (min-width: 769px) {
    .scripts-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 10px;
    }
    
    .script-card {
        padding: 14px;
    }
}

/* Ajuste fino para móviles */
@media (max-width: 768px) {
    .scripts-container {
        padding: 8px 12px;
    }
    
    .scripts-grid {
        gap: 8px;
    }
    
    .script-card {
        padding: 12px;
        margin: 0 2px;
    }
}

/* --- INICIO CÓDIGO NUEVO FILTROS --- */
.filter-creation-card {
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}

.filter-inputs-row {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
}

.filter-arrow {
    color: #a3a3a3;
    flex-shrink: 0;
}

.category-tags-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
    padding: 12px;
    background: #fafafa;
    border-radius: 8px;
    border: 1px solid #f0f0f0;
}

.cat-tag-option {
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 16px;
    background: #fff;
    border: 1px solid #e5e5e5;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    font-weight: 500;
    color: #525252;
}

.cat-tag-option:hover {
    border-color: #2563eb;
    color: #2563eb;
}

.cat-tag-option.selected {
    background: #eff6ff;
    border-color: #2563eb;
    color: #2563eb;
    font-weight: 600;
}

.filter-item-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 8px;
    transition: all 0.2s;
}

.filter-item-card:hover {
    border-color: #cbd5e1;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.filter-words-display {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
}

.filter-replacement-arrow {
    color: #2563eb;
    background: #eff6ff;
    padding: 4px;
    border-radius: 4px;
}

.filter-categories-badges {
    display: flex;
    gap: 4px;
    margin-top: 6px;
}

.mini-cat-badge {
    font-size: 10px;
    padding: 2px 8px;
    background: #f5f5f5;
    border-radius: 4px;
    color: #737373;
    border: 1px solid #e5e5e5;
}

.btn-add-filter {
    width: 100%;
    padding: 12px;
    background: #1a1a1a;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-add-filter:hover {
    background: #000;
    transform: translateY(-1px);
}

.prompts-current-badge {
    display: inline-flex; 
    align-items: center; 
    gap: 12px; /* Aumentamos el gap para dar espacio al LED */
    padding: 6px 14px; 
    background: white;
    /* ... resto de estilos existentes ... */
}

/* --- NUEVOS ESTILOS PARA EL LED --- */
.scene-coherence-led {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #d1d5db; /* Color por defecto/apagado */
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.scene-coherence-led.creation {
    background-color: #f59e0b; /* Naranja: Iniciar un nuevo ciclo de creación */
    box-shadow: 0 0 10px #f59e0b, inset 0 0 3px white;
}

.scene-coherence-led.coherence {
    background-color: #22c55e; /* Verde: Mantener coherencia con la escena anterior */
    box-shadow: 0 0 10px #22c55e, inset 0 0 3px white;
}
/* --- FIN DE NUEVOS ESTILOS --- */
/* --- FIN CÓDIGO NUEVO FILTROS --- */

/* --- INICIO CÓDIGO NUEVO SECCIÓN VISUALES PERSONALIZADAS --- */
.custom-visuals-details {
    margin-bottom: 24px;
    border: 1px solid #e5e5e5;
    border-radius: 10px;
    overflow: hidden;
}

.custom-visuals-summary {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #fafafa;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #525252;
    list-style: none; /* Ocultar flecha por defecto */
    transition: background 0.2s;
}

.custom-visuals-summary:hover {
    background: #f5f5f5;
}

.custom-visuals-summary::-webkit-details-marker {
    display: none; /* Ocultar flecha en Chrome/Safari */
}

.summary-chevron {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.custom-visuals-details[open] > .custom-visuals-summary .summary-chevron {
    transform: rotate(180deg);
}

.custom-visuals-content {
    padding: 16px;
    border-top: 1px solid #e5e5e5;
}

.custom-visuals-info {
    font-size: 12px;
    color: #737373;
    background: #eff6ff;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #bfdbfe;
    margin-bottom: 16px;
    line-height: 1.6;
}

/* Estilo para mostrar la imagen de categoría como fallback */
.visual-reference-preview.fallback-preview img {
    opacity: 0.4;
    filter: grayscale(80%);
    border: 2px dashed #a3a3a3;
    border-radius: 6px;
    box-sizing: border-box;
}
/* --- FIN CÓDIGO NUEVO --- */
    </style>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
</head>
<body>
<!-- Botón Hamburguesa (solo visible en móviles) -->
<button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
</button>

<!-- Overlay para cerrar sidebar en móviles -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="mainSidebar">
    <!-- Botón cerrar sidebar (solo móviles) -->
    <button class="sidebar-close-btn" onclick="toggleSidebar()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>

    <div class="sidebar-header">
        <h1>Scripts Manager</h1>
        <p class="sidebar-subtitle">Organiza tus guiones</p>
    </div>

    <div class="stats-section">
        <div class="stat-item">
            <span>Total de guiones</span>
            <span class="stat-number" id="totalScripts">0</span>
        </div>
        <div class="stat-item">
            <span>Disponibles</span>
            <span class="stat-number" id="availableScripts">0</span>
        </div>
        <div class="stat-item">
            <span>Utilizados</span>
            <span class="stat-number" id="usedScripts">0</span>
        </div>
    </div>

    <!-- Botón de Configuración -->
    <button onclick="openConfigModal()" style="
        width: 100%;
        padding: 12px 16px;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 24px;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.3)';" 
       onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(37, 99, 235, 0.2)';">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
            <path d="m19.07 4.93-4.24 4.24m0 6.66 4.24 4.24M4.93 19.07l4.24-4.24m0-6.66L4.93 4.93"></path>
        </svg>
        <span>Configuración</span>
    </button>

    <div class="categories-section">
        <h3>
            CATEGORÍAS
            <button class="add-category-btn" onclick="toggleCategoryInput()">+</button>
        </h3>
        
        <!-- Buscador de categorías -->
        <div class="category-search-container">
            <svg class="category-search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input 
                type="text" 
                class="category-search-input" 
                id="categorySearchInput" 
                placeholder="Buscar categoría..."
                oninput="handleCategorySearch()"
            >
            <button class="category-search-clear" id="categorySearchClear" onclick="clearCategorySearch()" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
<div class="category-input" id="categoryInput">
    <div class="category-input-group">
        <input type="text" id="newCategoryInput" placeholder="Nombre de la categoría" style="width: 100%;">
        
        <!-- === INICIO CÓDIGO NUEVO === -->
        <div style="margin-top: 8px;">
            <label style="font-size: 11px; font-weight: 600; color: #737373; display: block; margin-bottom: 6px;">TIPO DE CONTENIDO</label>
            <div id="newCategoryTypeSelector" style="display: flex; gap: 6px;">
                <button type="button" class="filter-option active" data-type="short" onclick="selectCategoryType(this, 'newCategoryTypeSelector')">Corto</button>
                <button type="button" class="filter-option" data-type="long" onclick="selectCategoryType(this, 'newCategoryTypeSelector')">Largo</button>
            </div>
        </div>
        <!-- === FIN CÓDIGO NUEVO === -->

        <div class="category-input-row">
            <input type="text" id="newCategoryPath" placeholder="Ruta de los clips (opcional)" class="path-input" style="flex: 1;">
        </div>
                <div class="category-input-row">
                    <input type="text" id="newCategoryExportPath" placeholder="Ruta de exportación del video (requerido)" class="path-input" style="flex: 1;">
                </div>
                <div class="category-input-row">
                    <textarea id="newCategoryPrompt" placeholder="Prompt de generación (opcional - usa (X) para número de escenas)" class="path-input" style="flex: 1; min-height: 60px; resize: vertical; font-family: inherit; font-size: 12px;"></textarea>
                </div>
                
                <!-- ✨ NUEVA SECCIÓN: Referencias Visuales Compactas -->
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e5e5;">
                    <div style="font-size: 10px; font-weight: 700; color: #737373; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        Referencias Visuales (Opcional)
                    </div>
                    
                    <!-- Mini Referencias -->
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <!-- Asunto -->
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="file" id="newInputAsunto" accept="image/*" style="display: none;" onchange="handleNewReferenceUpload('asunto', event)">
                            <label for="newInputAsunto" style="flex: 1; padding: 6px 10px; background: white; border: 1.5px dashed #d1d5db; border-radius: 6px; cursor: pointer; font-size: 11px; color: #737373; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.background='#f5f3ff';" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='white';">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                <span id="newLabelAsunto">Asunto</span>
                            </label>
                            <button type="button" id="newBtnRemoveAsunto" onclick="removeNewReference('asunto')" disabled style="padding: 6px; background: #fef2f2; border: 1.5px solid #fecaca; border-radius: 6px; cursor: pointer; opacity: 0.5;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Escena -->
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="file" id="newInputEscena" accept="image/*" style="display: none;" onchange="handleNewReferenceUpload('escena', event)">
                            <label for="newInputEscena" style="flex: 1; padding: 6px 10px; background: white; border: 1.5px dashed #d1d5db; border-radius: 6px; cursor: pointer; font-size: 11px; color: #737373; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.background='#f5f3ff';" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='white';">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                </svg>
                                <span id="newLabelEscena">Escena</span>
                            </label>
                            <button type="button" id="newBtnRemoveEscena" onclick="removeNewReference('escena')" disabled style="padding: 6px; background: #fef2f2; border: 1.5px solid #fecaca; border-radius: 6px; cursor: pointer; opacity: 0.5;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Estilo -->
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="file" id="newInputEstilo" accept="image/*" style="display: none;" onchange="handleNewReferenceUpload('estilo', event)">
                            <label for="newInputEstilo" style="flex: 1; padding: 6px 10px; background: white; border: 1.5px dashed #d1d5db; border-radius: 6px; cursor: pointer; font-size: 11px; color: #737373; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'; this.style.background='#f5f3ff';" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='white';">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                                </svg>
                                <span id="newLabelEstilo">Estilo</span>
                            </label>
                            <button type="button" id="newBtnRemoveEstilo" onclick="removeNewReference('estilo')" disabled style="padding: 6px; background: #fef2f2; border: 1.5px solid #fecaca; border-radius: 6px; cursor: pointer; opacity: 0.5;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="category-input-row">
                    <button onclick="addCategory()" style="width: 100%;">OK</button>
                </div>
            </div>
        </div>

        <div class="category-list" id="categoryList">
            <div class="category-item active" onclick="filterCategory('all')">
                <span><span class="category-icon">📂</span>Todos los guiones</span>
                <span class="category-badge" id="count-all">0</span>
            </div>
        </div>
    </div>
</div>

    <div class="main-content">
        <div class="main-header">
            <div class="header-top">
                <div>
                    <h2 id="mainTitle">Todos los guiones</h2>
                    <p class="header-subtitle"><span id="scriptsCount">0</span> guiones</p>
                </div>
                <button class="btn-new-script" onclick="openAddModal()">
                    <span>+</span>
                    Nuevo guión
                </button>
            </div>
            <div class="search-container">
                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar guiones...">
            </div>

<!-- Panel de Filtros y Acciones Rápidas -->
<div class="filters-toggle">
    <button class="toggle-filters-btn" id="toggleFiltersBtn" onclick="toggleFiltersPanel()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="4" y1="10" x2="4" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="3"></line>
            <line x1="20" y1="21" x2="20" y2="16"></line>
            <line x1="20" y1="12" x2="20" y2="3"></line>
            <line x1="1" y1="14" x2="7" y2="14"></line>
            <line x1="9" y1="8" x2="15" y2="8"></line>
            <line x1="17" y1="16" x2="23" y2="16"></line>
        </svg>
        <span>Filtros</span>
        <span class="active-filters-count" id="activeFiltersCount" style="display: none;">0</span>
    </button>

    <!-- Botones de Acción Rápida -->
    <div class="quick-action-buttons">
        <button class="btn-select-mode" id="btnSelectMode" onclick="toggleSelectionMode()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span>Seleccionar</span>
        </button>
        <button class="btn-quick-action" id="btnQuickCopyPath" onclick="quickCopyPath()" data-shortcut="Ctrl + Shift + X">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
            <span id="quickCopyPathText">Copiar Ruta</span>
        </button>

        <button class="btn-quick-action" id="btnQuickCopyScript" onclick="quickCopyScript()" data-shortcut="Ctrl + Shift + S">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span id="quickCopyScriptText">Copiar Guión</span>
        </button>
    </div>
</div>

            <div class="filters-panel" id="filtersPanel">
                <div class="filter-group">
                    <span class="filter-label">Mostrar</span>
                    <div class="filter-options">
                        <button class="filter-option active" data-status="available" onclick="setStatusFilter('available')">
                            Disponibles
                        </button>
                        <button class="filter-option" data-status="used" onclick="setStatusFilter('used')">
                            Utilizados
                        </button>
                        <button class="filter-option" data-status="all" onclick="setStatusFilter('all')">
                            Todos
                        </button>
                    </div>
                </div>

                <div class="filter-divider"></div>

                <div class="filter-group">
                    <span class="filter-label">Ordenar por</span>
                    <div class="filter-options">
                        <button class="filter-option active" data-sort="recent" onclick="setSortFilter('recent')">
                            Más reciente
                        </button>
                        <button class="filter-option" data-sort="oldest" onclick="setSortFilter('oldest')">
                            Más antiguo
                        </button>
                        <button class="filter-option" data-sort="alpha" onclick="setSortFilter('alpha')">
                            A-Z
                        </button>
                        <button class="filter-option" data-sort="alpha-desc" onclick="setSortFilter('alpha-desc')">
                            Z-A
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="scripts-container">
            <div class="scripts-grid" id="scriptsGrid">
                <div class="empty-state">
                    <h3>No hay guiones todavía</h3>
                    <p>Comienza agregando tu primer guión</p>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Ver Rediseñado - Diseño de Dos Paneles -->
<div class="modal" id="viewModal">
    <div class="modal-content-wide">
        <!-- Header Minimalista -->
        <div class="view-modal-header">
            <div class="view-header-left">
                <button class="nav-circle-btn" onclick="prevScript()" title="Anterior (←)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="nav-circle-btn" onclick="nextScript()" title="Siguiente (→)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                <div class="view-title-group">
                    <h2 class="view-title" id="viewTitle"></h2>
                    <span class="view-category-pill" id="viewCategory"></span>
                </div>
            </div>
            <div class="view-header-right">
                <button class="icon-circle-btn" onclick="openEditScriptModal()" title="Editar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="icon-circle-btn delete-btn" onclick="deleteCurrentScript()" title="Eliminar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                <button class="btn-close-circle" onclick="closeModal('viewModal')" title="Cerrar (Esc)">×</button>
            </div>
        </div>

        <!-- Layout de Dos Paneles -->
        <div class="view-two-panel-layout">
            <!-- Panel Principal: Contenido del Guion -->
            <div class="view-main-panel">
                <div class="view-script-wrapper">
                    <div class="view-date-stamp" id="viewDate"></div>
                    <div class="view-script-content" id="viewContent"></div>
                </div>
            </div>

            <!-- Panel Lateral: Centro de Control -->
            <div class="view-sidebar-panel">
                <div class="sidebar-panel-content">
                    <!-- Métricas Clave -->
                    <div class="metrics-section">
                        <h3 class="sidebar-section-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Métricas Calculadas
                        </h3>
                        <div class="metrics-grid">
                            <div class="metric-card metric-blue">
                                <div class="metric-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                                        <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-label">Escenas</div>
                                    <div class="metric-value" id="viewScenes">0</div>
                                    <div class="metric-subtitle"><span id="viewCharCount">0</span> caracteres</div>
                                </div>
                            </div>
                            <div class="metric-card metric-green">
                                <div class="metric-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-label">Duración</div>
                                    <div class="metric-value" id="viewDuration">0s</div>
                                    <div class="metric-subtitle"><span id="viewSecondsTotal">0</span> segundos</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Acciones Rápidas -->
                    <div class="actions-section">
                        <h3 class="sidebar-section-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 11 12 14 22 4"></polyline>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            Acciones Rápidas
                        </h3>

                        <!-- NUEVO: Botón de Copiar Título -->
                        <button class="sidebar-action-btn" onclick="copyScriptTitle()" title="Ctrl + Shift + F" style="border-color: #8b5cf6; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);">
                            <div class="action-btn-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 7h16M4 12h16M4 17h10"></path>
                                </svg>
                            </div>
                            <div class="action-btn-content">
                                <div class="action-btn-title" id="copyTitleText">Copiar Título</div>
                                <div class="action-btn-subtitle">Copiar nombre del guion</div>
                            </div>
                            <div class="action-btn-shortcut">⌘F</div>
                        </button>

                        <!-- Botón de Prompt de Generación -->
                        <div id="promptContainer" style="display: none;">
                            <button class="sidebar-action-btn prompt-btn" onclick="copyPrompt()" title="Ctrl + Shift + G">
                                <div class="action-btn-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                                    </svg>
                                </div>
                                <div class="action-btn-content">
                                    <div class="action-btn-title" id="copyPromptText">Copiar Prompt de IA</div>
                                    <div class="action-btn-subtitle">Genera imágenes con IA</div>
                                </div>
                                <div class="action-btn-shortcut">⌘G</div>
                            </button>
                            <div id="promptText" style="display: none;"></div>
                        </div>

                        <!-- Ruta de Clips -->
                        <div id="categoryPathContainer" style="display: none;">
                            <button class="sidebar-action-btn path-btn" onclick="copyCategoryPath()" title="Ctrl + Shift + X">
                                <div class="action-btn-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                        <polyline points="13 2 13 9 20 9"></polyline>
                                    </svg>
                                </div>
                                <div class="action-btn-content">
                                    <div class="action-btn-title">Ruta de Clips</div>
                                    <div class="action-btn-path" id="categoryPath"></div>
                                </div>
                                <div class="action-btn-shortcut">⌘X</div>
                            </button>
                        </div>

                        <!-- Ruta de Exportación -->
                        <div id="categoryExportPathContainer" style="display: none;">
                            <button class="sidebar-action-btn export-btn" onclick="copyCategoryExportPath()" title="Ctrl + Shift + E">
                                <div class="action-btn-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </div>
                                <div class="action-btn-content">
                                    <div class="action-btn-title">Ruta de Exportación</div>
                                    <div class="action-btn-path" id="categoryExportPath"></div>
                                </div>
                                <div class="action-btn-shortcut">⌘E</div>
                            </button>
                        </div>
                    </div>

                    <!-- Sección de Estado -->
                    <div class="status-section">
                        <button class="sidebar-status-btn" id="btnMarkUsed" onclick="toggleUsedStatus()">
                            <div class="status-btn-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                </svg>
                            </div>
                            <span id="markUsedText">Marcar como utilizado</span>
                        </button>
                        <button class="sidebar-copy-btn" onclick="copyCurrentScript()" title="Ctrl + Shift + S">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copiar Todo</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar con PestaÃ±as -->
<div class="modal" id="addModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title-section">
                <h2 class="modal-title">Agregar Guiones</h2>
            </div>
            <button class="btn-close" onclick="closeModal('addModal')">×</button>
        </div>

        <div class="modal-body">
            <!-- Sistema de PestaÃ±as -->
            <div class="modal-tabs">
                <button class="tab-button active" id="tabSingle" onclick="switchTab('single')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span>Nuevo Guión</span>
                </button>
                <button class="tab-button" id="tabBulk" onclick="switchTab('bulk')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span>Carga Masiva</span>
                </button>
            </div>

            <!-- PESTAÃ'A 1: Nuevo GuiÃ³n Individual -->
            <div class="tab-content active" id="contentSingle">
                <form onsubmit="saveScript(event)">
                    <div class="form-group">
                        <label>Título del Guión</label>
                        <input type="text" id="scriptTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="scriptCategory">
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contenido del Guión</label>
                        <textarea id="scriptContent" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal('addModal')">Cancelar</button>
                        <button type="submit" class="btn-save">Guardar guión</button>
                    </div>
                </form>
            </div>

            <!-- PESTAÃ'A 2: Carga Masiva -->
            <div class="tab-content" id="contentBulk">
                <div class="bulk-info">
                    <strong>💡 Cómo funciona:</strong> Pega múltiples guiones en el área de texto o carga un archivo <code>.txt</code>. 
                    Separa cada guión con <code>---</code> en una línea nueva.
                    <br><br>
                    <strong>Ejemplo:</strong><br>
                    <code>Este es el guion 1<br>---<br>Este es el guion 2<br>---<br>Este es el guion 3</code>
                </div>

                <div class="form-group">
                    <label>Categoría para todos los guiones</label>
                    <select id="bulkCategory">
                        <option value="General">General</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pegar Guiones (separados por ---)</label>
                    <textarea id="bulkScriptContent" placeholder="Guion 1&#10;---&#10;Guion 2&#10;---&#10;Guion 3" style="min-height: 150px;"></textarea>
                </div>

                <div class="form-group">
                    <label>O Cargar desde Archivo</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="bulkFileInput" accept=".txt" onchange="handleBulkFileSelect(event)">
                        <label for="bulkFileInput" class="file-input-label" id="fileInputLabel">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                <polyline points="13 2 13 9 20 9"></polyline>
                            </svg>
                            <span id="fileInputText">Seleccionar archivo .txt</span>
                        </label>
                    </div>
                </div>

                <button type="button" class="btn-bulk-add" onclick="agregarGuionesMasivos()" id="btnBulkAdd">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Agregar Guiones Masivos
                </button>

                <div class="bulk-result" id="bulkResult">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span id="bulkResultText"></span>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Modal Editar Categoría -->
    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">Editar Categoría</h2>
                </div>
                <button class="btn-close" onclick="closeModal('editCategoryModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="edit-category-highlight">
                    <div class="current-name">Categoría actual</div>
                    <div class="name-display" id="editCurrentCategoryName"></div>
                </div>

                <div class="warning-box" id="editWarningBox" style="display: none;">
                    <svg class="warning-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <div class="warning-content">
                        <div class="warning-title">
                            Cambios en guiones existentes
                            <span class="scripts-affected" id="affectedScriptsCount">0</span>
                        </div>
                        <div class="warning-text">
                            Al cambiar el nombre, todos los guiones de esta categoría se actualizarán automáticamente.
                        </div>
                    </div>
                </div>

<form onsubmit="saveEditCategory(event)">
    <input type="hidden" id="editCategoryOriginalName">
    <div class="form-group">
        <label>Nuevo Nombre de la Categoría</label>
        <input type="text" id="editCategoryName" required>
    </div>

    <!-- === INICIO CÓDIGO NUEVO === -->
    <div class="form-group">
        <label>Tipo de Contenido</label>
        <div id="editCategoryTypeSelector" style="display: flex; gap: 8px;">
            <button type="button" class="filter-option" data-type="short" onclick="selectCategoryType(this, 'editCategoryTypeSelector')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect><path d="M12 18h.01"></path></svg>
                Contenido Corto
            </button>
            <button type="button" class="filter-option" data-type="long" onclick="selectCategoryType(this, 'editCategoryTypeSelector')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                Contenido Largo
            </button>
        </div>
    </div>
    <!-- === FIN CÓDIGO NUEVO === -->

    <div class="form-group">
                    <label>Ruta de los Clips</label>
                    <input type="text" id="editCategoryPath" placeholder="Ej: C:\Videos\Clips" class="path-input">
                </div>
                <div class="form-group">
                    <label>Ruta de Exportación del Video <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="editCategoryExportPath" placeholder="Ej: C:\Videos\Exportados (si se deja vacío no se guardará ruta)" class="path-input">
                </div>
                <div class="form-group">
                    <label>Prompt de Generación de Imágenes/Video</label>
                    <textarea id="editCategoryPrompt" placeholder="Usa (X) para el número de escenas. Ej: Genera (X) prompts..." class="path-input" style="min-height: 80px; resize: vertical;"></textarea>
                    <small style="font-size: 11px; color: #737373; margin-top: 4px; display: block;">
                        💡 Usa <strong>(X)</strong> donde quieras que aparezca el número de escenas calculado
                    </small>
                </div>
                <!-- NUEVA SECCIÓN: Referencias Visuales -->
                <div class="visual-references-section">
                    <div class="visual-references-header">
                        <div class="visual-references-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        <div class="visual-references-title-group">
                            <h3>🖼️ Referencias Visuales</h3>
                            <p class="visual-references-subtitle">Sube imágenes de referencia para la generación con IA</p>
                        </div>
                    </div>
                    
                    <div class="visual-references-grid">
                        <!-- Referencia: Asunto -->
                        <div class="visual-reference-card">
                            <div class="visual-reference-label">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                Asunto
                            </div>
                            <div class="visual-reference-preview" id="previewAsunto">
                                <div class="visual-reference-placeholder">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    <span class="visual-reference-placeholder-text">Referencia del<br>tema principal</span>
                                </div>
                            </div>
                            <div class="visual-reference-actions">
                                <input type="file" id="inputAsunto" class="visual-reference-input" accept="image/*" onchange="handleReferenceUpload('asunto', event)">
                                <label for="inputAsunto" class="btn-upload-reference">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Subir
                                </label>
                                <button type="button" class="btn-remove-reference" id="btnRemoveAsunto" onclick="removeReference('asunto')" disabled>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Referencia: Escena -->
                        <div class="visual-reference-card">
                            <div class="visual-reference-label">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                </svg>
                                Escena
                            </div>
                            <div class="visual-reference-preview" id="previewEscena">
                                <div class="visual-reference-placeholder">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    <span class="visual-reference-placeholder-text">Referencia de<br>composición/ambiente</span>
                                </div>
                            </div>
                            <div class="visual-reference-actions">
                                <input type="file" id="inputEscena" class="visual-reference-input" accept="image/*" onchange="handleReferenceUpload('escena', event)">
                                <label for="inputEscena" class="btn-upload-reference">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Subir
                                </label>
                                <button type="button" class="btn-remove-reference" id="btnRemoveEscena" onclick="removeReference('escena')" disabled>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Referencia: Estilo -->
                        <div class="visual-reference-card">
                            <div class="visual-reference-label">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                                </svg>
                                Estilo
                            </div>
                            <div class="visual-reference-preview" id="previewEstilo">
                                <div class="visual-reference-placeholder">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    <span class="visual-reference-placeholder-text">Referencia de<br>estética visual</span>
                                </div>
                            </div>
                            <div class="visual-reference-actions">
                                <input type="file" id="inputEstilo" class="visual-reference-input" accept="image/*" onchange="handleReferenceUpload('estilo', event)">
                                <label for="inputEstilo" class="btn-upload-reference">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Subir
                                </label>
                                <button type="button" class="btn-remove-reference" id="btnRemoveEstilo" onclick="removeReference('estilo')" disabled>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('editCategoryModal')">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar cambios</button>
                </div>
            </form>
            </div>
        </div>
</div>

    <!-- Modal Editar Guión -->
    <div class="modal" id="editScriptModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">Editar Guión</h2>
                </div>
                <button class="btn-close" onclick="closeModal('editScriptModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="edit-category-highlight">
                    <div class="current-name">Editando</div>
                    <div class="name-display" id="editCurrentScriptTitle"></div>
                </div>

                <form onsubmit="saveEditScript(event)">
                    <input type="hidden" id="editScriptId">
                    <div class="form-group">
                        <label>Título del Guión</label>
                        <input type="text" id="editScriptTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="editScriptCategory">
                            <option value="">Sin categoría</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contenido del Guión</label>
                        <textarea id="editScriptContent" required></textarea>
                    </div>
                    
                    <!-- === INICIO CÓDIGO NUEVO === -->
                    <details class="custom-visuals-details">
                        <summary class="custom-visuals-summary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <span>Ajustes de Referencias Visuales (Opcional)</span>
                            <div class="summary-chevron">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                        </summary>
                        <div class="custom-visuals-content">
                            <p class="custom-visuals-info">
                                Sobrescribe las referencias de la categoría <strong>solo para este guion</strong>. Si dejas un campo vacío, se usará la imagen de la categoría por defecto.
                            </p>
                            <div class="visual-references-grid" id="editScriptVisualsGrid">
                                <!-- Asunto -->
                                <div class="visual-reference-card">
                                    <div class="visual-reference-label">Asunto</div>
                                    <div class="visual-reference-preview" id="editScriptPreviewAsunto"></div>
                                    <div class="visual-reference-actions">
                                        <input type="file" id="editScriptInputAsunto" class="visual-reference-input" accept="image/*" onchange="handleCustomReferenceUpload('asunto', event)">
                                        <label for="editScriptInputAsunto" class="btn-upload-reference">Subir</label>
                                        <button type="button" class="btn-remove-reference" id="editScriptBtnRemoveAsunto" onclick="removeCustomReference('asunto')" disabled>Quitar</button>
                                    </div>
                                </div>
                                <!-- Escena -->
                                <div class="visual-reference-card">
                                    <div class="visual-reference-label">Escena</div>
                                    <div class="visual-reference-preview" id="editScriptPreviewEscena"></div>
                                    <div class="visual-reference-actions">
                                        <input type="file" id="editScriptInputEscena" class="visual-reference-input" accept="image/*" onchange="handleCustomReferenceUpload('escena', event)">
                                        <label for="editScriptInputEscena" class="btn-upload-reference">Subir</label>
                                        <button type="button" class="btn-remove-reference" id="editScriptBtnRemoveEscena" onclick="removeCustomReference('escena')" disabled>Quitar</button>
                                    </div>
                                </div>
                                <!-- Estilo -->
                                <div class="visual-reference-card">
                                    <div class="visual-reference-label">Estilo</div>
                                    <div class="visual-reference-preview" id="editScriptPreviewEstilo"></div>
                                    <div class="visual-reference-actions">
                                        <input type="file" id="editScriptInputEstilo" class="visual-reference-input" accept="image/*" onchange="handleCustomReferenceUpload('estilo', event)">
                                        <label for="editScriptInputEstilo" class="btn-upload-reference">Subir</label>
                                        <button type="button" class="btn-remove-reference" id="editScriptBtnRemoveEstilo" onclick="removeCustomReference('estilo')" disabled>Quitar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>
                    <!-- === FIN CÓDIGO NUEVO === -->

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal('editScriptModal')">Cancelar</button>
                        <button type="submit" class="btn-save">Guardar cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Barra de Selección Múltiple -->
    <div class="selection-mode-bar" id="selectionModeBar">
        <div class="selection-info">
            <div class="selection-count" id="selectionCount">0</div>
            <div class="selection-text">guiones seleccionados</div>
        </div>
        <div class="selection-actions">
            <button class="btn-selection-action btn-cancel-selection" onclick="cancelSelectionMode()">
                Cancelar
            </button>
            <button class="btn-selection-action btn-delete-selected" onclick="deleteSelectedScripts()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Eliminar seleccionados
            </button>
        </div>
    </div>

    <!-- Diálogo de Confirmación -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>
            <h3 class="confirm-title" id="confirmTitle">¿Eliminar guión?</h3>
            <p class="confirm-message" id="confirmMessage">Esta acción no se puede deshacer.</p>
            <div class="confirm-actions">
                <button class="btn-confirm btn-confirm-cancel" onclick="closeConfirmDialog()">
                    Cancelar
                </button>
                <button class="btn-confirm btn-confirm-delete" id="btnConfirmDelete" onclick="confirmDelete()">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

<!-- Modal de Configuración Rediseñado -->
<div class="modal" id="configModal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh;">
        <div class="modal-header">
            <div class="modal-title-section">
                <h2 class="modal-title">⚙️ Configuración del Sistema</h2>
                <p style="font-size: 13px; color: #737373; margin-top: 4px;">
                    Gestiona los parámetros de cálculo y generadores de contenido
                </p>
            </div>
            <button class="btn-close" onclick="closeModal('configModal')">×</button>
        </div>
        
        <div class="modal-body" style="padding: 0;">
            <!-- Sistema de Pestañas para Configuración -->
            <div class="config-tabs-container">
<!-- CORRECCIÓN PARA LA SECCIÓN DE BOTONES (Paso 2.1) -->
<div class="config-tabs">
    <!-- Botón 1: Fórmulas -->
    <button class="config-tab-button active" onclick="switchConfigTab('formulas')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <path d="M3 9h18"></path>
            <path d="M9 21V9"></path>
        </svg>
        <span>Fórmulas Base</span>
    </button>
    
    <!-- Botón 2: Prompts (ESTE FALTABA) -->
    <button class="config-tab-button" onclick="switchConfigTab('prompts')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
        </svg>
        <span>Prompts para IA</span>
    </button>

    <!-- Botón 3: Filtros (NUEVO) -->
    <button class="config-tab-button" onclick="switchConfigTab('filters')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 21v-7"></path>
            <path d="M4 10V3"></path>
            <path d="M12 21v-9"></path>
            <path d="M12 8V3"></path>
            <path d="M20 21v-5"></path>
            <path d="M20 12V3"></path>
            <path d="M1 14h6"></path>
            <path d="M9 8h6"></path>
            <path d="M17 16h6"></path>
        </svg>
        <span>Filtros de Texto</span>
    </button>
</div>
            </div>

            <!-- Contenido de las Pestañas -->
            <div class="config-tab-content-wrapper">
                <!-- PESTAÑA 1: Fórmulas Base -->
<div class="config-tab-content active" id="configTabFormulas">
    <div style="padding: 32px;">
        <!-- Grid de Controles -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

            <!-- Columna: Contenido Corto -->
            <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="background: #eff6ff; border: 1.5px solid #bfdbfe; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect><path d="M12 18h.01"></path></svg>
                    </div>
                    <div>
                        <h3 style="font-size: 14px; font-weight: 700; color: #1a1a1a; margin: 0;">Parámetros para Contenido Corto</h3>
                        <p style="font-size: 12px; color: #737373; margin: 2px 0 0 0;">(Shorts, Reels, TikToks)</p>
                    </div>
                </div>

                <!-- Control 1: Caracteres por Escena (Corto) -->
                <div class="config-control-card" style="margin-bottom: 16px;">
                    <div class="config-control-header">
                        <div class="config-control-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                        </div>
                        <div>
                            <div class="config-control-label">Base de Caracteres</div>
                            <div class="config-control-value" id="configCharactersShortDisplay">83</div>
                        </div>
                    </div>
                    <div class="config-control-body">
                        <input type="range" id="configCharactersShort" min="50" max="150" value="83" class="config-slider" oninput="updateConfigDisplay()">
                        <div class="config-slider-labels"><span>50</span><span>150</span></div>
                    </div>
                </div>

                <!-- Control 2: Segundos por Escena (Corto) -->
                <div class="config-control-card">
                    <div class="config-control-header">
                        <div class="config-control-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </div>
                        <div>
                            <div class="config-control-label">Duración por Escena</div>
                            <div class="config-control-value" id="configSecondsShortDisplay">5<span style="font-size: 14px;">s</span></div>
                        </div>
                    </div>
                    <div class="config-control-body">
                        <input type="range" id="configSecondsShort" min="3" max="10" value="5" class="config-slider" oninput="updateConfigDisplay()">
                        <div class="config-slider-labels"><span>3s</span><span>10s</span></div>
                    </div>
                </div>
            </div>

            <!-- Columna: Contenido Largo -->
            <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="background: #f1f5f9; border: 1.5px solid #e2e8f0; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                    </div>
                     <div>
                        <h3 style="font-size: 14px; font-weight: 700; color: #1a1a1a; margin: 0;">Parámetros para Contenido Largo</h3>
                        <p style="font-size: 12px; color: #737373; margin: 2px 0 0 0;">(YouTube, Documentales)</p>
                    </div>
                </div>
                 <!-- Control 3: Caracteres por Escena (Largo) -->
                <div class="config-control-card" style="margin-bottom: 16px;">
                    <div class="config-control-header">
                        <div class="config-control-icon" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                        </div>
                        <div>
                            <div class="config-control-label">Base de Caracteres</div>
                            <div class="config-control-value" id="configCharactersLongDisplay">600</div>
                        </div>
                    </div>
                    <div class="config-control-body">
                        <input type="range" id="configCharactersLong" min="150" max="1000" step="10" value="600" class="config-slider" oninput="updateConfigDisplay()">
                        <div class="config-slider-labels"><span>150</span><span>1000</span></div>
                    </div>
                </div>

                <!-- Control 4: Segundos por Escena (Largo) -->
                <div class="config-control-card">
                    <div class="config-control-header">
                        <div class="config-control-icon" style="background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </div>
                        <div>
                            <div class="config-control-label">Duración por Escena</div>
                            <div class="config-control-value" id="configSecondsLongDisplay">20<span style="font-size: 14px;">s</span></div>
                        </div>
                    </div>
                    <div class="config-control-body">
                        <input type="range" id="configSecondsLong" min="10" max="30" value="20" class="config-slider" oninput="updateConfigDisplay()">
                        <div class="config-slider-labels"><span>10s</span><span>30s</span></div>
                    </div>
                </div>
            </div>

        </div> <!-- Fin del grid -->

        <!-- Control de Coherencia (Se mantiene) -->
        <div class="config-control-card" style="margin-top: 24px;">
            <div class="config-control-header">
                <div class="config-control-icon" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M2 12h20M7 7l-5 5 5 5M17 7l5 5-5 5"></path></svg>
                </div>
                <div>
                    <div class="config-control-label">Ciclo de Coherencia</div>
                    <div class="config-control-value" id="configCoherenceDisplay">5<span style="font-size: 14px; font-weight: 400; color: #737373;"> escenas</span></div>
                </div>
            </div>
            <div class="config-control-body">
                <input type="range" id="configSceneCoherenceLength" min="0" max="15" value="5" class="config-slider" oninput="updateConfigDisplay()">
                <div class="config-slider-labels">
                    <span>0</span>
                    <span style="color: #f59e0b; font-weight: 600;">Escenas por ciclo</span>
                    <span>15</span>
                </div>
                <div class="config-help-text">
                    🎨 Un valor de 0 desactiva la función de coherencia.
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- PESTAÑA 2: Generadores de IA -->
                <div class="config-tab-content" id="configTabPrompts">
                    <div style="padding: 32px;">
                        <!-- Header Explicativo -->
                        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-left: 4px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                            <div style="display: flex; align-items: start; gap: 16px;">
                                <div style="background: white; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                                    </svg>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="font-size: 16px; font-weight: 700; color: #166534; margin-bottom: 8px;">
                                        ✨ Generadores de Contenido por IA
                                    </h3>
                                    <p style="font-size: 13px; color: #166534; line-height: 1.6; margin: 0;">
                                        Configura plantillas de prompts personalizadas para cada categoría. Usa <code style="background: white; padding: 2px 6px; border-radius: 4px; color: #22c55e; font-weight: 600;">(X)</code> donde quieras que aparezca el número de escenas calculado.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Prompts por Categoría -->
                        <div id="configPromptsContainer"></div>
                    </div>
                </div>
                <!-- PESTAÑA 3: Filtros de Texto -->
                <div class="config-tab-content" id="configTabFilters">
                    <div style="padding: 32px;">
                        <!-- Header Explicativo -->
                        <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%); border-left: 4px solid #525252; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                            <div style="display: flex; align-items: start; gap: 16px;">
                                <div style="background: white; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#525252" stroke-width="2">
                                        <polyline points="4 7 4 4 20 4 20 7"></polyline>
                                        <line x1="9" y1="20" x2="15" y2="20"></line>
                                        <line x1="12" y1="4" x2="12" y2="20"></line>
                                    </svg>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 8px;">
                                        Reemplazo Automático
                                    </h3>
                                    <p style="font-size: 13px; color: #525252; line-height: 1.6; margin: 0;">
                                        Define palabras que serán reemplazadas automáticamente al guardar un guion. Útil para corregir terminología técnica o censurar palabras según la categoría.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Área de Creación -->
                        <div class="filter-creation-card">
                            <h4 style="font-size: 13px; font-weight: 700; color: #1a1a1a; margin-bottom: 12px;">NUEVA REGLA</h4>
                            
                            <div class="filter-inputs-row">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; font-weight: 700; color: #737373; display: block; margin-bottom: 6px;">ORIGINAL</label>
                                    <input type="text" id="newFilterOriginal" class="search-input" placeholder="Ej: codigo" style="background: #fff;">
                                </div>
                                <div class="filter-arrow">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                        <polyline points="12 5 19 12 12 19"></polyline>
                                    </svg>
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; font-weight: 700; color: #2563eb; display: block; margin-bottom: 6px;">REEMPLAZO</label>
                                    <input type="text" id="newFilterReplacement" class="search-input" placeholder="Ej: codix" style="background: #fff; border-color: #bfdbfe;">
                                </div>
                            </div>

                            <label style="font-size: 11px; font-weight: 700; color: #737373;">APLICAR EN CATEGORÍAS:</label>
                            <div class="category-tags-selector" id="newFilterCategories">
                                <!-- Se llenará con JS -->
                            </div>
                            
                            <button class="btn-add-filter" onclick="addNewFilter()" style="margin-top: 16px;">
                                + Agregar Regla de Reemplazo
                            </button>
                        </div>

                        <!-- Lista de Filtros Existentes -->
                        <h4 style="font-size: 12px; font-weight: 700; color: #a3a3a3; letter-spacing: 0.05em; margin-bottom: 12px;">REGLAS ACTIVAS</h4>
                        <div id="activeFiltersList">
                            <!-- Se llenará con JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer" style="background: #fafafa; border-top: 2px solid #e5e5e5;">
            <button type="button" class="btn-cancel" onclick="closeModal('configModal')" style="flex: 0 0 auto; min-width: 120px;">
                Cancelar
            </button>
            <button type="button" class="btn-save" onclick="saveConfiguration()" style="flex: 0 0 auto; min-width: 180px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Guardar Configuración
            </button>
        </div>
</div>
</div>

<!-- Modal de Generación de Imágenes/Video -->
<div class="prompts-generator-modal" id="promptsGeneratorModal">
    <div class="prompts-generator-content">
        <!-- Header -->
        <div class="prompts-generator-header">
            <div class="prompts-header-left">
                <div class="prompts-header-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                    </svg>
                </div>
                <div class="prompts-header-title-group">
                    <h2>Generador de Prompts</h2>
                    <p class="prompts-header-subtitle">Visualiza y copia prompts uno por uno</p>
                </div>
            </div>
            <button class="btn-close-circle" onclick="closePromptsGenerator()" title="Cerrar (Esc)">×</button>
        </div>

        <!-- Cuerpo - Dos Paneles -->
        <div class="prompts-generator-body">
            <!-- Panel Izquierdo: Input y Referencias -->
            <div class="prompts-input-panel">
                <div class="prompts-input-content">
                    <!-- Paso 1: Referencias Visuales -->
                    <div class="prompts-references-panel" id="promptsReferencesPanel" style="display: none; padding: 0; border: none;">
                        <div class="prompts-references-header">
                            <div class="prompts-references-header-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </div>
                            <h4 class="prompts-references-title">Referencias Visuales</h4>
                        </div>
                        <div class="prompts-references-grid" id="promptsReferencesGrid">
                            <!-- Las referencias se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <!-- Paso 2: Cargar Prompts -->
                    <div id="promptsLoaderSection" style="margin-top: 24px;">
                         <h3 class="prompts-input-section-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path>
                                <rect x="9" y="3" width="6" height="4" rx="2"></rect>
                            </svg>
                            Cargar Prompts
                        </h3>
                        <textarea class="prompts-paste-area" id="promptsPasteArea" placeholder="Pega aquí la lista de prompts generada por la IA..."></textarea>
                        <div class="prompts-input-hint">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
                                <circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <span>El sistema espera una lista numerada (1., 2., 3., etc.). El botón procesará todo el texto que pegues.</span>
                        </div>
                        <!-- MODIFICACIÓN: Contenedor para los botones de procesamiento -->
                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button type="button" class="prompts-btn-process" id="pasteAndProcessBtn" onclick="pasteAndProcessFromClipboard()" style="flex: 1; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);" onmouseover="this.style.background='linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                </svg>
                                <span>Pegar y Procesar</span>
                            </button>
                            <button class="prompts-btn-process" id="promptsProcessBtn" onclick="processPromptsFromTextArea()" style="flex: 1;">
                                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 20h.01"></path><path d="M12 4v12"></path><path d="m15 15-3 3-3-3"></path>
                                 </svg>
                                <span>Procesar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Derecho: Visualización de Prompts -->
            <div class="prompts-display-panel">
                <!-- Estado 1: Esperando Input -->
                <div class="prompts-waiting-state active" id="promptsWaitingState">
                    <div class="prompts-waiting-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                            <path d="m15 15-3 3-3-3"></path><path d="M12 18V3"></path><path d="M21 12H3"></path>
                        </svg>
                    </div>
                    <h3 class="prompts-waiting-title">Listo para Visualizar</h3>
                    <p class="prompts-waiting-text">Pega el contenido en el panel izquierdo y presiona "Procesar" para comenzar.</p>
                </div>

                <!-- Estado 2: Mostrando Prompt Actual -->
                <div class="prompts-active-state" id="promptsActiveState">
                    <div class="prompts-display-content">
                        <div class="prompts-current-wrapper">
                            <div class="prompts-current-badge">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                                </svg>
                                <span id="promptsCurrentBadge">Prompt 1</span>
                                <div id="sceneCoherenceLed" class="scene-coherence-led" title="Indicador de Coherencia de Escena"></div>
                            </div>
                            <div class="prompts-current-content" id="promptsCurrentContent">
                                <!-- El prompt actual se mostrará aquí -->
                            </div>
                            <button class="prompts-read-more-btn" id="promptsReadMoreBtn" onclick="togglePromptExpansion()">
                                <span id="readMoreBtnText">Leer Más</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="prompts-display-footer">
                        <div class="prompts-actions-row">
                             <button class="prompts-btn-prev" id="promptsPrevBtn" onclick="prevPrompt()" style="flex: 1;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                                <span>Anterior</span>
                             </button>
                            <button class="prompts-btn-copy-current" id="promptsCopyBtn" onclick="copyCurrentPrompt()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                <span id="promptsCopyBtnText">Copiar Prompt</span>
                            </button>
                            <button class="prompts-btn-next" id="promptsNextBtn" onclick="nextPrompt()">
                                <span id="promptsNextBtnText">Siguiente Prompt</span>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estado 3: Completado -->
                <div class="prompts-completed-state" id="promptsCompletedState">
                    <div class="prompts-completed-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <h3 class="prompts-completed-title">¡Proceso Completado!</h3>
                    <p class="prompts-completed-text">Has revisado todos los prompts. Puedes cerrar esta ventana o procesar un nuevo lote.</p>
                    <button class="prompts-btn-reset" onclick="resetPromptsGenerator()" style="margin-top: 24px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                        <span>Procesar Nuevos Prompts</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Reinicio de Prompts -->
<div class="confirm-dialog" id="confirmRestartPromptsDialog">
    <div class="confirm-content">
        <div class="confirm-icon" style="background: #fef3c7;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
        </div>
        <h3 class="confirm-title">¿Reiniciar y cargar nuevos prompts?</h3>
        <p class="confirm-message">Se perderá el progreso actual de la visualización de prompts.</p>
        <div class="confirm-actions">
            <button class="btn-confirm btn-confirm-cancel" onclick="closeRestartPromptsDialog()">
                Cancelar
            </button>
            <button class="btn-confirm" style="background: #f59e0b; color: white;" onclick="confirmRestartPrompts()">
                Sí, Reiniciar
            </button>
        </div>
    </div>
</div>
    <script>
// ============================================
// ARQUITECTURA DE DATOS: INDEXEDDB (DEXIE)
// ============================================

// 1. Configuración de la Base de Datos
const db = new Dexie("ScriptsManagerDB");

// Definición del Esquema (Schema)
// scripts: Almacena los guiones completos.
// categories: Almacena configuraciones de categorías e imágenes.
// settings: Almacena configuración global y filtros.
db.version(1).stores({
    scripts: 'id, title, category, used, createdAt', // Índices para búsqueda rápida
    categories: 'name', // 'name' es la llave primaria
    settings: 'key' 
});

// 2. Variables Globales de Estado (State Management)
// Estas variables mantienen una copia en memoria para reactividad de la UI
let scripts = [];
let categories = [];
let wordFilters = []; 

let config = {
    formulas: {
        short: { charactersPerScene: 83, secondsPerScene: 5 },
        long: { charactersPerScene: 600, secondsPerScene: 20 }
    },
    sceneCoherenceLength: 5
};

// Variables de UI
let currentFilter = 'all';
let currentViewIndex = -1;
let filteredScripts = [];
let searchQuery = '';
let statusFilter = 'available';
let sortFilter = 'recent';
let filtersActive = false;
let selectionMode = false;
let selectedScripts = new Set();
let confirmCallback = null;

// Prompt Maestro
const DEFAULT_PROMPT_TEMPLATE = `Sistema de Generación de Prompts Cinematográficos para IA

Por favor solo responde a lo que te pido, no adicciones elementos extras ni estructuras de respuestas diferentes a la que te pido

Pide en cada prompt utilizar la base el estilo, escena y asunto de estas imagenes. Siempre que se pueda y vea necesario

[REGLA CRÍTICA] **NO GENERAR IMÁGENES**. Solo se debe producir el texto del prompt de imagen según el formato y las especificaciones.

[REGLA ESTRICTA] Responde siempre breve, directo, sin explicaciones ni comentarios adicionales. No improvises ni te salgas de las instrucciones. No utilices emojis en ningún caso.

[INSTRUCCIÓN MAESTRA UNIVERSAL] Eres un ingeniero de prompts de la más alta calidad. **Genera (X) prompts** de imágenes al estilo cinematográfico de alta calidad para que coincidan con el guion proporcionado. Cada prompt debe contener la mayor cantidad de detalles posibles para una precisión máxima.

[FORMATO DE RESPUESTA REQUERIDO]
La respuesta debe ser siempre una lista numerada (1., 2., 3., etc.) de prompts de imágenes individuales. Cada elemento de la lista debe introducir la referencia del guion y el estilo, utilizando esta estructura:
[Referencia del Guion]: [Estilo]: Prompt de imagen: [PROMPT DE ALTO DETALLE]

🖼️ Principios de Diseño Visual (Cinematográfico Universal)

1. Fidelidad Narrativa: Cada imagen debe seguir y potenciar la historia del guion, buscando generar una fuerte conexión emocional e interés en cada cambio de escena.

2. Coherencia y Arco del Personaje (CRÍTICO):
   * Primeras Escenas: El prompt debe especificar una versión del personaje lo más **realista, estable y auténtica posible** para fomentar la identificación y la conexión inicial con la audiencia.
   * Progresión: Mantener la coherencia del personaje (rasgos, vestimenta, ambiente) a lo largo de todas las escenas.

3. Integración de Interacción (Si Aplica): Si el guion menciona una interacción (ej. "Comenta", "Dale Like"), el prompt debe solicitar que se incorpore discretamente en la composición (ej. un recurso, ítem, diseño, o texto flotante) relacionado con esa acción, incluyendo el título de la interacción (ej. "Add Interaction Title").

🎨 Estilo y Atmósfera (Adaptable)

* Estilo Visual: Realismo Cinematográfico de Alto Contraste (Ajusta el contraste según el nicho: oscuro-noir para terror/drama; brillante-vibrante para comedia/alegría).
* Composición: Uso exhaustivo de la iluminación direccional (ej. *key lighting*, *fill lighting* y *rim lighting*) para destacar al personaje y crear atmósfera.
* Detalle: Texturas ricas y composición profunda.
* Tonos: Paleta de colores consistente que refleje el estado de ánimo exacto del momento.
* Intensidad Emocional: Expresiones faciales de los personajes que capturen con precisión la emoción requerida (miedo palpable, alegría desbordante, profunda melancolía).

⚙️ Especificaciones Técnicas

* Técnica: Fotografía Cinematográfica (lentes *anamórficos*), Pintura Digital, o Estilo 3D Fotorrealista (especificar).
* Resolución: 8K (ultra detallado).
* Detalle: Extremadamente detallado, hiperrealista, con enfoque en la textura de la piel, ropa y entorno.
* Ánimo: Estado de ánimo cinematográfico y atmósfera visualmente consistente en todos los fotogramas, manteniendo la cohesión.

PIDE EN CADA PROMPT QUE EN MEDIDA DE LO POSIBLE, EN TODAS LAS ESCENAS UTILICE EL ASUNTO, ESCENA Y ESTILO. 

TAMBIEN ES DEMASIADO IMPORTANTE QUE NO DES INSTRUCCIONES REFERENTES A GENERACION DE TITULOS O TEXTOS EN ESTAS ESCENAS, ES DECIR No coloques texto, REEMPLAZA TEXTO POR solo iconos referentes o emojis etc`;

// ============================================
// UTILIDADES DE IMAGEN (OPTIMIZACIÓN DE MEMORIA)
// ============================================

/**
 * Convierte Base64 legacy a Blob eficiente.
 * Vital para la migración de datos antiguos.
 */
function base64ToBlob(base64Data) {
    if (!base64Data || typeof base64Data !== 'string' || !base64Data.startsWith('data:')) return null;
    try {
        const parts = base64Data.split(',');
        const mime = parts[0].match(/:(.*?);/)[1];
        const bstr = atob(parts[1]); 
        let n = bstr.length; 
        const u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], {type: mime});
    } catch (e) {
        console.error("Error convirtiendo imagen:", e);
        return null;
    }
}

/**
 * Genera una URL temporal para mostrar la imagen.
 * Implementa Lazy Loading nativo del navegador.
 */
function getImageUrl(imageSource) {
    if (!imageSource) return null;
    // Si ya es un Blob/File (Nuevo sistema)
    if (imageSource instanceof Blob || imageSource instanceof File) {
        return URL.createObjectURL(imageSource);
    }
    // Si es string (Legacy o URL externa)
    return imageSource; 
}

// ============================================
// SISTEMA DE INICIALIZACIÓN Y MIGRACIÓN
// ============================================

// ============================================
// CARGA INICIAL (HYDRATION)
// ============================================

async function initializeData() {
    try {
        // 1. Verificar migración una única vez
        // Solo migramos si existen scripts en LocalStorage Y la base de datos está vacía
        // para evitar sobrescribir datos buenos de DB con datos malos de LocalStorage.
        const dbCount = await db.scripts.count();
        const localScripts = localStorage.getItem('scripts');
        
        if (localScripts && dbCount === 0) {
            console.log("📦 Migrando datos antiguos a Base de Datos segura...");
            await migrateFromLocalStorage();
        } else if (localScripts && dbCount > 0) {
            // Si ya tenemos datos en DB, limpiamos el LocalStorage para evitar conflictos futuros
            console.log("🧹 Limpiando LocalStorage redundante...");
            localStorage.removeItem('scripts');
            localStorage.removeItem('categories');
        }

        // 2. Hydration: Cargar Datos Reales (Con Imágenes/Blobs) desde IndexedDB
        scripts = await db.scripts.toArray();
        categories = await db.categories.toArray();
        
        // 3. Cargar Configuración (Esta sí viene de LocalStorage o DB Settings)
        // Intentamos cargar de LocalStorage primero para config ligera
        const localConfig = localStorage.getItem('config');
        if (localConfig) {
            config = JSON.parse(localConfig);
        }
        
        const localFilters = localStorage.getItem('wordFilters');
        if (localFilters) {
            wordFilters = JSON.parse(localFilters);
        }

        // 4. Defaults para instalación limpia
        if (categories.length === 0) {
            const defaultCat = { 
                name: 'General', 
                path: '', 
                exportPath: '',
                contentType: 'short',
                promptTemplate: DEFAULT_PROMPT_TEMPLATE,
                visualReferences: { asunto: null, escena: null, estilo: null }
            };
            // Guardamos el default en DB inmediatamente
            await db.categories.add(defaultCat);
            categories.push(defaultCat);
        }

        console.log(`✅ Sistema inicializado: ${categories.length} categorías, ${scripts.length} guiones.`);
        updateUI();

    } catch (error) {
        console.error("❌ Fallo crítico en inicialización:", error);
        alert("Error cargando la base de datos. Tus datos están seguros en IndexedDB, pero hubo un error de lectura.");
    }
}

async function migrateFromLocalStorage() {
    // Lectura de datos legacy
    const rawScripts = JSON.parse(localStorage.getItem('scripts') || '[]');
    const rawCategories = JSON.parse(localStorage.getItem('categories') || '[]');
    const rawConfig = JSON.parse(localStorage.getItem('config') || 'null');
    const rawFilters = JSON.parse(localStorage.getItem('wordFilters') || '[]');

    // Transacción atómica: Todo se guarda o nada se guarda
    await db.transaction('rw', db.scripts, db.categories, db.settings, async () => {
        
        // A. Migrar Categorías (y optimizar imágenes)
        for (const cat of rawCategories) {
            // Manejo de compatibilidad para strings simples antiguos
            if (typeof cat === 'string') {
                await db.categories.put({
                    name: cat,
                    path: '',
                    exportPath: '',
                    contentType: 'short',
                    promptTemplate: DEFAULT_PROMPT_TEMPLATE,
                    visualReferences: { asunto: null, escena: null, estilo: null }
                });
                continue;
            }

            // Conversión Base64 -> Blob (Ahorro de ~30% espacio y +Rendimiento)
            const visuals = cat.visualReferences || {};
            const migratedVisuals = {
                asunto: base64ToBlob(visuals.asunto),
                escena: base64ToBlob(visuals.escena),
                estilo: base64ToBlob(visuals.estilo)
            };

            await db.categories.put({
                ...cat,
                exportPath: cat.exportPath || '', // Asegurar campo nuevo
                contentType: cat.contentType || 'short',
                promptTemplate: cat.promptTemplate || DEFAULT_PROMPT_TEMPLATE,
                visualReferences: migratedVisuals
            });
        }

        // B. Migrar Guiones
        for (const script of rawScripts) {
            const customVis = script.customVisuals || {};
            const migratedCustom = {
                asunto: base64ToBlob(customVis.asunto),
                escena: base64ToBlob(customVis.escena),
                estilo: base64ToBlob(customVis.estilo)
            };
            
            // Limpieza de objetos vacíos
            if (!migratedCustom.asunto && !migratedCustom.escena && !migratedCustom.estilo) {
                delete script.customVisuals;
            } else {
                script.customVisuals = migratedCustom;
            }

            await db.scripts.put(script);
        }

        // C. Migrar Configuración
        if (rawConfig) await db.settings.put({ key: 'config', value: rawConfig });
        if (rawFilters) await db.settings.put({ key: 'wordFilters', value: rawFilters });
    });

    // Limpieza de LocalStorage para liberar cuota del navegador
    localStorage.removeItem('scripts');
    localStorage.removeItem('categories');
    localStorage.removeItem('config');
    localStorage.removeItem('wordFilters');
    console.log("🧹 Migración completada. LocalStorage limpiado.");
}

// ============================================
// FUNCIONES DE BÚSQUEDA UI
// ============================================

function handleCategorySearch() {
    const searchInput = document.getElementById('categorySearchInput');
    const clearBtn = document.getElementById('categorySearchClear');
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (searchTerm) {
        clearBtn.style.display = 'flex';
    } else {
        clearBtn.style.display = 'none';
    }
    
    filterCategoriesDisplay(searchTerm);
}

function clearCategorySearch() {
    const searchInput = document.getElementById('categorySearchInput');
    const clearBtn = document.getElementById('categorySearchClear');
    
    searchInput.value = '';
    clearBtn.style.display = 'none';
    searchInput.focus();
    
    filterCategoriesDisplay('');
}

function filterCategoriesDisplay(searchTerm) {
    const categoryList = document.getElementById('categoryList');
    const categoryItems = categoryList.querySelectorAll('.category-item');
    let visibleCount = 0;
    let hasAllCategory = false;
    
    categoryItems.forEach((item, index) => {
        if (index === 0) {
            hasAllCategory = true;
            if (searchTerm) {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.classList.remove('hidden');
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            } else {
                item.classList.remove('hidden');
                visibleCount++;
            }
            return;
        }
        
        const categoryContent = item.querySelector('.category-item-content span');
        if (categoryContent) {
            const categoryText = categoryContent.textContent.toLowerCase();
            
            if (!searchTerm || categoryText.includes(searchTerm)) {
                item.classList.remove('hidden');
                visibleCount++;
            } else {
                item.classList.add('hidden');
            }
        }
    });
    
    let noResultsMsg = categoryList.querySelector('.category-no-results');
    
    if (visibleCount === 0 || (visibleCount === 1 && hasAllCategory && searchTerm)) {
        if (!noResultsMsg) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.className = 'category-no-results';
            categoryList.appendChild(noResultsMsg);
        }
        noResultsMsg.textContent = 'No se encontraron categorías';
        noResultsMsg.style.display = 'block';
    } else {
        if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
        }
    }
}

/**
 * Guarda SOLO la configuración global.
 * Nota: Los guiones y categorías ahora se guardan individualmente en la DB
 * en sus respectivas funciones (addScript, addCategory, etc).
 * Mantenemos esta función para guardar preferencias de filtros y config.
 */
async function saveData() {
    try {
        await db.settings.put({ key: 'config', value: config });
        await db.settings.put({ key: 'wordFilters', value: wordFilters });
        // No guardamos scripts/categories aquí para evitar overhead masivo.
    } catch (e) {
        console.error("Error guardando configuración:", e);
    }
}
        // NUEVAS FUNCIONES: Búsqueda de categorías
function handleCategorySearch() {
    const searchInput = document.getElementById('categorySearchInput');
    const clearBtn = document.getElementById('categorySearchClear');
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    // Mostrar/ocultar botón de limpiar
    if (searchTerm) {
        clearBtn.style.display = 'flex';
    } else {
        clearBtn.style.display = 'none';
    }
    
    filterCategoriesDisplay(searchTerm);
}

function clearCategorySearch() {
    const searchInput = document.getElementById('categorySearchInput');
    const clearBtn = document.getElementById('categorySearchClear');
    
    searchInput.value = '';
    clearBtn.style.display = 'none';
    searchInput.focus();
    
    filterCategoriesDisplay('');
}

function filterCategoriesDisplay(searchTerm) {
    const categoryList = document.getElementById('categoryList');
    const categoryItems = categoryList.querySelectorAll('.category-item');
    let visibleCount = 0;
    let hasAllCategory = false;
    
    categoryItems.forEach((item, index) => {
        // La primera categoría es "Todos los guiones" - siempre visible si no hay búsqueda
        if (index === 0) {
            hasAllCategory = true;
            if (searchTerm) {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.classList.remove('hidden');
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            } else {
                item.classList.remove('hidden');
                visibleCount++;
            }
            return;
        }
        
        // Resto de categorías
        const categoryContent = item.querySelector('.category-item-content span');
        if (categoryContent) {
            const categoryText = categoryContent.textContent.toLowerCase();
            
            if (!searchTerm || categoryText.includes(searchTerm)) {
                item.classList.remove('hidden');
                visibleCount++;
            } else {
                item.classList.add('hidden');
            }
        }
    });
    
    // Mostrar mensaje si no hay resultados
    let noResultsMsg = categoryList.querySelector('.category-no-results');
    
    if (visibleCount === 0 || (visibleCount === 1 && hasAllCategory && searchTerm)) {
        if (!noResultsMsg) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.className = 'category-no-results';
            categoryList.appendChild(noResultsMsg);
        }
        noResultsMsg.textContent = 'No se encontraron categorías';
        noResultsMsg.style.display = 'block';
    } else {
        if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
        }
    }
}

/**
 * GUARDA SOLO CONFIGURACIÓN LIGERA.
 * Los Scripts y Categorías (imágenes) se guardan automáticamente 
 * en IndexedDB (db.put/db.add) en sus respectivas funciones.
 * NO guardar scripts/categories aquí para evitar serialización destructiva de Blobs.
 */
function saveData() {
    // Solo guardamos preferencias de usuario y filtros en LocalStorage
    // para mantener la persistencia ligera y rápida.
    localStorage.setItem('config', JSON.stringify(config));
    localStorage.setItem('wordFilters', JSON.stringify(wordFilters));
}

// ============================================
// FUNCIONES DE CÁLCULO DE ESCENAS
// ============================================

function getFormulaForCategory(categoryName) {
    const category = categories.find(cat => cat.name === categoryName);
    const contentType = category ? category.contentType : 'short'; // Por defecto 'short'
    return config.formulas[contentType] || config.formulas.short;
}

function calculateScenes(content, categoryName) {
    const formula = getFormulaForCategory(categoryName);
    const totalCharacters = content.length;
    const scenes = Math.round(totalCharacters / formula.charactersPerScene);
    return scenes > 0 ? scenes : 1;
}

function calculateDuration(scenes, categoryName) {
    const formula = getFormulaForCategory(categoryName);
    return scenes * formula.secondsPerScene;
}

function formatDuration(seconds) {
    if (seconds < 60) {
        return `${seconds}s`;
    }
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`;
}

function resolvePromptTemplate(template, scenes) {
    return template.replace(/\(X\)/g, scenes);
}

// ============================================
// FIN DE FUNCIONES DE CÁLCULO
// ============================================

        function toggleCategoryInput() {
            const input = document.getElementById('categoryInput');
            input.classList.toggle('active');
            if (input.classList.contains('active')) {
                document.getElementById('newCategoryInput').focus();
            } else {
                document.getElementById('newCategoryInput').value = '';
                document.getElementById('newCategoryPath').value = '';
                document.getElementById('newCategoryExportPath').value = '';
                // ✅ NUEVO: Limpiar también el campo de prompt
                const promptInput = document.getElementById('newCategoryPrompt');
                if (promptInput) promptInput.value = '';
            }
        }

// ✨ Variable global para referencias temporales de nueva categoría
let tempNewCategoryReferences = {
    asunto: null,
    escena: null,
    estilo: null
};

function addCategory() {
    const nameInput = document.getElementById('newCategoryInput');
    const pathInput = document.getElementById('newCategoryPath');
    const exportPathInput = document.getElementById('newCategoryExportPath');
    const promptInput = document.getElementById('newCategoryPrompt');
    
    const categoryName = nameInput.value.trim();
    const categoryPath = pathInput.value.trim();
    // ✨ MODIFICACIÓN: Si el campo está vacío, se asigna 'Descargas'.
    const categoryExportPath = exportPathInput.value.trim() || 'Descargas';
    
    const categoryPrompt = (promptInput && promptInput.value.trim()) 
        ? promptInput.value.trim() 
        : DEFAULT_PROMPT_TEMPLATE;
        
    if (!categoryName) {
        alert('Por favor, ingresa un nombre para la categoría');
        return;
    }
    
    // ✨ ELIMINADO: Se elimina el bloque de validación para la ruta de exportación.
    
    if (categories.some(cat => cat.name === categoryName)) {
        alert('Ya existe una categoría con ese nombre');
        return;
    }
    
// Obtener tipo de contenido seleccionado
    const selectedType = document.querySelector('#newCategoryTypeSelector .active').dataset.type;

    // Crear el objeto de la nueva categoría
    const newCategory = {
        name: categoryName,
        path: categoryPath || '',
        exportPath: categoryExportPath,
        contentType: selectedType,
        promptTemplate: categoryPrompt,
        visualReferences: {
            // Aquí guardamos los ARCHIVOS (Blobs) directamente, no base64
            asunto: tempNewCategoryReferences.asunto,
            escena: tempNewCategoryReferences.escena,
            estilo: tempNewCategoryReferences.estilo
        }
    };

// 1. Guardar en Base de Datos (FUENTE DE LA VERDAD)
    // Guardamos primero en DB para asegurar que los Blobs se persistan
    db.categories.put(newCategory).then(() => {
        // 2. Actualizar estado local
        categories.push(newCategory);
        
        // 3. Limpieza y UI
        tempNewCategoryReferences = { asunto: null, escena: null, estilo: null };
        
        // Resetear inputs visuales
        ['asunto', 'escena', 'estilo'].forEach(type => {
            const input = document.getElementById(`newInput${capitalize(type)}`);
            const label = document.getElementById(`newLabel${capitalize(type)}`);
            const btn = document.getElementById(`newBtnRemove${capitalize(type)}`);
            
            if (input) input.value = '';
            if (label) {
                label.textContent = capitalize(type);
                label.parentElement.style.borderColor = '#d1d5db';
                label.parentElement.style.borderStyle = 'dashed';
                label.parentElement.style.background = 'white';
            }
            if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
        });
        
        saveData(); // Guarda configs
        updateUI();
        
        // Limpiar formulario
        nameInput.value = '';
        pathInput.value = '';
        exportPathInput.value = '';
        if(promptInput) promptInput.value = '';
        toggleCategoryInput();

    }).catch(e => {
        console.error("Error crítico guardando categoría:", e);
        alert("Error: No se pudo guardar la imagen en la base de datos.");
    });

    // Resetear inputs de archivo visuales
    ['asunto', 'escena', 'estilo'].forEach(type => {
        const input = document.getElementById(`newInput${capitalize(type)}`);
        const label = document.getElementById(`newLabel${capitalize(type)}`);
        const btn = document.getElementById(`newBtnRemove${capitalize(type)}`);
        
        if (input) input.value = '';
        if (label) {
            label.textContent = capitalize(type);
            label.parentElement.style.borderColor = '#d1d5db';
            label.parentElement.style.borderStyle = 'dashed';
            label.parentElement.style.background = 'white';
        }
        if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
    });
    
    saveData();
    updateUI();
    nameInput.value = '';
    pathInput.value = '';
    exportPathInput.value = '';
    promptInput.value = '';
    toggleCategoryInput();
}

// ============================================
// HELPERS PARA IMÁGENES (OPTIMIZACIÓN BLOB)
// ============================================

function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

/**
 * Función maestra para manejar subidas de imágenes.
 * Guarda el archivo crudo (File/Blob) y genera una vista previa ligera.
 */
function handleReferenceUploadGeneric(type, event, targetObject) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        alert('Por favor, selecciona un archivo de imagen válido');
        return;
    }

    // Guardamos el Archivo directamente en la variable temporal
    targetObject[type] = file;

    // Lógica para actualizar la UI según dónde estemos
    let previewId, labelId, btnId;
    
    // CASO 1: Nueva Categoría (Sidebar)
    if (targetObject === tempNewCategoryReferences) {
        labelId = `newLabel${capitalize(type)}`;
        btnId = `newBtnRemove${capitalize(type)}`;
        
        const label = document.getElementById(labelId);
        const btn = document.getElementById(btnId);
        if (label) {
            label.textContent = `✓ ${capitalize(type)}`;
            label.parentElement.style.borderColor = '#8b5cf6';
            label.parentElement.style.borderStyle = 'solid';
            label.parentElement.style.background = '#f5f3ff';
        }
        if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
        
    } else {
        // CASO 2 y 3: Editar Categoría o Editar Guión (Modales)
        if (targetObject === tempCustomVisuals) {
            previewId = `editScriptPreview${capitalize(type)}`;
            btnId = `editScriptBtnRemove${capitalize(type)}`;
        } else {
            previewId = `preview${capitalize(type)}`;
            btnId = `btnRemove${capitalize(type)}`;
        }

        const preview = document.getElementById(previewId);
        const btnRemove = document.getElementById(btnId);
        
        if (preview) {
            // Creamos una URL temporal solo para visualizar
            const url = URL.createObjectURL(file);
            preview.innerHTML = `<img src="${url}" alt="Referencia ${type}" onload="URL.revokeObjectURL(this.src)">`; 
            preview.classList.add('has-image');
            preview.classList.remove('fallback-preview');
        }
        if (btnRemove) btnRemove.disabled = false;
    }
}

// ✨ Función para manejar subida de referencias en nueva categoría
// ✨ Función optimizada para manejar subida de referencias en nueva categoría
function handleNewReferenceUpload(type, event) {
    handleReferenceUploadGeneric(type, event, tempNewCategoryReferences);
}

// ✨ Función para eliminar referencias en nueva categoría
function removeNewReference(type) {
    tempNewCategoryReferences[type] = null;
    
    const input = document.getElementById(`newInput${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const label = document.getElementById(`newLabel${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const btn = document.getElementById(`newBtnRemove${type.charAt(0).toUpperCase() + type.slice(1)}`);
    
    if (input) input.value = '';
    if (label) {
        label.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        label.parentElement.style.borderColor = '#d1d5db';
        label.parentElement.style.borderStyle = 'dashed';
        label.parentElement.style.background = 'white';
    }
    if (btn) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
    }
}
        function openEditCategoryModal(categoryName) {
            const category = categories.find(cat => cat.name === categoryName);
            if (!category) return;

            // Mostrar información actual
            document.getElementById('editCurrentCategoryName').textContent = category.name;
            document.getElementById('editCategoryOriginalName').value = category.name;
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryPath').value = category.path || '';
            document.getElementById('editCategoryExportPath').value = category.exportPath || '';
            document.getElementById('editCategoryPrompt').value = category.promptTemplate || 'Genera (X) prompts de imágenes para el siguiente guion';

            // Contar scripts afectados
            const affectedCount = scripts.filter(s => s.category === categoryName).length;
            const warningBox = document.getElementById('editWarningBox');
            const affectedCountEl = document.getElementById('affectedScriptsCount');
            
            if (affectedCount > 0) {
                affectedCountEl.textContent = affectedCount;
                warningBox.style.display = 'flex';
            } else {
                warningBox.style.display = 'none';
            }

// Establecer el tipo de contenido actual
            const typeSelector = document.getElementById('editCategoryTypeSelector');
            typeSelector.querySelectorAll('.filter-option').forEach(btn => btn.classList.remove('active'));
            const currentTypeButton = typeSelector.querySelector(`[data-type="${category.contentType || 'short'}"]`);
            if (currentTypeButton) currentTypeButton.classList.add('active');

            // Cargar referencias visuales existentes
            loadVisualReferences(category.visualReferences || { asunto: null, escena: null, estilo: null });
            document.getElementById('editCategoryModal').classList.add('active');
            document.getElementById('editCategoryName').focus();
        }

// ============================================
// PERSISTENCIA DE CATEGORÍAS (FIX SAVE)
// ============================================

async function saveEditCategory(event) {
    event.preventDefault();
    
    const originalName = document.getElementById('editCategoryOriginalName').value;
    const newName = document.getElementById('editCategoryName').value.trim();
    const newPath = document.getElementById('editCategoryPath').value.trim();
    const newExportPath = document.getElementById('editCategoryExportPath').value.trim();
    const newPrompt = document.getElementById('editCategoryPrompt').value.trim() || DEFAULT_PROMPT_TEMPLATE;
    const newContentType = document.querySelector('#editCategoryTypeSelector .active').dataset.type;

    if (!newName) {
        alert('Por favor, ingresa un nombre para la categoría');
        return;
    }
    
    if (!newExportPath) {
        alert('Por favor, ingresa la ruta de exportación del video (campo obligatorio)');
        document.getElementById('editCategoryExportPath').focus();
        return;
    }

    // Validación de duplicados
    if (newName !== originalName && categories.some(cat => cat.name === newName)) {
        alert('Ya existe una categoría con ese nombre');
        return;
    }

    try {
        // 1. Preparar el objeto actualizado con los Blobs de imagen
        const updatedCategory = {
            name: newName, // PK
            path: newPath,
            exportPath: newExportPath,
            contentType: newContentType,
            promptTemplate: newPrompt,
            visualReferences: {
                // Usamos las referencias temporales que contienen los Blobs/Files
                asunto: tempVisualReferences.asunto,
                escena: tempVisualReferences.escena,
                estilo: tempVisualReferences.estilo
            }
        };

        // 2. Transacción de Base de Datos (Atomicidad)
        await db.transaction('rw', db.categories, db.scripts, async () => {
            
            // Si el nombre cambió, debemos migrar los datos y borrar la entrada vieja
            if (originalName !== newName) {
                // A. Borrar categoría antigua
                await db.categories.delete(originalName);
                
                // B. Actualizar todos los guiones huérfanos
                const relatedScripts = await db.scripts.where('category').equals(originalName).toArray();
                for (const script of relatedScripts) {
                    script.category = newName;
                    await db.scripts.put(script);
                }
            }

            // C. Guardar la categoría actualizada (Insertar o Sobrescribir)
            await db.categories.put(updatedCategory);
        });

// 3. Sincronización de Estado en Memoria
        // IMPORTANTE: Reemplazar el objeto en memoria con el que tiene los Blobs actualizados
        const catIndex = categories.findIndex(c => c.name === originalName);
        if (catIndex !== -1) {
            // Si cambiamos el nombre, hay que manejar la referencia en el array
            if (originalName !== newName) {
                // Eliminamos la vieja y ponemos la nueva para evitar duplicados en UI
                categories.splice(catIndex, 1, updatedCategory);
            } else {
                categories[catIndex] = updatedCategory;
            }
        }

        // Actualizar referencias en scripts en memoria si cambió el nombre
        if (originalName !== newName) {
            scripts.forEach(s => {
                if (s.category === originalName) s.category = newName;
            });
            if (currentFilter === originalName) currentFilter = newName;
        }

        // 4. Finalizar
        saveData(); // Guarda solo configuración
        updateUI();
        closeModal('editCategoryModal');
        
        // Limpiar temporales para liberar memoria
        tempVisualReferences = { asunto: null, escena: null, estilo: null };
        
    } catch (err) {
        console.error("Error crítico guardando categoría:", err);
        alert("Hubo un error al guardar en la base de datos. Revisa la consola.");
    }
}

// DESPUÉS (Código nuevo y mejorado)
function openEditScriptModal() {
    if (currentViewIndex < 0 || !filteredScripts[currentViewIndex]) return;

    const script = filteredScripts[currentViewIndex];
    const originalScript = scripts.find(s => s.id === script.id);
    if (!originalScript) return;

    // Llenar formulario básico
    document.getElementById('editCurrentScriptTitle').textContent = originalScript.title;
    document.getElementById('editScriptId').value = originalScript.id;
    document.getElementById('editScriptTitle').value = originalScript.title;
    document.getElementById('editScriptContent').value = originalScript.content;

    // Actualizar y establecer categoría
    updateEditScriptCategorySelect();
    document.getElementById('editScriptCategory').value = originalScript.category;

    // === INICIO CÓDIGO NUEVO ===
    // Cargar referencias visuales personalizadas
    const category = categories.find(cat => cat.name === originalScript.category) || {};
    loadCustomVisualsEditor(originalScript.customVisuals, category.visualReferences);
    // === FIN CÓDIGO NUEVO ===

    // Abrir modal
    closeModal('viewModal');
    document.getElementById('editScriptModal').classList.add('active');
    document.getElementById('editScriptTitle').focus();
}

        function updateEditScriptCategorySelect() {
            const select = document.getElementById('editScriptCategory');
            select.innerHTML = '';
            
            // Agregar opción "Sin categoría"
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Sin categoría';
            emptyOption.style.color = '#a3a3a3';
            select.appendChild(emptyOption);
            
            // Agregar todas las categorías disponibles
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = 'General';
                option.textContent = 'General';
                select.appendChild(option);
            } else {
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            }
        }

// DESPUÉS (Código nuevo y mejorado)
function saveEditScript(event) {
    event.preventDefault();
    
    const scriptId = parseInt(document.getElementById('editScriptId').value);
    const title = document.getElementById('editScriptTitle').value.trim();
    let category = document.getElementById('editScriptCategory').value.trim();
    const content = document.getElementById('editScriptContent').value.trim();
    
    if (!title) {
        alert('Por favor, ingresa un título para el guión');
        return;
    }
    
    if (!category) {
        category = 'General';
        if (!categories.some(cat => cat.name === 'General')) {
            categories.push({ name: 'General', path: '' });
        }
    }
    
    const scriptIndex = scripts.findIndex(s => s.id === scriptId);
        if (scriptIndex !== -1) {
        const processedContent = processTextReplacement(content, category);

        // 1. Actualizar objeto en memoria RAM
        const scriptToUpdate = scripts[scriptIndex];
        
        scriptToUpdate.title = title;
        scriptToUpdate.category = category;
        scriptToUpdate.content = processedContent;
        scriptToUpdate.updatedAt = new Date().toISOString();

        // Gestión de imágenes custom (ahora son Blobs/Files)
        const hasCustomVisuals = Object.values(tempCustomVisuals).some(val => val !== null);
        if (hasCustomVisuals) {
            scriptToUpdate.customVisuals = tempCustomVisuals;
        } else {
            delete scriptToUpdate.customVisuals;
        }

        // 2. Actualizar en Base de Datos
        db.scripts.put(scriptToUpdate).then(() => {
            saveData(); // Guardar config global
            updateUI();
            closeModal('editScriptModal');
            alert('¡Guión actualizado exitosamente!');
        }).catch(err => {
            console.error(err);
            alert("Error al actualizar el guión en la base de datos.");
        });
    }
}

        function deleteCategory(categoryName) {
            const scriptsInCategory = scripts.filter(s => s.category === categoryName).length;
            
            let message = `Se eliminará permanentemente la categoría "${categoryName}".`;
            if (scriptsInCategory > 0) {
                message += ` Los ${scriptsInCategory} guion(es) asociado(s) se moverán a "General".`;
            }

            showConfirmDialog(
                '¿Eliminar categoría?',
                message,
                () => {
                    // Mover scripts a General
                    if (scriptsInCategory > 0) {
                        // Asegurarse de que existe la categoría General
                        if (!categories.some(cat => cat.name === 'General')) {
                            categories.push({ name: 'General', path: '' });
                        }

                        scripts.forEach(script => {
                            if (script.category === categoryName) {
                                script.category = 'General';
                            }
                        });
                    }

                    // Eliminar la categoría
                    categories = categories.filter(cat => cat.name !== categoryName);

                    // Si estábamos viendo esta categoría, volver a "all"
                    if (currentFilter === categoryName) {
                        currentFilter = 'all';
                    }

                    saveData();
                    updateUI();
                }
            );
        }

function filterCategory(category) {
            currentFilter = category;
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Buscar el elemento correcto para agregar la clase active
            const categoryItems = document.querySelectorAll('.category-item');
            categoryItems.forEach(item => {
                const content = item.querySelector('.category-item-content span');
                if (content && content.textContent.includes(category)) {
                    item.classList.add('active');
                } else if (category === 'all' && content && content.textContent.includes('Todos los guiones')) {
                    item.classList.add('active');
                }
            });
            
            if (category === 'all') {
                document.getElementById('mainTitle').textContent = 'Todos los guiones';
            } else {
                document.getElementById('mainTitle').textContent = category;
            }
            
            renderScripts();

            // Actualizar botones de acción rápida
            updateQuickActionButtons();
        }

function openAddModal() {
    updateCategorySelect();
    updateBulkCategorySelect();
    
    // Limpiar formulario individual
    document.getElementById('scriptContent').value = '';
    
    // Si hay una categoría seleccionada y no es "all"
    if (currentFilter !== 'all') {
        // Establecer el título automáticamente con el nombre de la categoría
        document.getElementById('scriptTitle').value = currentFilter;
        
        // Establecer la categoría seleccionada automáticamente
        document.getElementById('scriptCategory').value = currentFilter;
        document.getElementById('bulkCategory').value = currentFilter;
    } else {
        // Si está en "Todos los guiones", dejar el título vacío
        document.getElementById('scriptTitle').value = '';
        
        // Establecer el select en el estado "sin categoría"
        document.getElementById('scriptCategory').value = '';
        document.getElementById('bulkCategory').value = 'General';
    }
    
    // Limpiar campos de carga masiva
    document.getElementById('bulkScriptContent').value = '';
    resetBulkFileInput();
    
    // Activar la primera pestaña por defecto
    switchTab('single');
    
    document.getElementById('addModal').classList.add('active');
}

function switchTab(tabName) {
    // Actualizar botones de pestañas
    const tabs = document.querySelectorAll('.tab-button');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    if (tabName === 'single') {
        document.getElementById('tabSingle').classList.add('active');
    } else {
        document.getElementById('tabBulk').classList.add('active');
    }
    
    // Actualizar contenido de pestañas
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => content.classList.remove('active'));
    
    if (tabName === 'single') {
        document.getElementById('contentSingle').classList.add('active');
    } else {
        document.getElementById('contentBulk').classList.add('active');
    }
}

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

function updateCategorySelect() {
    const select = document.getElementById('scriptCategory');
    select.innerHTML = '';
    
    // Agregar opción "Sin categoría" al inicio
    const emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.textContent = 'Sin categoría';
    emptyOption.style.color = '#a3a3a3';
    select.appendChild(emptyOption);
    
    // Agregar todas las categorías disponibles
    if (categories.length === 0) {
        const option = document.createElement('option');
        option.value = 'General';
        option.textContent = 'General';
        select.appendChild(option);
    } else {
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    }
}

function updateBulkCategorySelect() {
    const select = document.getElementById('bulkCategory');
    select.innerHTML = '';
    
    // Agregar todas las categorías disponibles
    if (categories.length === 0) {
        const option = document.createElement('option');
        option.value = 'General';
        option.textContent = 'General';
        select.appendChild(option);
    } else {
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    }
}

function saveScript(event) {
    event.preventDefault();
    
    const title = document.getElementById('scriptTitle').value.trim();
    let category = document.getElementById('scriptCategory').value.trim();
    const content = document.getElementById('scriptContent').value.trim();
    
    // Validar que el título no esté vacío
    if (!title) {
        alert('Por favor, ingresa un título para el guión');
        return;
    }
    
// Si no hay categoría seleccionada, asignar "General"
    if (!category) {
        category = 'General';
        if (!categories.some(cat => cat.name === 'General')) {
            categories.push({ name: 'General', path: '' });
        }
    }

    // --- APLICAR FILTROS ---
    // Reemplazamos el contenido original por el procesado
    const processedContent = processTextReplacement(content, category);
    // -----------------------
    
const newScript = {
        id: Date.now(),
        title,
        category,
        content: processedContent,
        used: false,
        createdAt: new Date().toISOString(),
        // Nota: Si en el futuro agregas imágenes al crear guion, irían aquí
    };
    
    // 1. Actualizar memoria
    scripts.push(newScript);
    
    // 2. Guardar en DB
    db.scripts.add(newScript).then(() => {
        // Solo actualizamos UI y cerramos si la DB confirmó el guardado
        saveData(); // Guardamos configuración global por si acaso
        updateUI();
        closeModal('addModal');
    }).catch(e => {
        console.error(e);
        alert("Error crítico: No se pudo guardar el guión en la base de datos.");
    });
}

        function deleteCurrentScript() {
            if (currentViewIndex >= 0 && filteredScripts[currentViewIndex]) {
                const script = filteredScripts[currentViewIndex];
                showConfirmDialog(
                    '¿Eliminar este guión?',
                    `Se eliminará permanentemente "${script.title}"`,
                    () => {
                        scripts = scripts.filter(s => s.id !== script.id);
                        saveData();
                        closeModal('viewModal');
                        updateUI();
                    }
                );
            }
        }

        function viewScript(id) {
            const script = scripts.find(s => s.id === id);
            if (script) {
                filteredScripts = getFilteredScripts();
                currentViewIndex = filteredScripts.findIndex(s => s.id === id);
                
                // Información básica
                document.getElementById('viewTitle').textContent = script.title;
                document.getElementById('viewCategory').textContent = script.category;
                document.getElementById('viewContent').textContent = script.content;
                document.getElementById('viewDate').textContent = `Creado: ${formatDate(script.createdAt)}`;
                
                // NUEVO: Calcular escenas y duración
const scenes = calculateScenes(script.content, script.category);
const duration = calculateDuration(scenes, script.category);
                const totalSeconds = duration;
                
                document.getElementById('viewScenes').textContent = scenes;
                document.getElementById('viewCharCount').textContent = script.content.length;
                document.getElementById('viewDuration').textContent = formatDuration(duration);
                document.getElementById('viewSecondsTotal').textContent = totalSeconds;
                
// Mostrar ruta de la categoría (Clips)
const category = categories.find(cat => cat.name === script.category);
const pathContainer = document.getElementById('categoryPathContainer');
const pathText = document.getElementById('categoryPath');
const btnCopyPath = pathContainer.querySelector('.btn-copy-path');

if (category && category.path) {
    pathText.textContent = category.path;
    // CORRECCIÓN: Guardar la ruta completa en el atributo del texto
    pathText.setAttribute('data-full-path', category.path);
    // El botón ya tiene data-shortcut en el HTML, no necesita modificación aquí
    pathContainer.style.display = 'flex';
} else {
    pathContainer.style.display = 'none';
}

            // Mostrar ruta de exportación del video
            const exportPathContainer = document.getElementById('categoryExportPathContainer');
            const exportPathText = document.getElementById('categoryExportPath');
            const btnCopyExportPath = exportPathContainer.querySelector('.btn-copy-export-path');

if (category && category.exportPath) {
    exportPathText.textContent = category.exportPath;
    exportPathText.setAttribute('data-full-path', category.exportPath);
    exportPathContainer.style.display = 'flex';
} else {
    exportPathContainer.style.display = 'none';
}
                
// NUEVO: Mostrar prompt resuelto (solo botón con tooltip)
const promptContainer = document.getElementById('promptContainer');
const promptText = document.getElementById('promptText');
const promptButton = promptContainer.querySelector('.btn-copy-prompt-clean');

if (category && category.promptTemplate) {
    const resolvedPrompt = resolvePromptTemplate(category.promptTemplate, scenes);
    promptText.textContent = resolvedPrompt;
    
    // Establecer el tooltip con el prompt resuelto
    if (promptButton) {
        promptButton.setAttribute('data-tooltip', resolvedPrompt);
    }
    
    promptContainer.style.display = 'block';
} else {
    promptContainer.style.display = 'none';
}

                updateMarkUsedButton(script.used);
                document.getElementById('viewModal').classList.add('active');
            }
        }

// ============================================
// FUNCIONES DE COPIA CORREGIDAS
// ============================================

// ✨ NUEVO: Función auxiliar para generar ID único basado en tiempo
function generateTimeBasedID() {
    const now = new Date();
    const YYYY = now.getFullYear();
    const MM = String(now.getMonth() + 1).padStart(2, '0');
    const DD = String(now.getDate()).padStart(2, '0');
    const HH = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    const ms = String(now.getMilliseconds()).padStart(3, '0');
    
    // Formato: 20231128_153022_123
    return `${YYYY}${MM}${DD}_${HH}${mm}${ss}_${ms}`;
}

function copyScriptTitle() {
    const titleElement = document.getElementById('viewTitle');
    
    if (!titleElement) {
        console.error('❌ No se encontró el elemento viewTitle');
        alert('No se encontró el título del guion');
        return;
    }
    
    // Obtener el título visual actual
    const originalTitle = titleElement.textContent.trim();
    
    if (!originalTitle || originalTitle.length === 0) {
        alert('El título está vacío');
        return;
    }

    // --- LÓGICA INTELIGENTE DE DETECCIÓN DE TÍTULO ---
    let textToCopy = originalTitle;
    let isGeneratedID = false;

    // Obtenemos el script actual desde la memoria para comparar con su categoría
    if (currentViewIndex >= 0 && filteredScripts[currentViewIndex]) {
        const currentScript = filteredScripts[currentViewIndex];
        const categoryName = currentScript.category || 'General';

        // DEFINICIÓN DE "POR DEFECTO":
        // 1. Si el título es idéntico a la categoría (ej: "Youtube" en categoría "Youtube")
        // 2. Si el título sigue el patrón de carga masiva (ej: "Youtube 1", "Youtube 25")
        // 3. Si el título es "Nuevo Guión" (título default del sistema)
        const isExactMatch = originalTitle === categoryName;
        const isBulkPattern = new RegExp(`^${categoryName}\\s\\d+$`).test(originalTitle);
        const isSystemDefault = originalTitle === "Nuevo Guión";

        if (isExactMatch || isBulkPattern || isSystemDefault) {
            textToCopy = generateTimeBasedID();
            isGeneratedID = true;
            console.log('⚡ Título genérico detectado. Generando ID único:', textToCopy);
        } else {
            console.log('📝 Título personalizado detectado. Manteniendo:', textToCopy);
        }
    }
    
    // Copiar al portapapeles
    navigator.clipboard.writeText(textToCopy).then(() => {
        // Feedback Visual Avanzado
        const btn = document.querySelector('.sidebar-action-btn[onclick*="copyScriptTitle"]');
        
        if (btn) {
            const btnTitle = btn.querySelector('.action-btn-title');
            const btnSubtitle = btn.querySelector('.action-btn-subtitle');
            
            if (btnTitle) {
                const originalText = btnTitle.textContent;
                const originalSub = btnSubtitle ? btnSubtitle.textContent : '';

                // ESTÉTICA: Si es ID generado usamos Púrpura (Tech), si es Normal usamos Verde (Success)
                if (isGeneratedID) {
                    btnTitle.textContent = '✓ ID Generado';
                    if(btnSubtitle) btnSubtitle.textContent = textToCopy; // Muestra el ID brevemente
                    // Gradiente Púrpura Estético
                    btn.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)';
                    btn.style.borderColor = '#7c3aed';
                    btn.style.color = 'white';
                    // Icono blanco
                    const icon = btn.querySelector('.action-btn-icon');
                    if(icon) icon.style.background = 'rgba(255,255,255,0.2)';
                } else {
                    btnTitle.textContent = '✓ Título Copiado';
                    // Gradiente Verde Estético
                    btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                    btn.style.borderColor = '#16a34a';
                    btn.style.color = 'white';
                }
                
                // Restaurar estado original después de 2 segundos
                setTimeout(() => {
                    btnTitle.textContent = originalText;
                    if(btnSubtitle) btnSubtitle.textContent = originalSub;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                    const icon = btn.querySelector('.action-btn-icon');
                    if(icon) icon.style.background = ''; // Restaurar gradiente original del icono
                }, 2000);
            }
        } else {
            // Feedback para atajos de teclado
            showToast(isGeneratedID ? `✓ ID Generado: ${textToCopy}` : '✓ Título copiado al portapapeles');
        }
    }).catch(err => {
        console.error('❌ Error al copiar:', err);
        alert('No se pudo copiar el título');
    });
}

function copyPrompt() {
    const promptText = document.getElementById('promptText').textContent;
    
    if (!promptText || promptText.trim().length === 0) {
        console.error('❌ No hay texto de prompt disponible');
        alert('No hay prompt disponible para copiar');
        return;
    }
    
    // REGLA GLOBAL: Obtener el guion actual
    const guionContent = document.getElementById('viewContent').textContent;
    
    // Construir el texto con el sufijo
    const finalText = `${promptText} — Basar todas las generaciones y resultados en el siguiente guion: '${guionContent}'`;
    
    console.log('📋 Copiando prompt con regla global');
    
    navigator.clipboard.writeText(finalText).then(() => {
        console.log('✅ Prompt copiado exitosamente');
        
        // Buscar el botón para feedback visual
        const btn = document.querySelector('.sidebar-action-btn.prompt-btn[onclick*="copyPrompt"]');
        
        if (btn) {
            const btnTitle = btn.querySelector('.action-btn-title');
            if (btnTitle) {
                const originalText = btnTitle.textContent;
                btnTitle.textContent = '✓ ¡Copiado!';
                btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                btn.style.borderColor = '#16a34a';
                
                setTimeout(() => {
                    btnTitle.textContent = originalText;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    
                    // NUEVO: Abrir automáticamente el generador de prompts
                    openPromptsGenerator();
                }, 500);
            }
        } else {
            // Feedback alternativo y abrir generador
            showToast('✓ Prompt copiado al portapapeles');
            setTimeout(() => {
                openPromptsGenerator();
            }, 500);
        }
    }).catch(err => {
        console.error('❌ Error al copiar:', err);
        alert('No se pudo copiar el prompt');
    });
}

function copyCategoryPath() {
    const pathElement = document.getElementById('categoryPath');
    
    if (!pathElement) {
        console.error('❌ No se encontró el elemento categoryPath');
        alert('No se encontró la ruta de clips');
        return;
    }
    
    const pathText = pathElement.textContent.trim();
    
    if (!pathText || pathText.length === 0) {
        alert('No hay ruta de clips disponible para copiar');
        return;
    }
    
    console.log('📋 Copiando ruta de clips:', pathText);
    
    navigator.clipboard.writeText(pathText).then(() => {
        console.log('✅ Ruta copiada exitosamente');
        
        // Buscar el botón para feedback visual
        const btn = document.querySelector('.sidebar-action-btn.path-btn[onclick*="copyCategoryPath"]');
        
        if (btn) {
            const btnTitle = btn.querySelector('.action-btn-title');
            if (btnTitle) {
                const originalText = btnTitle.textContent;
                btnTitle.textContent = '✓ ¡Copiado!';
                btn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                btn.style.borderColor = '#2563eb';
                btn.style.color = 'white';
                
                setTimeout(() => {
                    btnTitle.textContent = originalText;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 2000);
            }
        } else {
            // Feedback alternativo para atajos de teclado
            showToast('✓ Ruta de clips copiada al portapapeles');
        }
    }).catch(err => {
        console.error('❌ Error al copiar:', err);
        alert('No se pudo copiar la ruta');
    });
}

// ============================================
// ✨ NUEVA FUNCIÓN AÑADIDA
// ============================================
function copyCategoryExportPath() {
    const pathElement = document.getElementById('categoryExportPath');
    
    if (!pathElement) {
        console.error('❌ No se encontró el elemento categoryExportPath');
        alert('No se encontró la ruta de exportación');
        return;
    }
    
    const pathText = pathElement.textContent.trim();
    
    if (!pathText || pathText.length === 0) {
        alert('No hay ruta de exportación disponible para copiar');
        return;
    }
    
    console.log('📋 Copiando ruta de exportación:', pathText);
    
    navigator.clipboard.writeText(pathText).then(() => {
        console.log('✅ Ruta de exportación copiada exitosamente');
        
        const btn = document.querySelector('.sidebar-action-btn.export-btn[onclick*="copyCategoryExportPath"]');
        
        if (btn) {
            const btnTitle = btn.querySelector('.action-btn-title');
            if (btnTitle) {
                const originalText = btnTitle.textContent;
                btnTitle.textContent = '✓ ¡Copiado!';
                btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                btn.style.borderColor = '#16a34a';
                btn.style.color = 'white';
                
                setTimeout(() => {
                    btnTitle.textContent = originalText;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 2000);
            }
        } else {
            showToast('✓ Ruta de exportación copiada al portapapeles');
        }
    }).catch(err => {
        console.error('❌ Error al copiar:', err);
        alert('No se pudo copiar la ruta de exportación');
    });
}

// NUEVA FUNCIÓN: Toast para feedback visual en atajos de teclado
function showToast(message) {
    // Crear el elemento toast si no existe
    let toast = document.getElementById('keyboardToast');
    
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'keyboardToast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `;
        document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    
    // Mostrar
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
    }, 10);
    
    // Ocultar después de 2 segundos
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
    }, 2000);
}
        // Función auxiliar para copiar con método alternativo
        function fallbackCopyToClipboard(text, btn, btnText) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    console.log('✓ Copiado exitosamente (método alternativo):', text);
                    
                    if (btn && btnText) {
                        btn.classList.add('copied');
                        btnText.textContent = '¡Copiado!';
                        
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btnText.textContent = 'Copiar';
                        }, 2000);
                    }
                } else {
                    throw new Error('execCommand falló');
                }
            } catch (err) {
                console.error('Error en método alternativo:', err);
                alert('No se pudo copiar la ruta de exportación.\n\nRuta: ' + text + '\n\nPor favor, copia manualmente esta ruta.');
            }
        }

        async function toggleUsedStatus() {
            if (currentViewIndex >= 0 && filteredScripts[currentViewIndex]) {
                const script = filteredScripts[currentViewIndex];
                const originalScript = scripts.find(s => s.id === script.id);
                
                // Determinar el nuevo estado
                const newStatus = !originalScript.used;

                try {
                    // 1. Actualizar en memoria
                    originalScript.used = newStatus;
                    script.used = newStatus;

                    // 2. PERSISTENCIA EN BASE DE DATOS (Fix Crítico)
                    await db.scripts.put(originalScript);
                    
                    // 3. Actualizar UI y Configuración
                    saveData(); 
                    updateStats();
                    
                    // 4. Lógica de UI según el estado
                    if (newStatus) {
                        // === Lógica: Marcar como utilizado (Auto-avance) ===
                        
                        // Obtener la lista actualizada de disponibles
                        const availableScripts = getFilteredScripts();
                        
                        if (availableScripts.length > 0) {
                            // Ajustar índice si es necesario
                            if (currentViewIndex >= availableScripts.length) {
                                currentViewIndex = 0;
                            }
                            
                            // Cargar el siguiente guion disponible inmediatamente
                            const nextScript = availableScripts[currentViewIndex];
                            loadScriptInModal(nextScript);
                            renderScripts();
                        } else {
                            // No quedan más guiones: cerrar y felicitar
                            closeModal('viewModal');
                            renderScripts();
                            setTimeout(() => {
                                alert('🎉 ¡Excelente trabajo! Has completado todos los guiones disponibles en esta categoría.');
                            }, 300);
                        }
                    } else {
                        // === Lógica: Desmarcar (Volver a disponible) ===
                        updateMarkUsedButton(false);
                        renderScripts();
                    }

                } catch (err) {
                    console.error("Error crítico guardando estado:", err);
                    // Revertir cambio en memoria si falla la DB
                    originalScript.used = !newStatus;
                    script.used = !newStatus;
                    alert("Error: No se pudo guardar el estado en la base de datos.");
                }
            }
        }

        // Función auxiliar para cargar un guion en el modal sin cerrar/abrir
        function loadScriptInModal(script) {
            // Actualizar contenido del modal
            document.getElementById('viewTitle').textContent = script.title;
            document.getElementById('viewCategory').textContent = script.category;
            document.getElementById('viewContent').textContent = script.content;
            document.getElementById('viewDate').textContent = `Creado: ${formatDate(script.createdAt)}`;
            
            // Actualizar cálculos
const scenes = calculateScenes(script.content, script.category);
const duration = calculateDuration(scenes, script.category);
            
            document.getElementById('viewScenes').textContent = scenes;
            document.getElementById('viewCharCount').textContent = script.content.length;
            document.getElementById('viewDuration').textContent = formatDuration(duration);
            document.getElementById('viewSecondsTotal').textContent = duration;
            
            // Actualizar ruta de clips
            const category = categories.find(cat => cat.name === script.category);
            const pathContainer = document.getElementById('categoryPathContainer');
            const pathText = document.getElementById('categoryPath');
            const btnCopyPath = pathContainer.querySelector('.btn-copy-path');

if (category && category.path) {
    pathText.textContent = category.path;
    pathText.setAttribute('data-full-path', category.path);
    pathContainer.style.display = 'flex';
} else {
    pathContainer.style.display = 'none';
}

            // Actualizar ruta de exportación
            const exportPathContainer = document.getElementById('categoryExportPathContainer');
            const exportPathText = document.getElementById('categoryExportPath');
            const btnCopyExportPath = exportPathContainer.querySelector('.btn-copy-export-path');

if (category && category.exportPath) {
    exportPathText.textContent = category.exportPath;
    exportPathText.setAttribute('data-full-path', category.exportPath);
    exportPathContainer.style.display = 'flex';
} else {
    exportPathContainer.style.display = 'none';
}
            
// Actualizar prompt (solo botón con tooltip)
const promptContainer = document.getElementById('promptContainer');
const promptText = document.getElementById('promptText');
const promptButton = promptContainer.querySelector('.btn-copy-prompt-clean');

if (category && category.promptTemplate) {
    const resolvedPrompt = resolvePromptTemplate(category.promptTemplate, scenes);
    promptText.textContent = resolvedPrompt;
    
    // Establecer el tooltip con el prompt resuelto
    if (promptButton) {
        promptButton.setAttribute('data-tooltip', resolvedPrompt);
    }
    
    promptContainer.style.display = 'block';
} else {
    promptContainer.style.display = 'none';
}

            // Actualizar botón de marcar como utilizado
            updateMarkUsedButton(script.used);
            
            // Actualizar filteredScripts para navegación
            filteredScripts = getFilteredScripts();
            currentViewIndex = filteredScripts.findIndex(s => s.id === script.id);
        }
        
        function updateMarkUsedButton(isUsed) {
            const btn = document.getElementById('btnMarkUsed');
            const text = document.getElementById('markUsedText');
            
            if (isUsed) {
                btn.classList.add('marked');
                text.textContent = 'Marcar como disponible';
            } else {
                btn.classList.remove('marked');
                text.textContent = 'Marcar como utilizado';
            }
        }

        function copyCurrentScript() {
            const content = document.getElementById('viewContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = event.target.closest('.btn-copy-script');
                const originalText = btn.innerHTML;
                btn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Copiado
                `;
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        function nextScript() {
            if (filteredScripts.length === 0) return;
            currentViewIndex = (currentViewIndex + 1) % filteredScripts.length;
            const script = filteredScripts[currentViewIndex];
            
            document.getElementById('viewTitle').textContent = script.title;
            document.getElementById('viewCategory').textContent = script.category;
            document.getElementById('viewContent').textContent = script.content;
            document.getElementById('viewDate').textContent = `Creado: ${formatDate(script.createdAt)}`;
            
            // Actualizar cálculos
            const scenes = calculateScenes(script.content);
            const duration = calculateDuration(scenes);
            
            document.getElementById('viewScenes').textContent = scenes;
            document.getElementById('viewCharCount').textContent = script.content.length;
            document.getElementById('viewDuration').textContent = formatDuration(duration);
            document.getElementById('viewSecondsTotal').textContent = duration;
            
            // Actualizar ruta de clips
            const category = categories.find(cat => cat.name === script.category);
            const pathContainer = document.getElementById('categoryPathContainer');
            const pathText = document.getElementById('categoryPath');
            const btnCopyPath = pathContainer.querySelector('.btn-copy-path');

            if (category && category.path) {
                pathText.textContent = category.path;
                if (btnCopyPath) {
                    btnCopyPath.setAttribute('data-tooltip', category.path);
                }
                pathContainer.style.display = 'flex';
            } else {
                pathContainer.style.display = 'none';
            }

            // Actualizar ruta de exportación
            const exportPathContainer = document.getElementById('categoryExportPathContainer');
            const exportPathText = document.getElementById('categoryExportPath');
            const btnCopyExportPath = exportPathContainer.querySelector('.btn-copy-export-path');

if (category && category.exportPath) {
    exportPathText.textContent = category.exportPath;
    exportPathText.setAttribute('data-full-path', category.exportPath);
    exportPathContainer.style.display = 'flex';
} else {
    exportPathContainer.style.display = 'none';
}
            
// Actualizar prompt (solo botón con tooltip)
const promptContainer = document.getElementById('promptContainer');
const promptText = document.getElementById('promptText');
const promptButton = promptContainer.querySelector('.btn-copy-prompt-clean');

if (category && category.promptTemplate) {
    const resolvedPrompt = resolvePromptTemplate(category.promptTemplate, scenes);
    promptText.textContent = resolvedPrompt;
    
    // Establecer el tooltip con el prompt resuelto
    if (promptButton) {
        promptButton.setAttribute('data-tooltip', resolvedPrompt);
    }
    
    promptContainer.style.display = 'block';
} else {
    promptContainer.style.display = 'none';
}

            updateMarkUsedButton(script.used);
        }

        function prevScript() {
            if (filteredScripts.length === 0) return;
            currentViewIndex = (currentViewIndex - 1 + filteredScripts.length) % filteredScripts.length;
            const script = filteredScripts[currentViewIndex];
            
            document.getElementById('viewTitle').textContent = script.title;
            document.getElementById('viewCategory').textContent = script.category;
            document.getElementById('viewContent').textContent = script.content;
            document.getElementById('viewDate').textContent = `Creado: ${formatDate(script.createdAt)}`;
            
            // Actualizar cálculos
            const scenes = calculateScenes(script.content);
            const duration = calculateDuration(scenes);
            
            document.getElementById('viewScenes').textContent = scenes;
            document.getElementById('viewCharCount').textContent = script.content.length;
            document.getElementById('viewDuration').textContent = formatDuration(duration);
            document.getElementById('viewSecondsTotal').textContent = duration;
            
            // Actualizar ruta de clips
            const category = categories.find(cat => cat.name === script.category);
            const pathContainer = document.getElementById('categoryPathContainer');
            const pathText = document.getElementById('categoryPath');
            const btnCopyPath = pathContainer.querySelector('.btn-copy-path');

            if (category && category.path) {
                pathText.textContent = category.path;
                if (btnCopyPath) {
                    btnCopyPath.setAttribute('data-tooltip', category.path);
                }
                pathContainer.style.display = 'flex';
            } else {
                pathContainer.style.display = 'none';
            }

            // Actualizar ruta de exportación
            const exportPathContainer = document.getElementById('categoryExportPathContainer');
            const exportPathText = document.getElementById('categoryExportPath');
            const btnCopyExportPath = exportPathContainer.querySelector('.btn-copy-export-path');

if (category && category.exportPath) {
    exportPathText.textContent = category.exportPath;
    exportPathText.setAttribute('data-full-path', category.exportPath);
    exportPathContainer.style.display = 'flex';
} else {
    exportPathContainer.style.display = 'none';
}
            
// Actualizar prompt (solo botón con tooltip)
const promptContainer = document.getElementById('promptContainer');
const promptText = document.getElementById('promptText');
const promptButton = promptContainer.querySelector('.btn-copy-prompt-clean');

if (category && category.promptTemplate) {
    const resolvedPrompt = resolvePromptTemplate(category.promptTemplate, scenes);
    promptText.textContent = resolvedPrompt;
    
    // Establecer el tooltip con el prompt resuelto
    if (promptButton) {
        promptButton.setAttribute('data-tooltip', resolvedPrompt);
    }
    
    promptContainer.style.display = 'block';
} else {
    promptContainer.style.display = 'none';
}
            
            updateMarkUsedButton(script.used);
        }

        function handleSearch() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            renderScripts();
        }

        function toggleFiltersPanel() {
            filtersActive = !filtersActive;
            const panel = document.getElementById('filtersPanel');
            const btn = document.getElementById('toggleFiltersBtn');
            
            panel.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function setStatusFilter(status) {
            statusFilter = status;
            
            document.querySelectorAll('[data-status]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            updateActiveFiltersCount();
            renderScripts();
        }

        function setSortFilter(sort) {
            sortFilter = sort;
            
            document.querySelectorAll('[data-sort]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-sort="${sort}"]`).classList.add('active');
            
            updateActiveFiltersCount();
            renderScripts();
        }

        function updateActiveFiltersCount() {
            const count = (statusFilter !== 'available' ? 1 : 0) + (sortFilter !== 'recent' ? 1 : 0);
            const badge = document.getElementById('activeFiltersCount');
            
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function getFilteredScripts() {
            let filtered = currentFilter === 'all' 
                ? scripts 
                : scripts.filter(s => s.category === currentFilter);
            
            if (statusFilter === 'available') {
                filtered = filtered.filter(s => !s.used);
            } else if (statusFilter === 'used') {
                filtered = filtered.filter(s => s.used);
            }
            
            if (searchQuery) {
                filtered = filtered.filter(s => 
                    s.title.toLowerCase().includes(searchQuery) ||
                    s.content.toLowerCase().includes(searchQuery)
                );
            }
            
            filtered = [...filtered];
            
            switch(sortFilter) {
                case 'recent':
                    filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'alpha':
                    filtered.sort((a, b) => a.title.localeCompare(b.title, 'es'));
                    break;
                case 'alpha-desc':
                    filtered.sort((a, b) => b.title.localeCompare(a.title, 'es'));
                    break;
            }
            
            return filtered;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${day} de ${month} de ${year}, ${hours}:${minutes}`;
        }

function renderCategories() {
    const categoryList = document.getElementById('categoryList');
    const allCategory = categoryList.querySelector('.category-item');
    const searchInput = document.getElementById('categorySearchInput');
    const currentSearchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    
    categoryList.innerHTML = '';
    categoryList.appendChild(allCategory);

    categories.forEach(cat => {
        const count = scripts.filter(s => s.category === cat.name).length;
        const div = document.createElement('div');
        div.className = 'category-item';
        div.innerHTML = `
            <div class="category-item-content" onclick="filterCategory('${cat.name.replace(/'/g, "\\'")}')">
                <span><span class="category-icon">📁</span>${cat.name}</span>
            </div>
            <div class="category-actions">
                <button class="category-action-btn" onclick="event.stopPropagation(); openEditCategoryModal('${cat.name.replace(/'/g, "\\'")}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="category-action-btn delete" onclick="event.stopPropagation(); deleteCategory('${cat.name.replace(/'/g, "\\'")}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
            <span class="category-badge">${count}</span>
        `;
        categoryList.appendChild(div);
    });
    
    // Reaplicar filtro de búsqueda si existe
    if (currentSearchTerm) {
        filterCategoriesDisplay(currentSearchTerm);
    }
}

        function renderScripts() {
            const grid = document.getElementById('scriptsGrid');
            const filtered = getFilteredScripts();

            document.getElementById('scriptsCount').textContent = filtered.length;

            if (scripts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay guiones todavía</h3>
                        <p>Comienza agregando tu primer guión</p>
                    </div>
                `;
                return;
            }

            if (filtered.length === 0) {
                const hasUsedScripts = scripts.some(s => s.used);
                const isSearching = searchQuery.length > 0;
                
                if (isSearching) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h3>No se encontraron resultados</h3>
                            <p>Intenta con otros términos de búsqueda</p>
                        </div>
                    `;
                } else if (hasUsedScripts) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h3>🎉 ¡Excelente trabajo!</h3>
                            <p>Has utilizado todos los guiones disponibles en esta categoría</p>
                        </div>
                    `;
                } else {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h3>No hay guiones en esta categoría</h3>
                            <p>Agrega nuevos guiones para comenzar</p>
                        </div>
                    `;
                }
                return;
            }

            grid.innerHTML = filtered.map(script => `
                <div class="script-card ${script.used ? 'used' : ''} ${selectionMode ? 'selection-mode' : ''} ${selectedScripts.has(script.id) ? 'selected' : ''}" 
                    onclick="${selectionMode ? `toggleScriptSelection(${script.id})` : `viewScript(${script.id})`}">
                    <div class="script-checkbox">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                            <div class="script-header">
                        <div style="flex: 1;">
                            <div class="script-title">${script.title}</div>
                        </div>
                        <div class="script-status-indicator"></div>
                    </div>
                    <div class="script-meta">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        ${new Date(script.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}
                        <span class="script-category-badge">${script.used ? 'Utilizado' : 'Disponible'}</span>
                    </div>
                    <div class="script-content">${script.content}</div>
                </div>
            `).join('');

            // Actualizar estado de botones de acción rápida
            updateQuickActionButtons();
        }

        function updateStats() {
            const total = scripts.length;
            const used = scripts.filter(s => s.used).length;
            const available = total - used;

            document.getElementById('totalScripts').textContent = total;
            document.getElementById('availableScripts').textContent = available;
            document.getElementById('usedScripts').textContent = used;
            document.getElementById('count-all').textContent = total;
        }

        function updateUI() {
            renderCategories();
            renderScripts();
            updateStats();
        }

        // Funciones de Acción Rápida
function quickCopyPath() {
    const btn = document.getElementById('btnQuickCopyPath');
    const btnText = document.getElementById('quickCopyPathText');
    
    // Obtener la categoría actual
    let currentCategory = null;
    if (currentFilter !== 'all') {
        currentCategory = categories.find(cat => cat.name === currentFilter);
    }
    
    // Verificar si hay ruta disponible
    if (!currentCategory || !currentCategory.path) {
        alert('Esta categoría no tiene una ruta de clips configurada');
        return;
    }
    
    // Copiar la ruta
    navigator.clipboard.writeText(currentCategory.path).then(() => {
        btn.classList.add('copied');
        btnText.textContent = '¡Copiado!';
        
        setTimeout(() => {
            btn.classList.remove('copied');
            btnText.textContent = 'Copiar Ruta';
        }, 2000);
        
        // Abrir el primer guión disponible
        openFirstAvailableScript();
    }).catch(err => {
        console.error('Error al copiar:', err);
        alert('No se pudo copiar la ruta');
    });
}

function quickCopyScript() {
    const btn = document.getElementById('btnQuickCopyScript');
    const btnText = document.getElementById('quickCopyScriptText');
    
    // Obtener el primer guión filtrado
    const filtered = getFilteredScripts();
    
    if (filtered.length === 0) {
        alert('No hay guiones disponibles para copiar');
        return;
    }
    
    const firstScript = filtered[0];
    
    // Copiar el contenido del guión
    navigator.clipboard.writeText(firstScript.content).then(() => {
        btn.classList.add('copied');
        btnText.textContent = '¡Copiado!';
        
        setTimeout(() => {
            btn.classList.remove('copied');
            btnText.textContent = 'Copiar Guión';
        }, 2000);
        
        // Abrir el guión
        viewScript(firstScript.id);
    }).catch(err => {
        console.error('Error al copiar:', err);
        alert('No se pudo copiar el guión');
    });
}

function openFirstAvailableScript() {
    const filtered = getFilteredScripts();
    
    if (filtered.length === 0) {
        alert('No hay guiones disponibles en esta categoría');
        return;
    }
    
    // Abrir el primer guión
    viewScript(filtered[0].id);
}

function updateQuickActionButtons() {
    const btnPath = document.getElementById('btnQuickCopyPath');
    const btnScript = document.getElementById('btnQuickCopyScript');
    
    const filtered = getFilteredScripts();
    const hasScripts = filtered.length > 0;
    
    // Verificar si hay ruta de clips
    let hasPath = false;
    if (currentFilter !== 'all') {
        const currentCategory = categories.find(cat => cat.name === currentFilter);
        hasPath = currentCategory && currentCategory.path;
    }
    
    // Habilitar/deshabilitar botones
    btnPath.disabled = !hasPath || !hasScripts;
    btnScript.disabled = !hasScripts;
}

// Event Listeners
document.getElementById('searchInput').addEventListener('input', handleSearch);

document.getElementById('newCategoryInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('newCategoryPath').focus();
    }
});

document.getElementById('newCategoryPath').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        addCategory();
    }
});

// ============================================
// SISTEMA CONSOLIDADO DE ATAJOS DE TECLADO - CORREGIDO
// ============================================
document.addEventListener('keydown', (e) => {
    // ============================================
    // PRIORIDAD 1: ESC - CIERRE DE MODALES (SIEMPRE FUNCIONA)
    // ============================================
    if (e.key === 'Escape') {
        e.preventDefault();
        
        // Prioridad 1: Modal de confirmación
        const confirmDialog = document.getElementById('confirmDialog');
        if (confirmDialog && confirmDialog.classList.contains('active')) {
            closeConfirmDialog();
            return;
        }
        
        // Prioridad 2: Modal de prompts
        const promptsModal = document.getElementById('promptsGeneratorModal');
        if (promptsModal && promptsModal.classList.contains('active')) {
            closePromptsGenerator();
            return;
        }
        
        // Prioridad 3: Sidebar móvil
        const sidebar = document.getElementById('mainSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        if (sidebar && sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            return;
        }
        
        return;
    }
    
    // ============================================
    // PRIORIDAD 2: COMANDOS CTRL+SHIFT (FUNCIONAN SIEMPRE)
    // ============================================
    
    // Detectar si es un comando Ctrl+Shift
    const isCtrlShift = e.ctrlKey && e.shiftKey;
    
    // Si NO es Ctrl+Shift, verificar si hay campo de entrada activo
    if (!isCtrlShift) {
        const isActiveInputField = (e.target.tagName === 'INPUT' || 
                                     e.target.tagName === 'TEXTAREA') && 
                                     document.activeElement === e.target;
        
        // Si hay campo activo y NO es Ctrl+Shift, bloquear atajos normales
        if (isActiveInputField) {
            return;
        }
    }
    
// ============================================
    // CTRL+SHIFT+F: Copiar título del guion
    // ============================================
    if (e.ctrlKey && e.shiftKey && (e.key === 'F' || e.key === 'f')) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('🔵 Atajo Ctrl+Shift+F detectado');
        
        const viewModal = document.getElementById('viewModal');
        
        if (viewModal && viewModal.classList.contains('active')) {
            console.log('✅ Modal activo, ejecutando copyScriptTitle()');
            copyScriptTitle();
        } else {
            console.log('❌ Modal NO está activo');
            console.log('Estado del modal:', viewModal ? 'existe pero no activo' : 'no existe');
            alert('⚠️ Necesitas abrir un guion primero para copiar su título\n\nPresiona cualquier tarjeta de guion para abrirlo.');
        }
        return;
    }
    
    // ============================================
    // CTRL+SHIFT+G: Copiar prompt de IA
    // ============================================
    if (e.ctrlKey && e.shiftKey && (e.key === 'G' || e.key === 'g')) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('🔵 Atajo Ctrl+Shift+G detectado');
        
        const viewModal = document.getElementById('viewModal');
        const promptContainer = document.getElementById('promptContainer');
        
        console.log('Verificando modal:', viewModal ? 'existe' : 'NO existe');
        console.log('Modal activo:', viewModal?.classList.contains('active'));
        console.log('Prompt container:', promptContainer ? 'existe' : 'NO existe');
        console.log('Prompt visible:', promptContainer?.style.display !== 'none');
        
        if (viewModal && viewModal.classList.contains('active')) {
            if (promptContainer && promptContainer.style.display !== 'none') {
                console.log('✅ Todo OK, ejecutando copyPrompt()');
                copyPrompt();
            } else {
                console.log('❌ Prompt no disponible');
                alert('⚠️ Este guion no tiene prompt de IA configurado\n\nVe a Configuración → Prompts para IA y configura un prompt para esta categoría.');
            }
        } else {
            console.log('❌ Modal NO está activo');
            alert('⚠️ Necesitas abrir un guion primero\n\nPresiona cualquier tarjeta de guion para abrirlo.');
        }
        return;
    }
    
    // ============================================
    // CTRL+SHIFT+X: Copiar ruta de clips
    // ============================================
    if (e.ctrlKey && e.shiftKey && (e.key === 'X' || e.key === 'x')) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('🔵 Atajo Ctrl+Shift+X detectado');
        
        const viewModal = document.getElementById('viewModal');
        const pathContainer = document.getElementById('categoryPathContainer');
        
        console.log('Verificando modal:', viewModal ? 'existe' : 'NO existe');
        console.log('Modal activo:', viewModal?.classList.contains('active'));
        console.log('Path container:', pathContainer ? 'existe' : 'NO existe');
        console.log('Path visible:', pathContainer?.style.display !== 'none');
        
        if (viewModal && viewModal.classList.contains('active')) {
            if (pathContainer && pathContainer.style.display !== 'none') {
                console.log('✅ Todo OK, ejecutando copyCategoryPath()');
                copyCategoryPath();
            } else {
                console.log('❌ Ruta de clips no disponible');
                alert('⚠️ Esta categoría no tiene ruta de clips configurada\n\nPara configurarla:\n1. Haz clic en el ícono de editar junto al nombre de la categoría\n2. Ingresa la ruta en "Ruta de los Clips"');
            }
        } else {
            console.log('❌ Modal NO está activo');
            
            // Intentar usar botón de acción rápida
            const btn = document.getElementById('btnQuickCopyPath');
            if (btn && !btn.disabled) {
                console.log('✅ Usando botón de acción rápida');
                quickCopyPath();
            } else {
                console.log('❌ Botón de acción rápida no disponible');
                alert('⚠️ Selecciona una categoría con ruta de clips configurada\n\no abre un guion para usar este atajo.');
            }
        }
        return;
    }
    
    // ============================================
    // CTRL+SHIFT+E: Copiar ruta de exportación
    // ============================================
    if (e.ctrlKey && e.shiftKey && (e.key === 'E' || e.key === 'e')) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('🔵 Atajo Ctrl+Shift+E detectado');
        
        const viewModal = document.getElementById('viewModal');
        const exportPathContainer = document.getElementById('categoryExportPathContainer');
        
        if (viewModal && viewModal.classList.contains('active') && 
            exportPathContainer && exportPathContainer.style.display !== 'none') {
            console.log('✅ Modal activo y ruta de exportación disponible, ejecutando copyCategoryExportPath()');
            copyCategoryExportPath();
        } else {
            console.log('❌ Modal no está activo o no hay ruta de exportación');
            alert('⚠️ Esta categoría no tiene ruta de exportación configurada');
        }
        return;
    }
    
    // ============================================
    // CTRL+SHIFT+S: Copiar guion completo
    // ============================================
    if (e.ctrlKey && e.shiftKey && (e.key === 'S' || e.key === 's')) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('🔵 Atajo Ctrl+Shift+S detectado');
        
        const viewModal = document.getElementById('viewModal');
        if (viewModal && viewModal.classList.contains('active')) {
            console.log('✅ Modal activo, ejecutando copyCurrentScript()');
            copyCurrentScript();
        } else {
            const btn = document.getElementById('btnQuickCopyScript');
            if (btn && !btn.disabled) {
                console.log('✅ Usando botón de acción rápida');
                quickCopyScript();
            } else {
                console.log('❌ No hay guiones disponibles');
                alert('⚠️ No hay guiones disponibles para copiar');
            }
        }
        return;
    }
        
    // ============================================
    // NAVEGACIÓN EN MODAL DE PROMPTS
    // ============================================
    const promptsModal = document.getElementById('promptsGeneratorModal');
    if (promptsModal && promptsModal.classList.contains('active')) {
        const activeState = document.getElementById('promptsActiveState');
        
        // Enter: Siguiente prompt
        if (e.key === 'Enter' && activeState && activeState.classList.contains('active')) {
            e.preventDefault();
            nextPrompt();
            return;
        }
        
        // Ctrl+C: Copiar prompt actual (solo si NO hay selección)
        if (e.ctrlKey && (e.key === 'c' || e.key === 'C') && 
            activeState && activeState.classList.contains('active')) {
            const selection = window.getSelection().toString();
            if (!selection) {
                e.preventDefault();
                copyCurrentPrompt();
                return;
            }
        }
    }
    
    // ============================================
    // NAVEGACIÓN CON FLECHAS (solo si modal está abierto)
    // ============================================
    const viewModal = document.getElementById('viewModal');
    if (viewModal && viewModal.classList.contains('active')) {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            prevScript();
            return;
        }
        
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            nextScript();
            return;
        }
    }
});

function handleBulkFileSelect(event) {
    const file = event.target.files[0];
    const label = document.getElementById('fileInputLabel');
    const labelText = document.getElementById('fileInputText');
    
    if (file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const content = e.target.result;
            document.getElementById('bulkScriptContent').value = content;
            
            // Actualizar visual del botón
            label.classList.add('has-file');
            labelText.textContent = `✓ ${file.name}`;
        };
        
        reader.onerror = function() {
            showBulkResult('error', 'Error al leer el archivo');
            resetBulkFileInput();
        };
        
        reader.readAsText(file);
    } else {
        resetBulkFileInput();
    }
}

function resetBulkFileInput() {
    const label = document.getElementById('fileInputLabel');
    const labelText = document.getElementById('fileInputText');
    
    label.classList.remove('has-file');
    labelText.textContent = 'Seleccionar archivo .txt';
    document.getElementById('bulkFileInput').value = '';
}

function agregarGuionesMasivos() {
    const bulkContent = document.getElementById('bulkScriptContent').value.trim();
    const category = document.getElementById('bulkCategory').value.trim() || 'General';    const resultDiv = document.getElementById('bulkResult');
    const btn = document.getElementById('btnBulkAdd');
    
    // Validar que hay contenido
    if (!bulkContent) {
        showBulkResult('warning', 'Por favor, pega guiones o carga un archivo');
        return;
    }
    
    // Deshabilitar botón durante el proceso
    btn.disabled = true;
    btn.innerHTML = '<span>Procesando...</span>';
    
    // Dividir por el separador ---
    const guionesRaw = bulkContent.split('---');
    
    // Limpiar y filtrar guiones vacíos
    const guiones = guionesRaw
        .map(g => g.trim())
        .filter(g => g.length > 0);
    
    if (guiones.length === 0) {
        showBulkResult('warning', 'No se encontraron guiones válidos');
        resetBulkButton();
        return;
    }
    
    // Asegurar que la categoría existe
    if (!categories.some(cat => cat.name === category)) {
        categories.push({ name: category, path: '' });
    }
    
    // Contadores
    let agregados = 0;
    let duplicados = 0;
    
// Procesar cada guion
    guiones.forEach((contenidoRaw, index) => {
        // --- APLICAR FILTROS ---
        const contenido = processTextReplacement(contenidoRaw.trim(), category);
        // -----------------------

        // Verificar si ya existe (comparando contenido exacto en la misma categoría)
        const existe = scripts.some(s => 
            s.content.trim() === contenido && // Ya comparamos con el contenido filtrado
            s.category === category
        );
        
        if (!existe) {
            // Crear título automático
            const titulo = `${category} ${scripts.filter(s => s.category === category).length + agregados + 1}`;
            
            // Agregar guion
            scripts.push({
                id: Date.now() + index, // Asegurar IDs únicos
                title: titulo,
                category: category,
                content: contenido,
                used: false,
                createdAt: new Date().toISOString()
            });
            
            agregados++;
        } else {
            duplicados++;
        }
    });
    
    // Guardar y actualizar UI
    if (agregados > 0) {
        saveData();
        updateUI();
    }
    
    // Mostrar resultado
    let mensaje = '';
    if (agregados > 0 && duplicados === 0) {
        mensaje = `✓ ${agregados} guion(es) agregado(s) exitosamente`;
        showBulkResult('success', mensaje);
    } else if (agregados > 0 && duplicados > 0) {
        mensaje = `✓ ${agregados} agregado(s), ${duplicados} duplicado(s) omitido(s)`;
        showBulkResult('warning', mensaje);
    } else if (agregados === 0 && duplicados > 0) {
        mensaje = `⚠ Todos los guiones ya existen (${duplicados} duplicados)`;
        showBulkResult('warning', mensaje);
    }
    
    // Limpiar campos
    document.getElementById('bulkScriptContent').value = '';
    resetBulkFileInput();
    
    // Restaurar botón
    setTimeout(() => {
        resetBulkButton();
    }, 2000);
}

function showBulkResult(type, message) {
    const resultDiv = document.getElementById('bulkResult');
    const resultText = document.getElementById('bulkResultText');
    
    resultDiv.className = 'bulk-result ' + type;
    resultText.textContent = message;
    
    // Ocultar después de 5 segundos
    setTimeout(() => {
        resultDiv.className = 'bulk-result';
    }, 5000);
}

function resetBulkButton() {
    const btn = document.getElementById('btnBulkAdd');
    btn.disabled = false;
    btn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Agregar Guiones Masivos
    `;
}

// ============================================
// FIN DE FUNCIONES DE CARGA MASIVA
// ============================================

// ============================================
// FUNCIONES DE CONFIGURACIÓN
// ============================================

function openConfigModal() {
    // Cargar valores para Contenido Corto
    document.getElementById('configCharactersShort').value = config.formulas.short.charactersPerScene;
    document.getElementById('configSecondsShort').value = config.formulas.short.secondsPerScene;

    // Cargar valores para Contenido Largo
    document.getElementById('configCharactersLong').value = config.formulas.long.charactersPerScene;
    document.getElementById('configSecondsLong').value = config.formulas.long.secondsPerScene;

    // Cargar valor de Coherencia
    document.getElementById('configSceneCoherenceLength').value = config.sceneCoherenceLength;

    updateConfigDisplay();
    renderConfigPrompts();
    renderConfigFilters(); // Asegurarse de que los filtros también se rendericen
    
    document.getElementById('configModal').classList.add('active');
}

// Después:
function updateConfigDisplay() {
    // Contenido Corto
    const charsShort = document.getElementById('configCharactersShort').value;
    const secondsShort = document.getElementById('configSecondsShort').value;
    document.getElementById('configCharactersShortDisplay').textContent = charsShort;
    document.getElementById('configSecondsShortDisplay').innerHTML = `${secondsShort}<span style="font-size: 14px;">s</span>`;

    // Contenido Largo
    const charsLong = document.getElementById('configCharactersLong').value;
    const secondsLong = document.getElementById('configSecondsLong').value;
    document.getElementById('configCharactersLongDisplay').textContent = charsLong;
    document.getElementById('configSecondsLongDisplay').innerHTML = `${secondsLong}<span style="font-size: 14px;">s</span>`;
    
    // Coherencia
    const coherence = document.getElementById('configSceneCoherenceLength').value;
    document.getElementById('configCoherenceDisplay').innerHTML = `${coherence}<span style="font-size: 14px; font-weight: 400; color: #737373;"> escenas</span>`;
}

function renderConfigPrompts() {
    const container = document.getElementById('configPromptsContainer');
    
    if (categories.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 48px 20px; color: #a3a3a3;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.5;">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                <p style="font-size: 14px; margin: 0;">No hay categorías creadas todavía</p>
                <p style="font-size: 12px; margin-top: 4px; color: #d4d4d4;">Crea una categoría para configurar sus prompts de IA</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = categories.map((cat, index) => {
        const scriptCount = scripts.filter(s => s.category === cat.name).length;
        return `
            <div class="prompt-category-card">
                <div class="prompt-category-header" onclick="togglePromptCard(${index})">
                    <div class="prompt-category-info">
                        <div class="prompt-category-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="prompt-category-title">${cat.name}</div>
                            <div class="prompt-category-count">${scriptCount} guion${scriptCount !== 1 ? 'es' : ''}</div>
                        </div>
                    </div>
                    <svg class="prompt-chevron" id="chevron_${index}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                <div class="prompt-category-body" id="promptBody_${index}">
                    <textarea 
                        id="configPrompt_${index}" 
                        class="prompt-textarea"
                        placeholder="Escribe el prompt de generación aquí..."
                    >${cat.promptTemplate || DEFAULT_PROMPT_TEMPLATE}</textarea>
                    <div class="prompt-hint">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Usa <code>(X)</code> donde quieras que aparezca el número de escenas</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Función para expandir/colapsar tarjetas de prompts
function togglePromptCard(index) {
    const body = document.getElementById(`promptBody_${index}`);
    const chevron = document.getElementById(`chevron_${index}`);
    const header = body.previousElementSibling;
    
    body.classList.toggle('active');
    chevron.classList.toggle('active');
    header.classList.toggle('active');
}

function saveConfiguration() {
    // Guardar valores de fórmula para Contenido Corto
    config.formulas.short.charactersPerScene = parseInt(document.getElementById('configCharactersShort').value);
    config.formulas.short.secondsPerScene = parseInt(document.getElementById('configSecondsShort').value);
    
    // Guardar valores de fórmula para Contenido Largo
    config.formulas.long.charactersPerScene = parseInt(document.getElementById('configCharactersLong').value);
    config.formulas.long.secondsPerScene = parseInt(document.getElementById('configSecondsLong').value);

    // Guardar valor de Coherencia
    config.sceneCoherenceLength = parseInt(document.getElementById('configSceneCoherenceLength').value);    categories.forEach((cat, index) => {
        const promptTextarea = document.getElementById(`configPrompt_${index}`);
        if (promptTextarea) {
            cat.promptTemplate = promptTextarea.value.trim() || DEFAULT_PROMPT_TEMPLATE;
        }
    });
    
    // Guardar en localStorage
    saveData();
    
    // Cerrar modal
    closeModal('configModal');
    
    // Mostrar confirmación
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        ¡Guardado!
    `;
    btn.style.background = '#22c55e';
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.background = '';
    }, 2000);
    
    // Si hay un guion abierto, actualizar sus cálculos
    const viewModal = document.getElementById('viewModal');
    if (viewModal.classList.contains('active') && currentViewIndex >= 0 && filteredScripts[currentViewIndex]) {
        const script = filteredScripts[currentViewIndex];
        
        // Recalcular
        const scenes = calculateScenes(script.content);
        const duration = calculateDuration(scenes);
        
        document.getElementById('viewScenes').textContent = scenes;
        document.getElementById('viewDuration').textContent = formatDuration(duration);
        document.getElementById('viewSecondsTotal').textContent = duration;
        
        // Actualizar prompt si existe
        const category = categories.find(cat => cat.name === script.category);
        const promptText = document.getElementById('promptText');
        const promptContainer = document.getElementById('promptContainer');
        
        if (category && category.promptTemplate && promptContainer.style.display !== 'none') {
            const resolvedPrompt = resolvePromptTemplate(category.promptTemplate, scenes);
            promptText.textContent = resolvedPrompt;
        }
    }
}

// ============================================
// FIN DE FUNCIONES DE CONFIGURACIÓN
// ============================================

// Función para cambiar entre pestañas de configuración
function switchConfigTab(tabName) {
    // Actualizar botones de pestañas
    const tabs = document.querySelectorAll('.config-tab-button');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Actualizar contenido de pestañas
    const contents = document.querySelectorAll('.config-tab-content');
    contents.forEach(content => content.classList.remove('active'));
    
    if (tabName === 'formulas') {
        tabs[0].classList.add('active');
        document.getElementById('configTabFormulas').classList.add('active');
    } else if (tabName === 'prompts') {
        tabs[1].classList.add('active');
        document.getElementById('configTabPrompts').classList.add('active');
    } else if (tabName === 'filters') { // <--- NUEVO BLOQUE
        tabs[2].classList.add('active');
        document.getElementById('configTabFilters').classList.add('active');
        renderConfigFilters(); // Función que crearemos en el siguiente paso
    }
}

// ============================================
// SISTEMA DE CONFIRMACIÃN IN-APP
// ============================================

// ============================================
// LÓGICA DE FILTROS Y REEMPLAZO (NUEVO)
// ============================================

function renderConfigFilters() {
    // 1. Renderizar selector de categorías
    const catSelector = document.getElementById('newFilterCategories');
    if(catSelector) {
        catSelector.innerHTML = '';
        
        // Opción "Todas"
        const allOption = document.createElement('div');
        allOption.className = 'cat-tag-option';
        allOption.textContent = 'Todas';
        allOption.onclick = function() { 
            // Si seleccionas "Todas", desmarca las demás
            const siblings = this.parentElement.children;
            for(let el of siblings) el.classList.remove('selected');
            this.classList.add('selected'); 
        };
        catSelector.appendChild(allOption);

        categories.forEach(cat => {
            const opt = document.createElement('div');
            opt.className = 'cat-tag-option';
            opt.textContent = cat.name;
            opt.dataset.value = cat.name;
            opt.onclick = function() { 
                // Si seleccionas una específica, desmarca "Todas"
                allOption.classList.remove('selected');
                this.classList.toggle('selected'); 
            };
            catSelector.appendChild(opt);
        });
    }

    // 2. Renderizar lista de filtros activos
    const list = document.getElementById('activeFiltersList');
    if(list) {
        list.innerHTML = '';

        if (wordFilters.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding: 20px; color:#a3a3a3; font-size:13px;">No hay reglas de reemplazo activas</div>';
            return;
        }

        wordFilters.forEach((filter, index) => {
            const item = document.createElement('div');
            item.className = 'filter-item-card';
            
            // Mostrar categorías bonitas
            const catsDisplay = filter.categories.includes('all') 
                ? '<span class="mini-cat-badge">Todas las categorías</span>' 
                : filter.categories.map(c => `<span class="mini-cat-badge">${c}</span>`).join('');

            item.innerHTML = `
                <div style="flex:1;">
                    <div class="filter-words-display">
                        <span>${filter.original}</span>
                        <svg class="filter-replacement-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                        <span style="color: #2563eb;">${filter.replacement}</span>
                    </div>
                    <div class="filter-categories-badges">
                        ${catsDisplay}
                    </div>
                </div>
                <button class="icon-btn delete" onclick="deleteFilter(${index})" title="Eliminar regla" style="width:32px; height:32px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            `;
            list.appendChild(item);
        });
    }
}

function addNewFilter() {
    const original = document.getElementById('newFilterOriginal').value.trim();
    const replacement = document.getElementById('newFilterReplacement').value.trim();
    
    // Obtener categorías seleccionadas
    const selectedCats = [];
    const options = document.querySelectorAll('#newFilterCategories .cat-tag-option.selected');
    
    options.forEach(opt => {
        if (opt.textContent === 'Todas') selectedCats.push('all');
        else selectedCats.push(opt.dataset.value);
    });

    if (!original || !replacement) {
        alert('Por favor completa la palabra original y su reemplazo.');
        return;
    }

    if (selectedCats.length === 0) {
        alert('Selecciona al menos una categoría para aplicar el filtro.');
        return;
    }

    wordFilters.push({
        id: Date.now(),
        original,
        replacement,
        categories: selectedCats
    });

    saveData();
    renderConfigFilters();
    
    // Limpiar inputs
    document.getElementById('newFilterOriginal').value = '';
    document.getElementById('newFilterReplacement').value = '';
    document.querySelectorAll('.cat-tag-option').forEach(el => el.classList.remove('selected'));
}

function deleteFilter(index) {
    if(confirm('¿Eliminar esta regla de reemplazo?')) {
        wordFilters.splice(index, 1);
        saveData();
        renderConfigFilters();
    }
}

// FUNCIÓN DE PROCESAMIENTO PRINCIPAL (El Cerebro)
function processTextReplacement(text, categoryName) {
    if (!text) return text;
    let processedText = text;

    wordFilters.forEach(filter => {
        // Verificar si aplica a esta categoría o a "todas"
        const applies = filter.categories.includes('all') || filter.categories.includes(categoryName);
        
        if (applies) {
            // Crear Regex Global Case-Insensitive para reemplazar todas las ocurrencias
            // Escapamos caracteres especiales para evitar errores de regex
            const escapedOriginal = filter.original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            // Usamos 'gi' para que sea global e ignore mayúsculas/minúsculas
            const regex = new RegExp(escapedOriginal, 'gi');
            processedText = processedText.replace(regex, filter.replacement);
        }
    });

    return processedText;
}

function showConfirmDialog(title, message, callback) {
    confirmCallback = callback;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmDialog').classList.add('active');
}

function closeConfirmDialog() {
    document.getElementById('confirmDialog').classList.remove('active');
    confirmCallback = null;
}

function confirmDelete() {
    if (confirmCallback) {
        confirmCallback();
        closeConfirmDialog();
    }
}

// ============================================
// SISTEMA DE SELECCIÃN MÃLTIPLE
// ============================================

function toggleSelectionMode() {
    selectionMode = !selectionMode;
    selectedScripts.clear();
    
    const btn = document.getElementById('btnSelectMode');
    const bar = document.getElementById('selectionModeBar');
    
    if (selectionMode) {
        btn.classList.add('active');
        bar.classList.add('active');
    } else {
        btn.classList.remove('active');
        bar.classList.remove('active');
    }
    
    updateSelectionCount();
    renderScripts();
}

function cancelSelectionMode() {
    selectionMode = false;
    selectedScripts.clear();
    
    document.getElementById('btnSelectMode').classList.remove('active');
    document.getElementById('selectionModeBar').classList.remove('active');
    
    renderScripts();
}

function toggleScriptSelection(scriptId) {
    if (selectedScripts.has(scriptId)) {
        selectedScripts.delete(scriptId);
    } else {
        selectedScripts.add(scriptId);
    }
    
    updateSelectionCount();
    renderScripts();
}

function updateSelectionCount() {
    const count = selectedScripts.size;
    document.getElementById('selectionCount').textContent = count;
}

function deleteSelectedScripts() {
    if (selectedScripts.size === 0) {
        return;
    }
    
    const count = selectedScripts.size;
    const message = count === 1 
        ? 'Se eliminará permanentemente 1 guión seleccionado.'
        : `Se eliminarán permanentemente ${count} guiones seleccionados.`;
    
    showConfirmDialog(
        `¿Eliminar ${count} guión${count > 1 ? 'es' : ''}?`,
        message,
        () => {
            // Eliminar los scripts seleccionados
            scripts = scripts.filter(s => !selectedScripts.has(s.id));
            
            // Limpiar selección
            selectedScripts.clear();
            
            // Salir del modo selección
            cancelSelectionMode();
            
            // Guardar y actualizar
            saveData();
            updateUI();
        }
    );
}

// ============================================
// FUNCIÓN PARA SIDEBAR RESPONSIVA
// ============================================

function toggleSidebar() {
    const sidebar = document.getElementById('mainSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const body = document.body;
    
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    
    // Prevenir scroll del body cuando sidebar está abierto
    if (sidebar.classList.contains('active')) {
        body.style.overflow = 'hidden';
    } else {
        body.style.overflow = '';
    }
}

// Cerrar sidebar al hacer clic en una categoría (solo en móviles)
const originalFilterCategory = window.filterCategory;
window.filterCategory = function(category) {
    originalFilterCategory(category);
    
    // Cerrar sidebar solo si está visible (móviles)
    if (window.innerWidth <= 900) {
        const sidebar = document.getElementById('mainSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        if (sidebar && sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
};

// ============================================
// FIN DE FUNCIÓN SIDEBAR RESPONSIVA
// ============================================


// ============================================
// MÓDULO DE REFERENCIAS VISUALES
// ============================================

let currentEditingCategory = null;
let tempVisualReferences = {
    asunto: null,
    escena: null,
    estilo: null
};

// === INICIO CÓDIGO NUEVO ===
let tempCustomVisuals = {
    asunto: null,
    escena: null,
    estilo: null
};
// === FIN CÓDIGO NUEVO ===

function loadVisualReferences(references) {
    tempVisualReferences = {
        asunto: references.asunto || null,
        escena: references.escena || null,
        estilo: references.estilo || null
    };
    
    // Cargar vista previa de cada referencia
    ['asunto', 'escena', 'estilo'].forEach(type => {
        const preview = document.getElementById(`preview${capitalize(type)}`);
        const btnRemove = document.getElementById(`btnRemove${capitalize(type)}`);
        const blobData = tempVisualReferences[type];
        
        if (blobData) {
            // 1. Generar URL temporal desde el Blob
            const thumbUrl = getImageUrl(blobData);
            
            // 2. Insertar imagen con gestión de memoria (revokeObjectURL)
            preview.innerHTML = `<img src="${thumbUrl}" alt="Referencia ${type}" onload="if(this.src.startsWith('blob:')) URL.revokeObjectURL(this.src)">`;
            
            preview.classList.add('has-image');
            if (btnRemove) btnRemove.disabled = false;
        } else {
            // Mostrar placeholder
            resetReferencePreview(type);
        }
    });
}

function handleReferenceUpload(type, event) {
    handleReferenceUploadGeneric(type, event, tempVisualReferences);
}

function removeReference(type) {
    // Confirmar eliminación
    const confirmed = confirm(`¿Eliminar la referencia de ${type}?`);
    
    if (!confirmed) return;
    
    // Limpiar del objeto temporal
    tempVisualReferences[type] = null;
    
    // Resetear vista previa
    resetReferencePreview(type);
    
    // Limpiar input file
    const input = document.getElementById(`input${type.charAt(0).toUpperCase() + type.slice(1)}`);
    input.value = '';
}

function resetReferencePreview(type) {
    const preview = document.getElementById(`preview${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const btnRemove = document.getElementById(`btnRemove${type.charAt(0).toUpperCase() + type.slice(1)}`);
    
    const placeholders = {
        asunto: 'Referencia del<br>tema principal',
        escena: 'Referencia de<br>composición/ambiente',
        estilo: 'Referencia de<br>estética visual'
    };
    
    preview.innerHTML = `
        <div class="visual-reference-placeholder">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span class="visual-reference-placeholder-text">${placeholders[type]}</span>
        </div>
    `;
    preview.classList.remove('has-image');
    btnRemove.disabled = true;
}

// ============================================
// SISTEMA DE DESCARGA DE REFERENCIAS (FIX BLOB)
// ============================================

function downloadReference(type, categoryName) {
    // 1. Buscar el script y la categoría actuales
    if (currentViewIndex < 0 || !filteredScripts[currentViewIndex]) return;
    
    const script = filteredScripts[currentViewIndex];
    const category = categories.find(cat => cat.name === script.category) || {};

    // 2. Resolver cuál Blob usar (Prioridad: Guion > Categoría)
    // Nota: Esto replica la lógica de prioridad visual para asegurar que descargamos lo que vemos
    const scriptRefs = script.customVisuals || {};
    const categoryRefs = category.visualReferences || {};
    
    const blobToDownload = scriptRefs[type] || categoryRefs[type];

    if (!blobToDownload) {
        alert("No se encontró el archivo de referencia.");
        return;
    }

    // 3. Crear URL temporal y forzar descarga
    try {
        // Si por alguna razón es un string (legacy), intentamos convertirlo o lo usamos directo
        let url;
        let isBlob = false;

        if (blobToDownload instanceof Blob || blobToDownload instanceof File) {
            url = URL.createObjectURL(blobToDownload);
            isBlob = true;
        } else {
            // Soporte fallback para Base64 antiguos no migrados
            url = blobToDownload; 
        }

        const a = document.createElement('a');
        a.href = url;
        
        // Determinar extensión basada en el tipo MIME del Blob
        let ext = 'png';
        if (isBlob && blobToDownload.type) {
            const mime = blobToDownload.type.split('/')[1];
            if (mime) ext = mime.replace('jpeg', 'jpg');
        }

        // Nombre de archivo limpio
        const cleanCatName = categoryName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        a.download = `${cleanCatName}_ref_${type}.${ext}`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // 4. Limpieza de memoria
        if (isBlob) {
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

    } catch (e) {
        console.error("Error en descarga:", e);
        alert("Error al procesar la descarga del archivo.");
    }
}

// DESPUÉS (Código nuevo y mejorado)
// ============================================
// VISUALIZACIÓN DE REFERENCIAS (FIX RENDER)
// ============================================

function loadReferencesInPromptsModule() {
    if (currentViewIndex < 0 || !filteredScripts[currentViewIndex]) {
        return;
    }
    
    const script = filteredScripts[currentViewIndex];
    const category = categories.find(cat => cat.name === script.category) || {};

    // Lógica de prioridad: Custom Visuals > Category Visuals
    const categoryRefs = category.visualReferences || {};
    const scriptRefs = script.customVisuals || {};

    const finalRefs = {
        asunto: scriptRefs.asunto || categoryRefs.asunto || null,
        escena: scriptRefs.escena || categoryRefs.escena || null,
        estilo: scriptRefs.estilo || categoryRefs.estilo || null,
    };

    const hasAnyReference = Object.values(finalRefs).some(ref => ref !== null);
    const panel = document.getElementById('promptsReferencesPanel');
    
    if (!hasAnyReference) {
        panel.style.display = 'none';
        return;
    }
    
    panel.style.display = 'block';
    
    const referencesHTML = ['asunto', 'escena', 'estilo']
        .filter(type => finalRefs[type])
        .map(type => {
            const labels = { asunto: 'Asunto', escena: 'Escena', estilo: 'Estilo' };
            const icons = {
                asunto: '<circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle>',
                escena: '<rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>',
                estilo: '<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>'
            };
            const accentColors = { asunto: '#8b5cf6', escena: '#3b82f6', estilo: '#10b981' };
            
            // Generar URL visual segura usando el Helper
            // getImageUrl debe manejar si es Blob o String
            const imgUrl = getImageUrl(finalRefs[type]);

            // CORRECCIÓN CLAVE: 
            // 1. Usamos onload en la imagen para liberar memoria si es un Blob URL
            // 2. En el onclick ya NO pasamos el archivo, solo el tipo. La función de descarga lo buscará en memoria.
            return `
                <div class="prompts-reference-item" style="border-left: 3px solid ${accentColors[type]};">
                    <div class="prompts-reference-image-container">
                        <img src="${imgUrl}" 
                             alt="Referencia ${type}"
                             onload="if(this.src.startsWith('blob:')) URL.revokeObjectURL(this.src)"> 
                    </div>
                    <button class="btn-download-reference-minimal" 
                            onclick="downloadReference('${type}', '${category.name.replace(/'/g, "\\'")}')"
                            style="background: ${accentColors[type]}15; color: ${accentColors[type]}; border-color: ${accentColors[type]}40;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[type]}</svg>
                        <span style="font-weight: 600;">${labels[type]}</span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                </div>
            `;
        })
        .join('');
    
    const grid = document.getElementById('promptsReferencesGrid');
    if (referencesHTML) {
        grid.innerHTML = referencesHTML;
    } else {
        grid.innerHTML = '<div class="prompts-references-empty">No hay referencias visuales.</div>';
    }
}

// ============================================
// FIN DEL MÓDULO DE REFERENCIAS VISUALES
// ============================================

// ============================================
// GESTIÓN DE EXPANSIÓN DE PROMPTS LARGOS
// ============================================

function togglePromptExpansion() {
    const contentEl = document.getElementById('promptsCurrentContent');
    const btn = document.getElementById('promptsReadMoreBtn');
    const btnText = document.getElementById('readMoreBtnText');
    
    contentEl.classList.toggle('expanded');
    btn.classList.toggle('expanded');
    
    if (contentEl.classList.contains('expanded')) {
        btnText.textContent = 'Mostrar Menos';
    } else {
        btnText.textContent = 'Leer Más';
        // Scroll suave al inicio del prompt
        contentEl.scrollTop = 0;
    }
}

function checkPromptHeight() {
    const contentEl = document.getElementById('promptsCurrentContent');
    const btn = document.getElementById('promptsReadMoreBtn');
    
    if (!contentEl || !btn) return;
    
    // Resetear estado antes de medir
    contentEl.classList.remove('expanded');
    btn.classList.remove('expanded', 'visible');
    document.getElementById('readMoreBtnText').textContent = 'Leer Más';
    
    // Forzar reflow para obtener medidas correctas
    contentEl.offsetHeight;
    
    // Verificar si el contenido excede la altura máxima
    const isOverflowing = contentEl.scrollHeight > contentEl.clientHeight + 20; // +20 de margen
    
    if (isOverflowing) {
        btn.classList.add('visible');
    } else {
        btn.classList.remove('visible');
    }
}

// ============================================
// FIN DE GESTIÓN DE EXPANSIÓN
// ============================================

// Initialize
initializeData();

// ============================================
// MÓDULO DE GENERACIÓN DE IMÁGENES/VIDEO
// ============================================

let promptsList = [];
let currentPromptIndex = 0;

function openPromptsGenerator() {
    resetPromptsGenerator();
    document.getElementById('promptsGeneratorModal').classList.add('active');
    loadReferencesInPromptsModule();
    document.getElementById('promptsPasteArea').focus();
}

function closePromptsGenerator() {
    document.getElementById('promptsGeneratorModal').classList.remove('active');
}

function resetPromptsGenerator() {
    promptsList = [];
    currentPromptIndex = 0;
    document.getElementById('promptsPasteArea').value = '';
    document.getElementById('promptsWaitingState').classList.add('active');
    document.getElementById('promptsActiveState').classList.remove('active');
    document.getElementById('promptsCompletedState').classList.remove('active');
}

function processPromptsFromTextArea() {
    const content = document.getElementById('promptsPasteArea').value;
    const btn = document.getElementById('promptsProcessBtn');
    const originalHTML = btn.innerHTML;

    if (!content || content.trim().length === 0) {
        alert('El área de texto está vacía. Pega los prompts antes de procesar.');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span>Procesando...</span>';

    // --- INICIO DE LA MEJORA INTELIGENTE ---
    // 1. Detección de formato: ¿Es una lista numerada?
    const isNumberedList = /^\s*\d+\.\s/m.test(content);
    
    if (isNumberedList) {
        console.log("Formato de lista numerada detectado.");
        // Lógica original para listas numeradas
        const cleanedContent = content.replace(/\*/g, '');
        const promptBlocks = cleanedContent.split(/(?=^\s*\d+\.\s)/m);
        promptsList = promptBlocks.map(b => b.trim()).filter(b => b && /^\s*\d+\.\s/.test(b));
    } else {
        console.log("Formato de párrafos detectado. Procesando por saltos de línea.");
        // 2. Nueva lógica para párrafos separados por saltos de línea
        // Divide por una o más líneas en blanco, limpia cada párrafo y filtra los vacíos.
        promptsList = content.split(/\n\s*\n+/)
            .map(p => p.trim())
            .filter(p => p.length > 0);
    }
    // --- FIN DE LA MEJORA INTELIGENTE ---

    if (promptsList.length === 0) {
        // Mensaje de error más genérico y útil
        alert('No se detectaron prompts válidos. Asegúrate de que sea una lista numerada (1., 2., ...) o párrafos separados por líneas en blanco.');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
    }

    currentPromptIndex = 0;
    copyPromptToClipboard(promptsList[0]);
    showCurrentPrompt();

    document.getElementById('promptsWaitingState').classList.remove('active');
    document.getElementById('promptsActiveState').classList.add('active');

    btn.disabled = false;
    btn.innerHTML = originalHTML;
}

// *** NUEVA FUNCIÓN ***
// Lee del portapapeles, lo pega en el textarea y procesa.
async function pasteAndProcessFromClipboard() {
    try {
        // Solicitar permiso y leer el portapapeles
        const clipboardText = await navigator.clipboard.readText();
        
        if (!clipboardText || clipboardText.trim().length === 0) {
            alert('El portapapeles está vacío.');
            return;
        }
        
        // Poner el texto en el textarea
        document.getElementById('promptsPasteArea').value = clipboardText;
        
        // Llamar a la función de procesamiento existente
        processPromptsFromTextArea();
        
    } catch (err) {
        console.error('Error al leer el portapapeles:', err);
        alert('No se pudo acceder al portapapeles. Asegúrate de haber concedido los permisos necesarios al navegador.');
    }
}

async function copyPromptToClipboard(promptText) {
    try {
        await navigator.clipboard.writeText(promptText);
    } catch (err) {
        console.error('Error al copiar automáticamente:', err);
    }
}

function showCurrentPrompt() {
    const prompt = promptsList[currentPromptIndex];
    // Limpiamos el prompt de números y asteriscos para mostrarlo limpio
    const match = prompt.match(/^\s*\d+\.\s*(.*)$/s);
    const displayText = match ? match[1].trim().replace(/\*/g, '') : prompt.trim().replace(/\*/g, '');

    document.getElementById('promptsCurrentContent').textContent = displayText;
    document.getElementById('promptsCurrentBadge').textContent = `Prompt ${currentPromptIndex + 1} de ${promptsList.length}`;

// --- NUEVA LÓGICA DEL LED DE COHERENCIA ---
    const led = document.getElementById('sceneCoherenceLed');
    const cycleLength = config.sceneCoherenceLength;

    // Si el ciclo es 0, la función está desactivada. El LED permanece apagado (gris).
    if (cycleLength <= 0) {
        led.className = 'scene-coherence-led';
        led.title = 'Ciclo de coherencia desactivado.';
    } else {
        // El índice dentro del ciclo actual (0 es el primero, 1 es el segundo, etc.)
        const indexInCycle = currentPromptIndex % cycleLength;

        if (indexInCycle === 0) {
            // Es el PRIMER prompt del ciclo: LED de CREACIÓN (Naranja)
            led.className = 'scene-coherence-led creation';
            led.title = `NUEVO CICLO: Crea una nueva escena base (${currentPromptIndex + 1}/${promptsList.length})`;
        } else {
            // Es un prompt DENTRO del ciclo: LED de COHERENCIA (Verde)
            led.className = 'scene-coherence-led coherence';
            led.title = `MANTENER COHERENCIA: Sigue el estilo de la escena anterior (${indexInCycle + 1}/${cycleLength})`;
        }
    }
    // --- FIN DE LA NUEVA LÓGICA ---

    setTimeout(checkPromptHeight, 50);

    const nextBtn = document.getElementById('promptsNextBtn');
    const nextBtnText = document.getElementById('promptsNextBtnText');
    if (currentPromptIndex === promptsList.length - 1) {
        nextBtnText.textContent = 'Finalizar';
        nextBtn.classList.add('finish');
    } else {
        nextBtnText.textContent = 'Siguiente Prompt';
        nextBtn.classList.remove('finish');
    }

    document.getElementById('promptsPrevBtn').disabled = currentPromptIndex === 0;

    const copyBtn = document.getElementById('promptsCopyBtn');
    copyBtn.classList.remove('copied');
    document.getElementById('promptsCopyBtnText').textContent = 'Copiar Prompt';
}

async function copyCurrentPrompt() {
    if (!promptsList[currentPromptIndex]) return;
    await copyPromptToClipboard(promptsList[currentPromptIndex]);
    const copyBtn = document.getElementById('promptsCopyBtn');
    copyBtn.classList.add('copied');
    document.getElementById('promptsCopyBtnText').textContent = '¡Copiado!';
}

async function nextPrompt() {
    if (currentPromptIndex < promptsList.length - 1) {
        currentPromptIndex++;
        await copyPromptToClipboard(promptsList[currentPromptIndex]);
        showCurrentPrompt();
    } else {
        showCompletedState();
    }
}

async function prevPrompt() {
    if (currentPromptIndex > 0) {
        currentPromptIndex--;
        await copyPromptToClipboard(promptsList[currentPromptIndex]);
        showCurrentPrompt();
    }
}

function showCompletedState() {
    document.getElementById('promptsActiveState').classList.remove('active');
    document.getElementById('promptsCompletedState').classList.add('active');
}

// ============================================
// GESTIÓN DE EXPANSIÓN DE PROMPTS LARGOS
// ============================================

function togglePromptExpansion() {
    const contentEl = document.getElementById('promptsCurrentContent');
    const btn = document.getElementById('promptsReadMoreBtn');
    contentEl.classList.toggle('expanded');
    btn.classList.toggle('expanded');
    btn.querySelector('span').textContent = contentEl.classList.contains('expanded') ? 'Mostrar Menos' : 'Leer Más';
    if (!contentEl.classList.contains('expanded')) contentEl.scrollTop = 0;
}

function checkPromptHeight() {
    const contentEl = document.getElementById('promptsCurrentContent');
    const btn = document.getElementById('promptsReadMoreBtn');
    if (!contentEl || !btn) return;
    
    contentEl.classList.remove('expanded');
    btn.classList.remove('expanded', 'visible');
    btn.querySelector('span').textContent = 'Leer Más';

    const isOverflowing = contentEl.scrollHeight > contentEl.clientHeight;
    if (isOverflowing) {
        btn.classList.add('visible');
    }
}

function selectCategoryType(selectedButton, containerId) {
    const container = document.getElementById(containerId);
    container.querySelectorAll('.filter-option').forEach(btn => btn.classList.remove('active'));
    selectedButton.classList.add('active');
}
// === INICIO CÓDIGO NUEVO: Lógica del editor de referencias personalizadas ===

function loadCustomVisualsEditor(customRefs, categoryRefs) {
    customRefs = customRefs || {};
    categoryRefs = categoryRefs || {};
    
    // Inicializar estado temporal
    tempCustomVisuals = {
        asunto: customRefs.asunto || null,
        escena: customRefs.escena || null,
        estilo: customRefs.estilo || null,
    };

    ['asunto', 'escena', 'estilo'].forEach(type => {
        // IDs con mayúscula inicial para coincidir con el DOM (ej: editScriptPreviewAsunto)
        const typeCap = type.charAt(0).toUpperCase() + type.slice(1);
        const previewEl = document.getElementById(`editScriptPreview${typeCap}`);
        const btnRemoveEl = document.getElementById(`editScriptBtnRemove${typeCap}`);
        const inputEl = document.getElementById(`editScriptInput${typeCap}`);

        // Limpiar input de archivo para permitir subir la misma imagen de nuevo si se desea
        if (inputEl) inputEl.value = '';
        
        // Lógica de visualización
        let blobToRender = null;
        let isFallback = false;

        // Prioridad 1: Referencia personalizada del guion
        if (tempCustomVisuals[type]) {
            blobToRender = tempCustomVisuals[type];
            isFallback = false;
        } 
        // Prioridad 2: Referencia heredada de la categoría
        else if (categoryRefs[type]) {
            blobToRender = categoryRefs[type];
            isFallback = true;
        }

        // Renderizado
        if (blobToRender) {
            // Generar URL temporal segura para el Blob
            const thumbUrl = getImageUrl(blobToRender);
            
            previewEl.innerHTML = `<img src="${thumbUrl}" alt="Ref ${type}" onload="if(this.src.startsWith('blob:')) URL.revokeObjectURL(this.src)">`;
            
            if (isFallback) {
                previewEl.classList.add('fallback-preview');
                // Si es fallback, no podemos "quitarla" desde el guion (solo sobrescribirla)
                if (btnRemoveEl) btnRemoveEl.disabled = true; 
            } else {
                previewEl.classList.remove('fallback-preview');
                if (btnRemoveEl) btnRemoveEl.disabled = false;
            }
            previewEl.classList.add('has-image');
        } 
        // Prioridad 3: Placeholder vacío
        else {
            previewEl.innerHTML = `
                <div class="visual-reference-placeholder">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    <span class="visual-reference-placeholder-text">Sin referencia</span>
                </div>`;
            previewEl.classList.remove('fallback-preview');
            previewEl.classList.remove('has-image');
            if (btnRemoveEl) btnRemoveEl.disabled = true;
        }
    });
}

function handleCustomReferenceUpload(type, event) {
    handleReferenceUploadGeneric(type, event, tempCustomVisuals);
}

function removeCustomReference(type) {
    if (confirm(`¿Quitar la referencia personalizada para "${type}"? Se usará la de la categoría si existe.`)) {
        tempCustomVisuals[type] = null;
        
        // Volver a cargar el editor para que muestre el fallback de la categoría o el placeholder
        const scriptId = parseInt(document.getElementById('editScriptId').value);
        const script = scripts.find(s => s.id === scriptId);
        const category = categories.find(cat => cat.name === script.category) || {};
        
        // Creamos un objeto `customRefs` actualizado para la recarga
        const updatedCustomRefs = { ...script.customVisuals };
        delete updatedCustomRefs[type]; // Eliminamos la clave para que la función sepa que ya no existe

        loadCustomVisualsEditor(updatedCustomRefs, category.visualReferences);
    }
}

// === FIN CÓDIGO NUEVO ===
    </script>
</body>
</html>
